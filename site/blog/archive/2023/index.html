
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="关于软件、Geek | Ray，Web & Mobile Lover，Software Engineer | 这里是 @Ray睿 类喵星人的个人博客。专注求索，创新">
      
      
        <meta name="author" content="Ray-X">
      
      
        <link rel="canonical" href="https://rayx.me/blog/archive/2023/">
      
      
        <link rel="prev" href="../2024/">
      
      
        <link rel="next" href="../2022/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.13">
    
    
      
        <title>2023 - Ray-X</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e359304.min.css">
      
      


  
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
  
  <style>.md-tag.md-tag--css{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M1.5 0h21l-1.91 21.563L11.977 24l-8.565-2.438L1.5 0zm17.09 4.413L5.41 4.41l.213 2.622 10.125.002-.255 2.716h-6.64l.24 2.573h6.182l-.366 3.523-2.91.804-2.956-.81-.188-2.11h-2.61l.29 3.855L12 19.288l5.373-1.53L18.59 4.414z"/></svg>');}.md-tag.md-tag--html{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M1.5 0h21l-1.91 21.563L11.977 24l-8.564-2.438L1.5 0zm7.031 9.75-.232-2.718 10.059.003.23-2.622L5.412 4.41l.698 8.01h9.126l-.326 3.426-2.91.804-2.955-.81-.188-2.11H6.248l.33 4.171L12 19.351l5.379-1.443.744-8.157H8.531z"/></svg>');}.md-tag.md-tag--js{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0zm22.034 18.276c-.175-1.095-.888-2.015-3.003-2.873-.736-.345-1.554-.585-1.797-1.14-.091-.33-.105-.51-.046-.705.15-.646.915-.84 1.515-.66.39.12.75.42.976.9 1.034-.676 1.034-.676 1.755-1.125-.27-.42-.404-.601-.586-.78-.63-.705-1.469-1.065-2.834-1.034l-.705.089c-.676.165-1.32.525-1.71 1.005-1.14 1.291-.811 3.541.569 4.471 1.365 1.02 3.361 1.244 3.616 2.205.24 1.17-.87 1.545-1.966 1.41-.811-.18-1.26-.586-1.755-1.336l-1.83 1.051c.21.48.45.689.81 1.109 1.74 1.756 6.09 1.666 6.871-1.004.029-.09.24-.705.074-1.65l.046.067zm-8.983-7.245h-2.248c0 1.938-.009 3.864-.009 5.805 0 1.232.063 2.363-.138 2.711-.33.689-1.18.601-1.566.48-.396-.196-.597-.466-.83-.855-.063-.105-.11-.196-.127-.196l-1.825 1.125c.305.63.75 1.172 1.324 1.517.855.51 2.004.675 3.207.405.783-.226 1.458-.691 1.811-1.411.51-.93.402-2.07.397-3.346.012-2.054 0-4.109 0-6.179l.004-.056z"/></svg>');}.md-tag.md-tag--python{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.25.18.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"/></svg>');}</style>

    
    
      
    
    
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2023" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Ray-X" class="md-header__button md-logo" aria-label="Ray-X" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ray-X
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2023
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ray-x" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ray-x
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Ray-X" class="md-nav__button md-logo" aria-label="Ray-X" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5Z"/></svg>

    </a>
    Ray-X
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ray-x" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ray-x
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Whats new
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    latest
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            latest
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2023/12/20/asyncio-python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    asyncio python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2023/12/19/python-django-restful-framework/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python Django Restful Framework
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2023">2023<a class="headerlink" href="#2023" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-12-20 00:00:00">December 20, 2023</time>
          <!-- start customization -->
          
          <!-- end customization --></li>
        
        
          
          <li class="md-meta__item">
            
              7 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="asyncio-python"><a class="toclink" href="../../2023/12/20/asyncio-python/">asyncio python</a></h2>
<ul>
<li>History</li>
<li>greenlet</li>
<li>yield</li>
<li>python3.4 asyncio<ul>
<li><code>yield from asyncio.sleep(1)</code> <code>yield</code> allow switch to other coroutines if blocked on IO</li>
</ul>
</li>
<li>
<p>python3.5 (async, await), 3.7(run)</p>
<ul>
<li>await, async</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello ...&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... World!&#39;</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
  - python 3.7 Task
  - python 3.11 TaskGroup
- Asynchronous Programming
  - event loop</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">([</span><span class="n">task1</span><span class="p">,</span> <span class="n">task2</span><span class="p">])</span>
</code></pre></div>
  - Basic of coroutines
  - <img alt="A diagram showing the difference between subroutine and coroutine calling" src="https://bbc.github.io/cloudfit-public-docs/images/asyncio/SubVsCoRoutines.png" />{:height
181, :width 346}
  - async
- coroutine function and coroutine object</p>
<p><div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">cotask</span><span class="p">():</span>  <span class="c1"># a coroutine task</span>
  <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">cotask</span><span class="p">()</span>      <span class="c1"># a coroutine object</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">cotask</span><span class="p">())</span>  <span class="c1"># run the task</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cotask</span><span class="p">())</span>  <span class="c1"># python 3.7</span>
</code></pre></div>
  - await
- If Python encounters an <code>await f()</code> expression in the scope of <code>g()</code>, <code>await</code> tells the event loop, “Suspend
  execution of <code>g()</code> until whatever I’m waiting on —the result of <code>f()</code> —is returned. In the meantime, go let
  something else run.&rdquo;
- Waitable objects can be:
  - coroutine object
  - ((6512ae22-02c0-42c1-bb30-97094aae783d))
  - Task object
- Two coroutines depends on each other</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">others</span><span class="p">()</span>
  <span class="k">await</span> <span class="k">async</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">others1</span><span class="p">()</span>
  <span class="k">await</span> <span class="k">async</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">dep_others</span><span class="p">():</span>
  <span class="k">await</span> <span class="n">others</span><span class="p">()</span>
  <span class="k">await</span> <span class="n">other1</span><span class="p">()</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dep_others</span><span class="p">())</span>
</code></pre></div>
  - Future
- Future is an <a href="https://docs.python.org/3/glossary.html#term-awaitable">awaitable</a> object. Coroutines can await on
  Future objects until they either have a result or an exception set, or until they are cancelled. A Future can be
  awaited multiple times and the result is same.
- Typically Futures are used to enable low-level callback-based code (e.g. in protocols implemented using
  asyncio <a href="https://docs.python.org/3/library/asyncio-protocol.html#asyncio-transports-protocols">transports</a>) to
  interoperate with high-level async/await code.
- example</p>
<p><div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span> <span class="c1"># current evloop</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>  <span class="c1"># an empty future object/task</span>
    <span class="k">await</span> <span class="n">future</span> <span class="c1"># wait until future object/task finished in this case it will wait for ever</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
- Set a future</p>
<p><div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">set_future</span><span class="p">(</span><span class="n">future</span><span class="p">):</span>
  <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="s2">&quot;666&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span> <span class="c1"># current evloop</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>  <span class="c1"># an empty future object/task</span>
    <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">set_future</span><span class="p">(</span><span class="n">future</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span> <span class="c1"># wait until future object/task finished in this case it will wait for ever</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># 666</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
- concurrent.futures
  - The <code>concurrent.futures</code> module is part of the Python standard library starting from Python 3.2. It provides a
    high-level interface for asynchronously executing callable objects using threads or processes. It builds upon
    the concepts of threading and multiprocessing but offers a simpler, more abstracted interface.
    ThreadPoolExecutor example</p>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">python</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>

<span class="c1"># Define a simple function to be executed</span>
<span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">**</span> <span class="mi">2</span>

<span class="c1"># Create a ThreadPoolExecutor with maximum 2 worker threads</span>
<span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="c1"># Submit tasks to the executor</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

    <span class="c1"># Retrieve results as they become available</span>
    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="c1"># Create a ProcessPoolExecutor with maximum 2 worker processes</span>
<span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="c1"># Submit tasks to the executor</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

    <span class="c1"># Retrieve results as they become available</span>
    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="err">```</span>
</code></pre></div>

<ul>
<li>
<p>asyncio object are not thread safe and it should not use together with multithread object. Here is a hack to
    convert a concurrent future to a asyncio feature</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>  <span class="c1"># doesnt support asyncio feature</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">feautre</span><span class="o">=</span><span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">rul_list</span><span class="p">]</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
</code></pre></div>
reference:
<a href="https://docs.python.org/3/library/asyncio-eventloop.html#id14">Executing code in thread or process pools</a>
      - <code>run_in_executor</code>
- if a io request does not support asyncio API. It can be wrapped with <code>run_in_executor</code>
- Above create a task The <em>executor</em> argument should be
  an <a href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">concurrent.futures.Executor</a> instance.
  The default executor is used if <em>executor</em> is None.
      -
  - Tasks
    - Syntax</p>
</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>
- Tasks are used to run/schedule coroutines in event loops. If a coroutine awaits on a
  ((6512ae22-02c0-42c1-bb30-97094aae783d)) , the Task suspends the execution of the coroutine and waits for the
  completion of the Future. When the Future is /done/, the execution of the wrapped coroutine resumes.
- If a coroutine awaits on a Future, the Task suspends the execution of the coroutine and waits for the completion
  of the Future. When the Future is <em>done</em>, the execution of the wrapped coroutine resumes.
- Event loops use cooperative scheduling: an event loop runs one Task at a time. While a Task awaits for the
  completion of a Future, the event loop runs other Tasks, callbacks, or performs IO operations.
- Use the high-level [[<a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.create_task">https://docs.python.org/3/library/asyncio-task.html#asyncio.create_task</a>][]] function to
  create Tasks, or the
  low-level [[<a href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.create_task">https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.create_task</a>][]] or [[<a href="https://docs.python.org/3/library/asyncio-future.html#asyncio.ensure_future">https://docs.python.org/3/library/asyncio-future.html#asyncio.ensure_future</a>][]] functions.
  Manual instantiation of Tasks is discouraged. <code>create_task</code> is equal to create+scheduleToRun. You do not need to
  kickoff the task
- The method <code>create_task</code> takes a coroutine object as a parameter and returns a <code>Task</code> object, which inherits from
  <code>asyncio.Future</code>. The call creates the task inside the event loop for the current thread, and starts the task
  executing at the beginning of the coroutine’s code-block. The returned future will be marked as <code>done()</code> only when
  the task has finished execution. As you might expect the return value of the coroutine’s code block is the
  <code>result()</code> which will be stored in the future object when it is finished (and if it raises then the exception will
  be caught and stored in the future).
- Example:</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">counter</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">i</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">counter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)))</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">done</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">await</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#another way to wait</span>
    <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1"># and you can also try this</span>
  <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">([</span><span class="n">counter</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="n">counter</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)]))</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
- Video resource
  {{video(<a href="https://www.bilibili.com/video/BV1NA411g7yf?p=7&amp;vd_source=3beef1bd86c86cf14f277319e599dab9">https://www.bilibili.com/video/BV1NA411g7yf?p=7&amp;vd_source=3beef1bd86c86cf14f277319e599dab9</a>)}}
  - Async Queue
  - Asynchronous Iterators
- ((65137d16-a06a-40e4-b28e-5fa4474017d5))
- Sample</p>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Ticker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yield numbers from 0 to `to` every `delay` seconds.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">to</span>

    <span class="k">def</span> <span class="fm">__aiter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__anext__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopAsyncIteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">ticker</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yield numbers from 0 to `to` every `delay` seconds.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">to</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">i</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
</code></pre></div>
  - Asynchronous contex manager
- async ctx mgr provide a context manager that can be suspended when entering and exiting. This is achieved by using
  <code>async with</code>. It is same way as <code>with</code> been used in other python expressions (e.g. file open)
- How to use</p>
<p><div class="highlight"><pre><span></span><code><span class="c1"># create and use an asynchronous context manager</span>
<span class="k">async</span> <span class="k">with</span> <span class="n">AsyncContextManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span>
    <span class="o">...</span>
<span class="c1"># Same as:</span>
<span class="c1"># create or enter the async context manager</span>
<span class="n">manager</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AsyncContextManager</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
  <span class="c1"># ...</span>
<span class="k">finally</span><span class="p">:</span>
  <span class="c1"># close or exit the context manager</span>
  <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
- It must be used inside a coroutine <code>async def</code>
  - uvloop
- uvloop <a href="https://github.com/magicstack/uvloop">GitHub - MagicStack/uvloop: Ultra fast asyncio event loop.</a> is 2~3
  times faster than asyncio
- Using uvloop</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">uvloop</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Main entry-point.</span>
    <span class="o">...</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Runner</span><span class="p">(</span><span class="n">loop_factory</span><span class="o">=</span><span class="n">uvloop</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">)</span> <span class="k">as</span> <span class="n">runner</span><span class="p">:</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">uvloop</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
- It used by asgi uvicorn
  - Practical examples
- redis</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">redis.asyncio</span> <span class="k">as</span> <span class="nn">redis</span>

<span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="s2">&quot;redis://localhost&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">with</span> <span class="n">r</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">pipe</span><span class="p">:</span>
    <span class="n">ok1</span><span class="p">,</span> <span class="n">ok2</span> <span class="o">=</span> <span class="k">await</span> <span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;key1&quot;</span><span class="p">,</span> <span class="s2">&quot;value1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;key2&quot;</span><span class="p">,</span> <span class="s2">&quot;value2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>
<span class="k">assert</span> <span class="n">ok1</span>
<span class="k">assert</span> <span class="n">ok2</span>

<span class="c1"># pubsub</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">redis.asyncio</span> <span class="k">as</span> <span class="nn">redis</span>
<span class="n">STOPWORD</span> <span class="o">=</span> <span class="s2">&quot;STOP&quot;</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="n">channel</span><span class="p">:</span> <span class="n">redis</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">PubSub</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_message</span><span class="p">(</span><span class="n">ignore_subscribe_messages</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(Reader) Message Received: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">==</span> <span class="n">STOPWORD</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(Reader) STOP&quot;</span><span class="p">)</span>
                <span class="k">break</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="s2">&quot;redis://localhost&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">with</span> <span class="n">r</span><span class="o">.</span><span class="n">pubsub</span><span class="p">()</span> <span class="k">as</span> <span class="n">pubsub</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">pubsub</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&quot;channel:1&quot;</span><span class="p">,</span> <span class="s2">&quot;channel:2&quot;</span><span class="p">)</span>

    <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">reader</span><span class="p">(</span><span class="n">pubsub</span><span class="p">))</span>

    <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;channel:1&quot;</span><span class="p">,</span> <span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;channel:2&quot;</span><span class="p">,</span> <span class="s2">&quot;World&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;channel:1&quot;</span><span class="p">,</span> <span class="n">STOPWORD</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">future</span>

<span class="kn">import</span> <span class="nn">asyncio_redis</span>
<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="c1"># Create Redis connection</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">asyncio_redis</span><span class="o">.</span><span class="n">Connection</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>
    <span class="c1"># Set a key</span>
    <span class="k">yield from</span> <span class="n">connection</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;my_key&#39;</span><span class="p">,</span> <span class="s1">&#39;my_value&#39;</span><span class="p">)</span>
    <span class="c1"># When finished, close the connection.</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">example</span><span class="p">())</span>
</code></pre></div>
- Mysql with aiomysql</p>
<h3 id="import-asyncio-import-sqlalchemy-as-sa-from-aiomysqlsa-import-create_engine-metadata-sametadata-tbl-satabletbl-metadata-sacolumnid-sainteger-primary_keytrue-sacolumnval-sastring255-async-def-goloop-engine-await-create_engineuserroot-dbtest_pymysql-host127001-password-looploop-async-with-engineacquire-as-conn-await-connexecutetblinsertvaluesvalabc-await-connexecutetblinsertvaluesvalxyz-async-for-row-in-connexecutetblselect-printrowid-rowval-engineclose-await-enginewait_closed-loop-asyncioget_event_loop-looprun_until_completegoloop"><a class="toclink" href="../../2023/12/20/asyncio-python/#import-asyncio-import-sqlalchemy-as-sa-from-aiomysqlsa-import-create_engine-metadata-sametadata-tbl-satabletbl-metadata-sacolumnid-sainteger-primary_keytrue-sacolumnval-sastring255-async-def-goloop-engine-await-create_engineuserroot-dbtest_pymysql-host127001-password-looploop-async-with-engineacquire-as-conn-await-connexecutetblinsertvaluesvalabc-await-connexecutetblinsertvaluesvalxyz-async-for-row-in-connexecutetblselect-printrowid-rowval-engineclose-await-enginewait_closed-loop-asyncioget_event_loop-looprun_until_completegoloop"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">aiomysql.sa</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
<span class="n">tbl</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;tbl&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
               <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
               <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">go</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s1">&#39;test_pymysql&#39;</span><span class="p">,</span>
                                 <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39;abc&#39;</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39;xyz&#39;</span><span class="p">))</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">select</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>

    <span class="n">engine</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">engine</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">go</span><span class="p">(</span><span class="n">loop</span><span class="p">))</span>
</code></pre></div></a></h3>
<h3 id="-"><a class="toclink" href="../../2023/12/20/asyncio-python/#-">-</a></h3>
<h3 id="-_1"><a class="toclink" href="../../2023/12/20/asyncio-python/#-_1">-</a></h3>
<p>-
- References
  - <a href="https://www.bilibili.com/video/BV11T4y117Jo">协程到底是咋回事？asyncio大佬给你彻底讲明白。</a>
  - <a href="https://bbc.github.io/cloudfit-public-docs/asyncio/asyncio-part-2.html">Python Asyncio Part 2 – Awaitables, Tasks, and Futures | cloudfit-public-docs</a>
  - <a href="https://bbc.github.io/cloudfit-public-docs/asyncio/asyncio-part-3">Python Asyncio Part 3 – Asynchronous Context Managers and Asynchronous Iterators | cloudfit-public-docs</a>
  - <a href="https://realpython.com/async-io-python/">Async IO in Python: A Complete Walkthrough – Real Python</a>
-
-</p>
</li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/12/20/asyncio-python/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-12-19 00:00:00">December 19, 2023</time>
          <!-- start customization -->
          
          <!-- end customization --></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="docker-storage"><a class="toclink" href="../../2023/12/19/docker-storage/">Docker storage</a></h2>
<ul>
<li><a href="../assets/Python+Deep+Dive+2_1696586942514_0.pdf">Python+Deep+Dive+2.pdf</a></li>
<li>
<p>List Comprehension</p>
<ul>
<li>nested</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span><span class="o">%</span><span class="mi">3</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
<span class="p">[[</span><span class="n">i</span><span class="o">*</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="mi">5</span><span class="p">]</span>
</code></pre></div>
- Generator
- something that <code>yield</code> is a generator
- List comprehension build with <code>[]</code>, generator expression build with <code>()</code>
    - <code>(i**2 for i in range(5))</code>
    - <strong>Lazy</strong> evaluation and local scope . get value of <code>i**2</code> until <code>next</code>
- <code>yield</code> and <code>yield from</code> (python 3.3)
    - <code>yield</code> is used to produce a value from the generator and to suspend the function&rsquo;s state so that it can be resumed right from where it left off.
    - It essentially allows the function to return a value (like a regular function would with <code>return</code>) but remembers its state for future calls.</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  def simple_generator():</span>
<span class="n n-Quoted">      yield 1</span>
<span class="n n-Quoted">      yield 2</span>
<span class="n n-Quoted">      yield 3</span>

<span class="n n-Quoted">  gen = simple_generator()</span>

<span class="n n-Quoted">  print(next(gen))  # Output: 1</span>
<span class="n n-Quoted">  print(next(gen))  # Output: 2</span>
<span class="n n-Quoted">  print(next(gen))  # Output: 3</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`yield from`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">delegate</span><span class="w"> </span><span class="n">part</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">operations</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">another</span><span class="w"> </span><span class="n">generator</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">simplifies</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">code</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">generator</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">calling</span><span class="w"> </span><span class="n">another</span><span class="w"> </span><span class="n">generator</span><span class="w"> </span><span class="k">function</span><span class="p">.</span><span class="w"> </span><span class="n">It</span><span class="s1">&#39;s a way to yield all values from another iterable (often another generator) without using a loop.</span>
<span class="s1">- Example:</span>

<span class="s1">  ``` python</span>
<span class="s1">  def generator_without_yield_from():</span>
<span class="s1">      for item in simple_generator():</span>
<span class="s1">          yield item</span>

<span class="s1">  gen = generator_without_yield_from()</span>

<span class="s1">  print(next(gen))  # Output: 1</span>
<span class="s1">  print(next(gen))  # Output: 2</span>
<span class="s1">  print(next(gen))  # Output: 3</span>

<span class="s1">  # with yield from</span>
<span class="s1">  def generator_with_yield_from():</span>
<span class="s1">      yield from simple_generator()</span>

<span class="s1">  gen = generator_with_yield_from()</span>

<span class="s1">  print(next(gen))  # Output: 1</span>
<span class="s1">  print(next(gen))  # Output: 2</span>
<span class="s1">  print(next(gen))  # Output: 3</span>
<span class="s1">  ```</span>
<span class="s1">- User case</span>
<span class="s1">    - `yield`: When you&#39;</span><span class="n">re</span><span class="w"> </span><span class="n">producing</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">generator</span><span class="w"> </span><span class="k">function</span><span class="p">.</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`yield from`</span><span class="o">:</span><span class="w"> </span><span class="k">When</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">delegate</span><span class="w"> </span><span class="n">yielding</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">another</span><span class="w"> </span><span class="n">generator</span><span class="w"> </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="k">any</span><span class="w"> </span><span class="n">iterable</span><span class="p">)</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">generator</span><span class="w"> </span><span class="k">function</span><span class="p">.</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n n-Quoted">`yield from`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">useful</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n n-Quoted">`with open(filename) as f:`</span><span class="w"> </span><span class="k">context</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n n-Quoted">`yield from`</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n n-Quoted">`yield`</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n n-Quoted">`return`</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">lazy</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="n">inside</span><span class="w"> </span><span class="k">context</span>
</code></pre></div>

<ul>
<li>Set</li>
<li>operations<ul>
<li><code>|</code> : union, <code>set1|set2|set3</code></li>
<li><code>&amp;</code>: join <code>set1 &amp; set2 &amp; set3</code></li>
<li><code>-</code>: difference  <code>set1 - set2</code></li>
<li><code>^</code>: semmetric difference,  same as <code>(s1 | s2)  -( s1 &amp; s2 )</code></li>
<li><code>&lt;</code> and <code>&lt;=</code> <strong>containment</strong>,  <code>&gt;</code> and <code>&gt;=</code></li>
</ul>
</li>
<li>mutate a set<h3 id="-"><a class="toclink" href="../../2023/12/19/docker-storage/#-">- <code>|=</code>, <code>&amp;=</code>, <code>-=</code>, <code>^=</code></a></h3>
</li>
<li>
<h3 id="frozenset-is-a-const-set"><a class="toclink" href="../../2023/12/19/docker-storage/#frozenset-is-a-const-set">frozenset is a const set</a></h3>
</li>
</ul>
</li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/12/19/docker-storage/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-12-19 00:00:00">December 19, 2023</time>
          <!-- start customization -->
          
          <!-- end customization --></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="python-django-deployment"><a class="toclink" href="../../2023/12/19/python-django-deployment/">Python Django deployment</a></h2>
<ul>
<li>Normally there are following way to deploy python service<ul>
<li>ECS/EKS</li>
<li>EC2</li>
<li>EBS (elastic beanstalk)</li>
<li>Lambda</li>
</ul>
</li>
<li>WSGI<ul>
<li>WSGI is the Web Server Gateway Interface. It is a specification that describes how a web server communicates with web applications</li>
<li>why we need a gateway mediator<ul>
<li>flexiblity<ul>
<li>If you directly point your web server to your application, it reduces the flexibility** **of your application. Since your web server now directly points to your web application, you are unable to swap out web stack components.
<div class="highlight"><pre><span></span><code>:drawer:
              let’s say you’ve decided to deploy your application using Gunicorn, but several years later, you decide to switch from Gunicorn to mod_wsgi. In this situation, you could easily switch to mod_wsgi without making any changes in the application or framework because you used WSGI. WSGI provides flexibility to your application.

:END:
</code></pre></div></li>
</ul>
</li>
<li>scalability<ul>
<li>WSGI is capable of serving thousands of requests at a time. The WSGI server is responsible for handling the requests from the web server and making decisions for carrying out the communication of those requests to an application framework’s process. we can divide the responsibilities among the servers for scaling web traffic.</li>
</ul>
</li>
</ul>
</li>
<li><a href="https://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/gunicorn/">How to use Django with Gunicorn</a></li>
<li><a href="https://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/uwsgi/">How to use Django with uWSGI</a></li>
<li><a href="https://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/modwsgi/">How to use Django with Apache and mod</a></li>
<li><a href="https://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/apache-auth/">How to authenticate against Django’s user database from Apache</a></li>
</ul>
</li>
<li>ASGI<ul>
<li>ASGI (<em>Asynchronous Server Gateway Interface</em>)</li>
<li><a href="https://docs.djangoproject.com/en/4.2/howto/deployment/asgi/daphne/">How to use Django with Daphne</a></li>
<li><a href="https://docs.djangoproject.com/en/4.2/howto/deployment/asgi/hypercorn/">How to use Django with Hypercorn</a></li>
<li>
<h3 id="how-to-use-django-with-uvicorn"><a class="toclink" href="../../2023/12/19/python-django-deployment/#how-to-use-django-with-uvicorn"><a href="https://docs.djangoproject.com/en/4.2/howto/deployment/asgi/uvicorn/">How to use Django with Uvicorn</a></a></h3>
</li>
</ul>
</li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/12/19/python-django-deployment/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-12-19 00:00:00">December 19, 2023</time>
          <!-- start customization -->
          
          <!-- end customization --></li>
        
        
          
          <li class="md-meta__item">
            
              12 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="python-django-restful-framework"><a class="toclink" href="../../2023/12/19/python-django-restful-framework/">Python Django Restful Framework</a></h2>
<ul>
<li>Django Restful Framework Videos
  url:: <a href="https://www.bilibili.com/video/BV1xj411C7ws">drf实战和源码剖析</a>
  channel:: <a href="https://space.bilibili.com/336469068">https://space.bilibili.com/336469068</a>
  tags:: rest, DRF, python, django, web, API
  date:: [[Sep 25<sup>th</sup>, 2023]]
  tutor:: 武沛齐</li>
<li>Resources
  heading:: 2<ul>
<li><a href="https://www.bilibili.com/video/BV1Sc41157hr">银角大王-武沛齐Django-Drf框架与django3项目搭建案例全套教学 完整版</a></li>
<li><a href="https://www.bilibili.com/video/BV1pA41117U4">银角大王-武沛齐Django-Drf框架与vue项目搭建案例全套教学  完整版</a></li>
<li><a href="https://www.bilibili.com/video/BV1XR4y157rk">全站最牛逼的DRF（Django-restframework），没有之一！</a></li>
<li><a href="https://www.bilibili.com/video/BV1Cv4y1R77V">【独家专授】我要安利给所有人DRF（Django-rest-framework）与源码解析自学教程全程无广安心食用！！！</a></li>
<li><a href="https://www.bilibili.com/video/BV1Sz4y1o7E8">黑马 Django REST Framework框架经典教程</a></li>
</ul>
</li>
<li>
<p>Jump start
  heading:: 2</p>
<ul>
<li>install
  heading:: 3<ul>
<li><a href="https://www.django-rest-framework.org/#installation">Home - Django REST framework  install</a></li>
</ul>
</li>
<li>
<p>usage
  heading:: 3</p>
<ul>
<li><a href="https://www.django-rest-framework.org/tutorial/quickstart">Quickstart - Django REST framework</a></li>
<li>settings:</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">...</span>
    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>
- response</p>
<p><div class="highlight"><pre><span></span><code><span class="c1"># views.py</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">api_view</span>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">reqeust</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;sucessfull&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">})</span>

<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;sucessfull&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">})</span>
<span class="c1"># urls.py</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">LoginView</span><span class="o">.</span><span class="n">as_view</span><span class="p">())</span>
  <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login2/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">login</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div>
    - minium django setup
      heading:: 3</p>
</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="s1">&#39;api.apps.ApiConfig&#39;</span><span class="p">,</span> <span class="c1"># this include app : api</span>
    <span class="s1">&#39;rest_framework&#39;</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.middleware.security.SecurityMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s1">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;APP_DIRS&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;context_processors&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;django.template.context_processors.debug&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.template.context_processors.request&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;UNAUTHENTICATED_USER&quot;</span><span class="p">:</span> <span class="kc">None</span>   <span class="c1"># disable user-content reference</span>
<span class="p">}</span>
</code></pre></div>
- ((651210f8-a2fe-4194-9216-f1eefdded8a6))
  heading:: 2
- APIView
  heading:: 2
  desc:: REST framework provides an <sub>APIView</sub> class, which subclasses Django&rsquo;s <sub>View</sub> class.
- APIView &lt;- django.views.View and it implemented <code>as_view()</code>
    - APIView has <code>csrf_exempt</code>. It implemented <code>as_view</code> and <code>dispatch</code>
    - Requests passed to the handler methods will be REST framework&rsquo;s <code>Request</code> instances, not Django&rsquo;s <code>HttpRequest</code> instances.
    - Handler methods may return REST framework&rsquo;s <code>Response</code>, instead of Django&rsquo;s <code>HttpResponse</code>  The view will manage content negotiation and setting the correct renderer on the response.
    - Any <code>APIException</code> exceptions will be caught and mediated into appropriate responses.
    - Incoming requests will be authenticated and appropriate permission and/or throttle checks will be run before dispatching the request to the handler method.
    -
- Requests
  heading:: 2
  desc:: REST framework&rsquo;s <sub>Request</sub> class extends the standard <sub>HttpRequest</sub>,  adding support for REST framework&rsquo;s flexible request parsing and request authentication.
- <a href="https://www.django-rest-framework.org/api-guide/requests/">Requests - Django REST framework</a>
  heading:: 3
- DRF extend django HttpRequests by adding
  heading:: 3
    - <code>data</code>: use <code>request.data.get('fieldname')</code> to get data from a POST request
    - <code>query_params</code>  handle URL like <code>/users/?id=12</code>
    - Authentication
    - Browser enhancement
    - extends HttpRequest
        - META
        - session
        - version
            - request.version
            - request.versioning_{ schema}
        - parser
        - negotiator
    -
- Authentication
  heading:: 2
  desc:: Auhentication is the mechanism of associating an incoming request with a set of identifying credentials, such as the user the request came from, or the token that it was signed with. The <a href="https://www.django-rest-framework.org/api-guide/permissions/">permission</a> and <a href="https://www.django-rest-framework.org/api-guide/throttling/">throttling</a> policies can then use those credentials to determine if the request should be permitted.
  id:: 65136fb1-b3fd-40b2-b22b-d8ea5e0908b9
- Create a new Authentiation class
  heading:: 3
- SimpleAuth
  heading:: 3
  <div class="highlight"><pre><span></span><code><span class="c1"># auth.py</span>
<span class="k">class</span> <span class="nc">SimpleAuth</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
      <span class="k">return</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="n">token</span> <span class="c1">#return user and token</span>
      <span class="k">raise</span> <span class="n">AuthenticationFailed</span><span class="p">(</span><span class="s1">&#39;token missing&#39;</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;xxx app&quot;</span> <span class="c1"># return when you need something put in header when failed</span>
<span class="c1"># view.py</span>
<span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
  <span class="n">authentication_class</span> <span class="o">=</span> <span class="p">[</span><span class="n">SimpleAuth</span><span class="p">]</span>  <span class="c1"># Auth is required</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span> <span class="c1"># prints &#39;admin&#39;,  token</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({})</span>
</code></pre></div>
- Apply Authentication Globally
  heading:: 3
    - in Settings.py</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  REST_FRAMEWORK= {</span>
<span class="n n-Quoted">  &quot;DEFAULT_AUTHENTICATION_CLASS&quot;: [&quot;api.view.SimpleAuth&quot;,] # use string to avoid imporiting packages</span>
<span class="n n-Quoted">  }</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="n">Override</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="k">First</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">Auth</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">set</span><span class="n">ting</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="n n-Quoted">`authentication_class`</span><span class="p">.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">2nd</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="k">set</span><span class="n">ting</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n n-Quoted">`None`</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="mi">2</span><span class="o">^</span><span class="err">{</span><span class="w"> </span><span class="n">nd</span><span class="err">}</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n n-Quoted">`[]`</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">disable</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="k">set</span><span class="n">ting</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">disable</span><span class="w"> </span><span class="n">Auth</span>
</code></pre></div>

<ul>
<li>
<p>Multi Authenticators
  heading:: 4</p>
<ul>
<li>If <code>authenticate()</code> returns <code>None</code> when failed, DRF will go to next Authenticator until the return value is not None.</li>
<li>If all returns None. then <code>self.auth == None</code></li>
<li>If you want to prevent <code>None</code> go through, put an authenticator that will raise fail at end of list</li>
<li>Verify token in Authentication middleware</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">QueryTokenAuth</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>   <span class="c1"># api:  GET order/?orderid=12&amp;token=3322-333-111-111-3233</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span>
      <span class="k">return</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span>   <span class="c1"># request.user = user, request.token=token</span>
    <span class="k">raise</span> <span class="n">AuthenticationFailed</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">401</span><span class="p">})</span>
  <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;query failure&quot;</span>

<span class="k">class</span> <span class="nc">HeaderTokenAuth</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HTTP_AUTHORIZATION&quot;</span><span class="p">)</span>   <span class="c1"># api:  GET order/?orderid=12&amp;token=3322-333-111-111-3233</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span>
      <span class="k">return</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span>   <span class="c1"># request.user = user, request.token=token</span>
    <span class="k">raise</span> <span class="n">AuthenticationFailed</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">401</span><span class="p">})</span>
  <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;nead failure&quot;</span>
</code></pre></div>
- Auth success when <code>any()</code> of authenticator return <code>user, auth</code>
    - Login, Register and token issuing
      heading:: 3
- <a href="https://medium.com/django-rest/django-rest-framework-login-and-register-user-fd91cf6029d5">Login and Register User — Django Rest Framework | by Emre Cevik | Python | Django &amp; Rest | Medium</a>
- Login url</p>
<p><div class="highlight"><pre><span></span><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login/&#39;</span><span class="p">,</span> <span class="n">MyObtainTokenPairView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;token_obtain_pair&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login/refresh/&#39;</span><span class="p">,</span> <span class="n">TokenRefreshView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;token_refresh&#39;</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>
- Simple login with user/password</p>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
  <span class="n">authentication_classes</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
      <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
      <span class="n">pwd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
      <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">pwd</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">1002</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s2">&quot;user/pass failed&quot;</span><span class="p">})</span>
      <span class="n">token</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
      <span class="n">user</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
      <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="o">=</span> <span class="n">token</span><span class="p">})</span>
</code></pre></div>
- Permission
  heading:: 2
  desc:: Together with <a href="https://www.django-rest-framework.org/api-guide/authentication/">authentication</a> and <a href="https://www.django-rest-framework.org/api-guide/throttling/">throttling</a>, permissions determine whether a request should be granted or denied access.
  url:: <a href="https://www.django-rest-framework.org/api-guide/permissions/">DRF: Permission</a>
    - Permissions are used to grant or deny access for different classes of users to different parts of the API.
    - The simplest style of permission would be to allow access to any authenticated user, and deny access to any unauthenticated user. This corresponds to the <code>IsAuthenticated</code> class in REST framework.
    - Sample permission class</p>
</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span>
<span class="k">class</span> <span class="nc">IsOwnerOrReadOnly</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom permission to only allow owners of an object to edit it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># message is used to create a response body when per check failed</span>
    <span class="n">code</span> <span class="o">=</span> <span class="mi">401</span> <span class="c1"># used to set http code</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span><span class="s2">&quot;False&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;permission error for user&quot;</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;IsOwnerCheck&quot;</span><span class="p">}</span>
    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="c1"># Read permissions are allowed to any request,</span>
        <span class="c1"># so we&#39;ll always allow GET, HEAD or OPTIONS requests.</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># Write permissions are only allowed to the owner of the snippet.</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># Read permissions are allowed to any request,</span>
        <span class="c1"># so we&#39;ll always allow GET, HEAD or OPTIONS requests.</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># Write permissions are only allowed to the owner of the snippet.</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</code></pre></div>
- Per-View permission check with</p>
<p><div class="highlight"><pre><span></span><code><span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">,</span>
                      <span class="n">IsOwnerOrReadOnly</span><span class="p">]</span>
</code></pre></div>
- <code>permission_classes</code> is <code>all()</code>, it is not same as <code>authentication_classes</code>
- Global setting with
  <div class="highlight"><pre><span></span><code><span class="c1"># settings.py</span>
<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
<span class="s2">&quot;DEFAULT_PERMISSION_CLASS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ext.per.IsOwnerOrReadOnly&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
- One difference between ((65136fb1-b3fd-40b2-b22b-d8ea5e0908b9)) is if a list of Per-Class is add. <strong>ALL</strong> Permission check need success/True. It is <strong>AND</strong> operation
- Add permission check in view</p>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">OrderView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
  <span class="n">permission_classes</span><span class="o">=</span><span class="p">[</span><span class="n">PermUser</span><span class="p">,</span> <span class="n">PermAPI</span><span class="p">]</span>
</code></pre></div>
- Check permissions override
    - if you need to override default permission check mechanism, override <code>check_permissions()</code> function in view class 💀
- Throttling
  heading:: 2
  desc:: Throttling is similar to <a href="https://www.django-rest-framework.org/api-guide/permissions/">permissions</a>, in that it determines if a request should be authorized. Throttles indicate a temporary state, and are used to control the rate of requests that clients can make to an API.
- As with permissions, multiple throttles may be used. Your API might have a restrictive throttle for unauthenticated requests, and a less restrictive throttle for authenticated requests.
- Another scenario where you might want to use multiple throttles would be if you need to impose different constraints on different parts of the API, due to some services being particularly resource-intensive.
- Settings</p>
<p><div class="highlight"><pre><span></span><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_THROTTLE_CLASSES&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;rest_framework.throttling.AnonRateThrottle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rest_framework.throttling.UserRateThrottle&#39;</span>
    <span class="p">],</span>
    <span class="s1">&#39;DEFAULT_THROTTLE_RATES&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;anon&#39;</span><span class="p">:</span> <span class="s1">&#39;100/day&#39;</span><span class="p">,</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;1000/day&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
  And in View</p>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ExampleView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">throttle_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">UserRateThrottle</span><span class="p">]</span>
</code></pre></div>
  FBV</p>
<p><div class="highlight"><pre><span></span><code>@api_view([&#39;GET&#39;])
@throttle_classes([UserRateThrottle])
def example_view(request, format=None):
    content = {
        &#39;status&#39;: &#39;request was permitted&#39;
    }
    return Response(content)
</code></pre></div>
- Define a throttle Class
    - In most case throttle class in django is good enough for 99% of the user cases. But in case you need to define a throttle of your own, here is two examples:
      <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RandomRateThrottle</span><span class="p">(</span><span class="n">throttling</span><span class="o">.</span><span class="n">BaseThrottle</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">allow_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>

<span class="k">class</span> <span class="nc">RandomRateThrottle2</span><span class="p">(</span><span class="n">throttling</span><span class="o">.</span><span class="n">SimpleRateThrottle</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">allow_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
      <span class="k">if</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">allow_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>

<span class="k">class</span> <span class="nc">MyRateThrottle</span><span class="p">(</span><span class="n">SimpleRateThrottle</span><span class="p">):</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">default_cache</span>  <span class="c1"># 访问记录存放在django的缓存中（需设置缓存）</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>  <span class="c1"># 构造缓存中的key different API can have different scope</span>
    <span class="n">cache_format</span> <span class="o">=</span> <span class="s1">&#39;throttle_</span><span class="si">%(scope)s</span><span class="s1">_</span><span class="si">%(ident)s</span><span class="s1">&#39;</span>

    <span class="c1"># 设置访问频率，例如：1分钟允许访问10次</span>
    <span class="c1"># 其他：&#39;s&#39;, &#39;sec&#39;, &#39;m&#39;, &#39;min&#39;, &#39;h&#39;, &#39;hour&#39;, &#39;d&#39;, &#39;day&#39;</span>
    <span class="n">THROTTLE_RATES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;10/m&quot;</span><span class="p">}</span>  <span class="c1">#scope : rate</span>

    <span class="k">def</span> <span class="nf">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span>  <span class="c1"># 用户ID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>  <span class="c1"># 获取请求用户IP（去request中找请求头）</span>

        <span class="c1"># throttle_u # throttle_user_11.11.11.11ser_2</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_format</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="s1">&#39;ident&#39;</span><span class="p">:</span> <span class="n">ident</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">throttle_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">detail</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">1005</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;访问频率限制&quot;</span><span class="p">,</span>
            <span class="s1">&#39;detail&#39;</span><span class="p">:</span> <span class="s2">&quot;需等待</span><span class="si">{}</span><span class="s2">s才能访问&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">wait</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="k">raise</span> <span class="n">ThrottledException</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
</code></pre></div>
- Versioning
  heading:: 2
  desc:: Versioning allows you to alter behavior between different clients. DRF provides for a number of different versioning schemes.
- Config API version
  heading:: 3
    - [[../assets/image-20210819154455680_1696666609261_0.png]]
    - settings.py</p>
<div class="codehilite"><pre><span></span><code>  ``` python
  REST_FRAMEWORK = {
      &#39;DEFAULT_VERSIONING_CLASS&#39;: &#39;rest_framework.versioning.NamespaceVersioning&#39;
  }
  ```
<span class="k">-</span> View.py

  ``` python
  class ProfileList(APIView):
      versioning_class = versioning.QueryParameterVersioning
  ```
-
</code></pre></div>

<ul>
<li>
<p>Version schema
  heading:: 3</p>
<ul>
<li><a href="https://www.django-rest-framework.org/api-guide/versioning/#acceptheaderversioning">AcceptHeaderVersioning</a>
  heading:: 3</li>
</ul>
<blockquote>
<p>GET <em>bookings</em> HTTP/1.1
  Host: example.com
  Accept: application/json; version=1.0
- <a href="https://www.django-rest-framework.org/api-guide/versioning/#urlpathversioning">URLPathVersioning</a>
  heading:: 3</p>
<p>GET /v1/bookings/ HTTP/1.1
  Host: example.com
  Accept: application/json</p>
</blockquote>
<p><div class="highlight"><pre><span></span><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">re_path</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;^(?P&lt;version&gt;(v1|v2))/bookings/$&#39;</span><span class="p">,</span>
        <span class="n">bookings_list</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bookings-list&#39;</span>
    <span class="p">),</span>
    <span class="n">re_path</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;^(?P&lt;version&gt;(v1|v2))/bookings/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span>
        <span class="n">bookings_detail</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bookings-detail&#39;</span>
    <span class="p">)</span>
<span class="p">]</span>
</code></pre></div>
- <a href="https://www.django-rest-framework.org/api-guide/versioning/#namespaceversioning">NamespaceVersioning</a>
  heading:: 3</p>
<blockquote>
<p>GET <em>bookings</em> HTTP/1.1
  Host: v1.example.com
  Accept: application/json</p>
</blockquote>
<p><div class="highlight"><pre><span></span><code><span class="c1"># bookings/urls.py</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">re_path</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">bookings_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bookings-list&#39;</span><span class="p">),</span>
    <span class="n">re_path</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">bookings_detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bookings-detail&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># urls.py</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">re_path</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^v1/bookings/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;bookings.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;v1&#39;</span><span class="p">)),</span>
    <span class="n">re_path</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^v2/bookings/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;bookings.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;v2&#39;</span><span class="p">))</span>
<span class="p">]</span>
</code></pre></div>
- <a href="https://www.django-rest-framework.org/api-guide/versioning/#queryparameterversioning">QueryParameterVersioning</a>
  heading:: 3</p>
<blockquote>
<p>GET <em>something</em>?version=0.1 HTTP/1.1
  Host: example.com
  Accept: application/json
    - Reverse URL
      heading:: 3
- [[../assets/image-20210820105543193-3386187_1696666581416_0.png]]
- [[../assets/image-20210820112152615_1696666677979_0.png]]
- Request parsing
  heading:: 2
  desc:: REST framework includes a number of built in Parser classes, that allow you to accept requests with various media types. There is also support for defining your own custom parsers
    - Jsonparser
      [[../assets/image-20210827081058194_1696668405368_0.jpg]]
    - File parser (MultiPartParser)
- [[../assets/image-20210827083047327_1696668472683_0.jpg]]
    - File uploader
- [[../assets/image-20210827084403453_1696668497009_0.jpg]]
-
    -
- Content negotiation
  heading:: 2
  desc:: Content negotiation is the process of selecting one of multiple possible representations to return to a client, based on client or server preferences.
  url:: <a href="https://www.django-rest-framework.org/api-guide/content-negotiation/">Content negotiation - Django REST framework</a>
    - The client need specify <code>content-type</code>and the value should be valid http <code>media type</code>
    - the config is through <code>parser_classes</code> and <code>content_negotiation_class</code>
      Global setting</p>
</blockquote>
</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_CONTENT_NEGOTIATION_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;myapp.negotiation.IgnoreClientContentNegotiation&#39;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
- When the code refer to request.data it will trigger the parser
- Most used <code>JSONParser</code> and <code>FormParserxx</code>, to upload file <code>FileUploaderParser</code>, Large file <code>MultiPartParser</code>
- If not specifed or content does not match parser, a exception will be throw
-
-
- Serializers
  heading:: 2
  desc:: Serializers allow complex data such as querysets and model instances to be converted to native Python datatypes that can then be easily rendered into <sub>JSON</sub>, <sub>XML</sub> or other content types. Serializers also provide deserialization, allowing parsed data to be converted back into complex types, after first validating the incoming data.
- Declaring Serializers
  heading:: 3
    - In a sense, Serializers is similar to ((651cfa1b-ce5c-486b-8f45-5f3cee8f113e))
    - Create a serializer for <code>Comment</code></p>
<div class="codehilite"><pre><span></span><code>  <span class="err">```</span> <span class="n">python</span>
  <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

  <span class="k">class</span> <span class="nc">Comment</span><span class="p">:</span>
      <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">created</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

  <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">&#39;leila@example.com&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s1">&#39;foo bar&#39;</span><span class="p">)</span>

  <span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>
  <span class="k">class</span> <span class="nc">CommentSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
      <span class="n">email</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">EmailField</span><span class="p">()</span>
      <span class="n">content</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
      <span class="n">created</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
  <span class="err">```</span>
</code></pre></div>

<ul>
<li>Serializing object
  heading:: 3<ul>
<li>use <sub>CommentSerializer</sub> to serialize a comment, or list of comments
  <code>python
  serializer = CommentSerializer(comment)
  serializer.data
  # {'email': 'leila@example.com', 'content': 'foo bar', 'created': '2016-01-27T15:17:10.375877'}
  comments = [comment, comment] # array of objects
  serializer = CommentSerializer(comments, many=True)
  serializer.data # a list of objects
  from rest_framework.renderers import JSONRenderer

  json = JSONRenderer().render(serializer.data)</code></li>
</ul>
</li>
<li>Deserializing
  heading:: 3</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">rest_framework.parsers</span> <span class="kn">import</span> <span class="n">JSONParser</span>

<span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">JSONParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">CommentSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
<span class="c1"># True</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span>
<span class="c1"># {&#39;content&#39;: &#39;foo bar&#39;, &#39;email&#39;: &#39;leila@example.com&#39;, &#39;created&#39;: datetime.datetime(2012, 08, 22, 16, 20, 09, 822243)}</span>
</code></pre></div>
- ModelSerializer
  heading:: 3
  desc:: serializer classes that map closely to Django model definitions.
    - The <code>ModelSerializer</code> class provides a shortcut that lets you automatically create a <sub>Serializer</sub> class with fields that correspond to the Model fields. It based on <code>Serializer</code> class and
      * It will automatically generate a set of fields for you, based on the model.
      * It will automatically generate validators for the serializer, such as unique_{ together} validators.
      * It includes simple default implementations of <code>.create()</code> and <code>.update()</code>.
    - Declaring
      heading:: 4</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  class AccountSerializer(serializers.ModelSerializer):</span>
<span class="n n-Quoted">      class Meta:</span>
<span class="n n-Quoted">          model = Account</span>
<span class="n n-Quoted">          fields = [&#39;id&#39;, &#39;account_name&#39;, &#39;users&#39;, &#39;created&#39;]  # similar to ModelForm, you can use fields = &#39;__all__&#39;</span>
<span class="n n-Quoted">          read_only_fields = [&#39;account_name&#39;]</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`read_only`</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n n-Quoted">`write_only`</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`read_only`</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="n">serializer</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">shown</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">response</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`write_only`</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="n">serializer</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="w"> </span><span class="k">password</span><span class="o">/</span><span class="n">token</span><span class="w"> </span><span class="n">field</span>
<span class="o">-</span><span class="w"> </span><span class="n">choice</span><span class="w"> </span><span class="k">fields</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="w"> </span><span class="n">gender</span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="mi">1</span><span class="o">:</span><span class="s1">&#39;male&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;female&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="n">depart</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">name</span><span class="p">)</span>

<span class="w">      </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">      # model gender: ((1:&#39;male&#39;), (2, &#39;female&#39;))</span>
<span class="n n-Quoted">      class AccountSerializer(serializers.ModelSerializer):</span>
<span class="n n-Quoted">          gender_info = serializers.CharField(source=&#39;get_gender_display&#39;, read_only=True)</span>
<span class="n n-Quoted">          depart = serializers.CharField(source=&#39;depart.title&#39;) #show department title</span>
<span class="n n-Quoted">          class Meta:</span>
<span class="n n-Quoted">              model = Account</span>
<span class="n n-Quoted">              fields = [&#39;id&#39;, &#39;account_name&#39;, &#39;users&#39;, &#39;created&#39;, &#39;gender_info&#39;, &#39;depart&#39;]</span>
<span class="n n-Quoted">            extra_kwargs = {&#39;gender&#39;: {&#39;write_only&#39;: True}}</span>
<span class="n n-Quoted">      </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">follow</span><span class="w"> </span><span class="n">conventions</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">Django</span><span class="w"> </span><span class="n">ModelForm</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">name</span><span class="w"> </span><span class="n n-Quoted">`gender_info`</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="k">write</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">number</span><span class="w"> </span><span class="mi">1</span><span class="o">|</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="k">string</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">male</span><span class="o">|</span><span class="n">female</span>
<span class="o">-</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="n">own</span><span class="w"> </span><span class="n">field</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  class AccountSerializer(serializers.ModelSerializer):</span>
<span class="n n-Quoted">      class Meta:</span>
<span class="n n-Quoted">          model = Account</span>
<span class="n n-Quoted">          fields = [&#39;xxx&#39;]</span>
<span class="n n-Quoted">      def get_xxx(self, obj):</span>
<span class="n n-Quoted">          return obj.first_name + obj.last_name</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="k">nested</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">embed</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">Suppose</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="k">tables</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">m</span><span class="o">:</span><span class="n">n</span><span class="w"> </span><span class="n">relations</span>

<span class="w">      </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">      from django.db import models</span>
<span class="n n-Quoted">      class Role(models.Model):</span>
<span class="n n-Quoted">          title = models.CharField(verbose_name=&quot;标题&quot;, max_length=32)</span>
<span class="n n-Quoted">          order = models.IntegerField(verbose_name=&quot;顺序&quot;)</span>
<span class="n n-Quoted">      class Tag(models.Model):</span>
<span class="n n-Quoted">          caption = models.CharField(verbose_name=&quot;名称&quot;, max_length=32)</span>
<span class="n n-Quoted">      class UserInfo(models.Model):</span>
<span class="n n-Quoted">          name = models.CharField(verbose_name=&quot;姓名&quot;, max_length=32)</span>
<span class="n n-Quoted">          gender = models.SmallIntegerField(verbose_name=&quot;性别&quot;, choices=((1, &quot;男&quot;), (2, &quot;女&quot;)))</span>
<span class="n n-Quoted">          role = models.ForeignKey(verbose_name=&quot;角色&quot;, to=&quot;Role&quot;, on_delete=models.CASCADE)</span>
<span class="n n-Quoted">          ctime = models.DateTimeField(verbose_name=&quot;创建时间&quot;, auto_now_add=True)</span>

<span class="n n-Quoted">          tags = models.ManyToManyField(verbose_name=&quot;标签&quot;, to=&quot;Tag&quot;)</span>
<span class="n n-Quoted">      </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ModelSerializer</span>

<span class="w">      </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">      from rest_framework.views import APIView</span>
<span class="n n-Quoted">      from rest_framework.response import Response</span>
<span class="n n-Quoted">      from rest_framework import serializers</span>
<span class="n n-Quoted">      from api import models</span>

<span class="n n-Quoted">      class RoleSerializer(serializers.ModelSerializer):</span>
<span class="n n-Quoted">          class Meta:</span>
<span class="n n-Quoted">              model = models.Role</span>
<span class="n n-Quoted">              # fields = &quot;__all__&quot;</span>
<span class="n n-Quoted">              fields = [&quot;id&quot;, &#39;title&#39;]</span>

<span class="n n-Quoted">      class TagSerializer(serializers.ModelSerializer):</span>
<span class="n n-Quoted">          class Meta:</span>
<span class="n n-Quoted">              model = models.Tag</span>
<span class="n n-Quoted">              fields = &quot;__all__&quot;</span>

<span class="n n-Quoted">      class InfoSerializer(serializers.ModelSerializer):</span>
<span class="n n-Quoted">          role = RoleSerializer()</span>
<span class="n n-Quoted">          tags = TagSerializer(many=True)</span>

<span class="n n-Quoted">          class Meta:</span>
<span class="n n-Quoted">              model = models.UserInfo</span>
<span class="n n-Quoted">              fields = [&#39;id&#39;, &#39;name&#39;, &quot;role&quot;, &quot;tags&quot;]</span>

<span class="n n-Quoted">      class InfoView(APIView):</span>
<span class="n n-Quoted">          def get(self, request):</span>
<span class="n n-Quoted">              queryset = models.UserInfo.objects.all()</span>
<span class="n n-Quoted">              ser = InfoSerializer(instance=queryset, many=True)</span>
<span class="n n-Quoted">              print(type(ser.data), ser.data)</span>
<span class="n n-Quoted">              return Response(ser.data)</span>
<span class="n n-Quoted">      </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="n">Inheritances</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  from rest_framework.views import APIView</span>
<span class="n n-Quoted">  from rest_framework.response import Response</span>
<span class="n n-Quoted">  from rest_framework import serializers</span>
<span class="n n-Quoted">  from api import models</span>


<span class="n n-Quoted">  class MySerializer(serializers.Serializer):</span>
<span class="n n-Quoted">      more = serializers.SerializerMethodField()</span>

<span class="n n-Quoted">      def get_more(self, obj):</span>
<span class="n n-Quoted">          return &quot;123&quot;</span>

<span class="n n-Quoted">  # inherit MySerializer</span>
<span class="n n-Quoted">  class InfoSerializer(serializers.ModelSerializer, MySerializer):</span>
<span class="n n-Quoted">      class Meta:</span>
<span class="n n-Quoted">          model = models.UserInfo</span>
<span class="n n-Quoted">          fields = [&quot;id&quot;, &quot;name&quot;, &#39;more&#39;]</span>


<span class="n n-Quoted">  class InfoView(APIView):</span>
<span class="n n-Quoted">      def get(self, request):</span>
<span class="n n-Quoted">          instance = models.UserInfo.objects.all().first()</span>
<span class="n n-Quoted">          ser = InfoSerializer(instance=instance, many=False)</span>

<span class="n n-Quoted">          print(type(ser.data), ser.data)</span>
<span class="n n-Quoted">          return Response(ser.data)</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="n">Save</span><span class="o">/</span><span class="k">Update</span><span class="w"> </span><span class="k">data</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="o">-</span><span class="w"> </span><span class="n">save</span><span class="p">()</span><span class="o">/</span><span class="w"> </span><span class="k">update</span><span class="p">()</span><span class="w"> </span><span class="n">method</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  serializer = CommentModelSerializer(data=data)</span>
<span class="n n-Quoted">  serializer.save()</span>
<span class="n n-Quoted">  # for non model serializer</span>
<span class="n n-Quoted">  serializer = CommentNonModelSerializer(data=data)</span>
<span class="n n-Quoted">  serializer.validated_data.pop(&#39;confirm_password&#39;) # there are filed should not save into database</span>
<span class="n n-Quoted">  models.Comment.objects.create(**serializer .validate_data)</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="k">In</span><span class="w"> </span><span class="n">save</span><span class="p">(),</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="n">additional</span><span class="w"> </span><span class="k">fields</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  serializer.save(updated = datetime.now(), updated_by = request.user )</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="k">Foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">many</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">many</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="k">When</span><span class="w"> </span><span class="n">validate</span><span class="o">/</span><span class="n">save</span><span class="w"> </span><span class="n">foriegn</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="n">DRF</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">not</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">apply</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">M2N</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;tags&#39;</span><span class="o">:</span><span class="w"> </span><span class="err">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1111</span><span class="err">]}</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n n-Quoted">`1111`</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">existed</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">M2N</span><span class="w"> </span><span class="k">table</span><span class="p">,</span><span class="w"> </span><span class="k">validation</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">fail</span>
<span class="o">-</span><span class="w"> </span><span class="n">Override</span><span class="w"> </span><span class="n n-Quoted">`to_presentation`</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">friendly</span><span class="w"> </span><span class="n">way</span><span class="w"> </span><span class="p">(</span><span class="n">beyond</span><span class="w"> </span><span class="n n-Quoted">`display_xxx`</span><span class="p">)</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">override</span><span class="w">  </span><span class="n n-Quoted">`to_presentation`</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="err">[[</span><span class="p">..</span><span class="o">/</span><span class="n">assets</span><span class="o">/</span><span class="n">image_1696746627345_0</span><span class="p">.</span><span class="n">png</span><span class="err">]]</span>

<span class="w">      </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">      class SbModelSerializer(NbHookSerializer, serializers.ModelSerializer):</span>
<span class="n n-Quoted">          class Meta:</span>
<span class="n n-Quoted">              model = models.NbUserInfo</span>
<span class="n n-Quoted">              fields = [&quot;id&quot;, &quot;name&quot;, &quot;age&quot;, &quot;gender&quot;]</span>
<span class="n n-Quoted">              extra_kwargs = {</span>
<span class="n n-Quoted">                  &quot;id&quot;: {&quot;read_only&quot;: True}</span>
<span class="n n-Quoted">              }</span>

<span class="n n-Quoted">          def nb_gender(self, obj): # YOu can define your own getter here</span>
<span class="n n-Quoted">              return obj.get_gender_display()</span>

<span class="n n-Quoted">          def nb_name(self, obj):</span>
<span class="n n-Quoted">              return obj.get_gender_display()</span>
<span class="n n-Quoted">      class SbView(APIView):</span>
<span class="n n-Quoted">          def post(self, request, *args, **kwargs):</span>
<span class="n n-Quoted">              ser = SbModelSerializer(data=request.data)  # the to_presentation was overrided</span>
<span class="n n-Quoted">              if ser.is_valid():</span>
<span class="n n-Quoted">                  ser.save()</span>
<span class="n n-Quoted">                  return Response(ser.data)</span>
<span class="n n-Quoted">              else:</span>
<span class="n n-Quoted">                  return Response(ser.errors)</span>
<span class="n n-Quoted">      </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
</code></pre></div>

<ul>
<li>Under the hood<ul>
<li>[[../assets/image-20210823235752483_1696691331872_0.jpg]]</li>
<li>[[../assets/image-20210824001814091_1696723163568_0.jpg]]</li>
<li>[[../assets/image-20210824001844381_1696723308136_0.jpg]]</li>
</ul>
</li>
<li>Validator
  heading:: 2
  desc:: validation logic into reusable component, DRF validation is performed entirely on the serializer class.</li>
<li>Samples</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CustomerReportRecord</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">time_raised</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
<span class="c1"># if meta set to CustomerReportRecord, reference max_len will be 20</span>
<span class="k">class</span> <span class="nc">CustomerReportModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CustomerReportRecord</span>

<span class="c1">#This works as well</span>
<span class="k">class</span> <span class="nc">CustomerReportSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="c1"># email = serializers.EmailField() # implemented email validation</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">EmailValidator</span><span class="p">(</span><span class="s2">&quot;email format invalid&quot;</span><span class="p">)])</span>
    <span class="n">mobile</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">RegexValidator</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;number only&quot;</span><span class="p">)])</span>
</code></pre></div>
- Model serializer validations
    - You can set it up for more complicated validations schemas</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="err">```</span><span class="w"> </span><span class="n">python</span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="n">BillingRecordSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
<span class="w">      </span><span class="n">def</span><span class="w"> </span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p">):</span>
<span class="w">          </span><span class="c1"># Apply custom validation either here, or in the view.</span>

<span class="w">      </span><span class="k">class</span><span class="w"> </span><span class="n">Meta</span><span class="p">:</span>
<span class="w">          </span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;client&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
<span class="w">          </span><span class="n">validators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="n">UniqueForYearValidator</span><span class="p">(</span>
<span class="w">                  </span><span class="n">queryset</span><span class="o">=</span><span class="n">BlogPostItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
<span class="w">                  </span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;slug&#39;</span><span class="p">,</span>
<span class="w">                  </span><span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;published&#39;</span>
<span class="w">              </span><span class="p">)</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">          </span><span class="n">extra_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s1">&#39;client&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;required&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">},</span>
<span class="w">            </span><span class="s1">&#39;title&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;max_length&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">},</span>
<span class="w">            </span><span class="s1">&#39;phone&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;validators&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">RegexValidator</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;phone number&#39;</span><span class="p">)]},</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">          </span><span class="c1"># validators = []  # Remove a default &quot;unique together&quot; constraint.</span>
<span class="w">  </span><span class="err">```</span>
</code></pre></div>

<ul>
<li>
<p>Validator hook</p>
<ul>
<li>Put inside CustomerReportSerializer</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CustomerReportSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">validate_phone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="c1"># validate {&#39;phone&#39;: &#39;02233221123&#39;, ...}</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;incorrect phone number length&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span> <span class="c1"># this validate all fields</span>
      <span class="c1"># api_settings.NON_FIELD_ERRORS_KEY</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mobile&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;incorrect mobile for AU&#39;</span><span class="p">)</span>
</code></pre></div>
    - Validation error exception will be captured in DRF and convert to error response
    - Validate a request</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CustomerView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="n">ser</span> <span class="o">=</span> <span class="n">CustomerReportSerializer</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
      <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

      <span class="n">modelser</span> <span class="o">=</span> <span class="n">CustomerReportModelSerializer</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
      <span class="n">modelser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/12/19/python-django-restful-framework/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-12-19 00:00:00">December 19, 2023</time>
          <!-- start customization -->
          
          <!-- end customization --></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="login-session-and-cookie"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/">Login, session and cookie</a></h2>
<h3 id="an-http-cookie-web-cookie-browser-cookie-is-a-small-piece-of-data-that-a-server-sends-to-a-users-web-browser-the-browser-may-store-the-cookie-and-send-it-back-to-the-same-server-with-later-requests-typically-an-http-cookie-is-used-to-tell-if-two-requests-come-from-the-same-browser-keeping-a-user-logged-in-for-example-it-remembers-stateful-information-for-the-stateless-http-protocol"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#an-http-cookie-web-cookie-browser-cookie-is-a-small-piece-of-data-that-a-server-sends-to-a-users-web-browser-the-browser-may-store-the-cookie-and-send-it-back-to-the-same-server-with-later-requests-typically-an-http-cookie-is-used-to-tell-if-two-requests-come-from-the-same-browser-keeping-a-user-logged-in-for-example-it-remembers-stateful-information-for-the-stateless-http-protocol">An *HTTP cookie* (web cookie, browser cookie) is a small piece of data that a server sends to a user's web browser. The browser may store the cookie and send it back to the same server with later requests. Typically, an HTTP cookie is used to tell if two requests come from the same browser&mdash;keeping a user logged in, for example. It remembers stateful information for the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Overview#http_is_stateless_but_not_sessionless">stateless</a> HTTP protocol.</a></h3>
<h3 id="cookies-are-mainly-used-for-three-purposes"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#cookies-are-mainly-used-for-three-purposes">Cookies are mainly used for three purposes:</a></h3>
<h4 id="session-management-eg-logins-shopping-carts-game-scores-or-anything-else-the-server-should-remember"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#session-management-eg-logins-shopping-carts-game-scores-or-anything-else-the-server-should-remember">Session management, e.g. Logins, shopping carts, game scores, or anything else the server should remember</a></h4>
<h4 id="personalization-eg-user-preferences-themes-and-other-settings"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#personalization-eg-user-preferences-themes-and-other-settings">Personalization, e.g. User preferences, themes, and other settings</a></h4>
<h4 id="tracking-recording-and-analyzing-user-behavior"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#tracking-recording-and-analyzing-user-behavior">Tracking. Recording and analyzing user behavior</a></h4>
<h3 id="sessions-are-saved-on-the-server-side-while-cookies-are-saved-on-the-client-side"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#sessions-are-saved-on-the-server-side-while-cookies-are-saved-on-the-client-side">sessions are saved on the server side while cookies are saved on the client side.</a></h3>
<h2 id="cross-site-request-forgery-protection"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#cross-site-request-forgery-protection">Cross Site Request Forgery protection</a></h2>
<h3 id="the-csrf-middleware-and-template-tag-provides-easy-to-use-protection-against-cross-site-request-forgeries-this-type-of-attack-occurs-when-a-malicious-website-contains-a-link-a-form-button-or-some-javascript-that-is-intended-to-perform-some-action-on-your-website-using-the-credentials-of-a-logged-in-user-who-visits-the-malicious-site-in-their-browser"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#the-csrf-middleware-and-template-tag-provides-easy-to-use-protection-against-cross-site-request-forgeries-this-type-of-attack-occurs-when-a-malicious-website-contains-a-link-a-form-button-or-some-javascript-that-is-intended-to-perform-some-action-on-your-website-using-the-credentials-of-a-logged-in-user-who-visits-the-malicious-site-in-their-browser">The CSRF middleware and template tag provides easy-to-use protection against <a href="https://www.squarefree.com/securitytips/web-developers.html#CSRF">Cross Site Request Forgeries</a>. This type of attack occurs when a malicious website contains a link, a form button or some JavaScript that is intended to perform some action on your website, using the credentials of a logged-in user who visits the malicious site in their browser.</a></h3>
<h3 id="csrf_exemptview"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#csrf_exemptview"><code>csrf_exempt(view)</code></a></h3>
<h4 id="this-decorator-marks-a-view-as-being-exempt-from-the-protection-ensured-by-the-middleware-example"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#this-decorator-marks-a-view-as-being-exempt-from-the-protection-ensured-by-the-middleware-example">This decorator marks a view as being exempt from the protection ensured by the middleware. Example:</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span>
<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Hello world&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 collapsed="true" id="csrf_protectview"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#csrf_protectview"><code>csrf_protect(view)</code></a></h3>
<h4 id="decorator-that-provides-the-protection-of-csrfviewmiddleware-to-a-view-usages"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#decorator-that-provides-the-protection-of-csrfviewmiddleware-to-a-view-usages">Decorator that provides the protection of CsrfViewMiddleware to a view. Usages:</a></h4>
<div class="highlight"><pre><span></span><code>    <span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
    <span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_protect</span>
    <span class="nd">@csrf_protect</span>
    <span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;a_template.html&quot;</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div>
<h3 id="requires_csrf_tokenview"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#requires_csrf_tokenview"><code>requires_csrf_token(view)</code></a></h3>
<h4 id="normally-the-csrftoken-template-tag-will-not-work-if-csrfviewmiddlewareprocessview-or-an-equivalent-like-csrfprotect-has-not-run-the-view-decorator-requirescsrftoken-can-be-used-to-ensure-the-template-tag-does-work"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#normally-the-csrftoken-template-tag-will-not-work-if-csrfviewmiddlewareprocessview-or-an-equivalent-like-csrfprotect-has-not-run-the-view-decorator-requirescsrftoken-can-be-used-to-ensure-the-template-tag-does-work">Normally the <a href="https://docs.djangoproject.com/en/4.2/ref/templates/builtins/#std-templatetag-csrf_token">csrf<sub>token</sub></a> template tag will not work if CsrfViewMiddleware.process<sub>view</sub> or an equivalent like csrf<sub>protect</sub> has not run. The view decorator ~requires<sub>csrftoken</sub>~ can be used to ensure the template tag does work.</a></h4>
<h2 id="session"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#session">Session</a></h2>
<h3 id="django-session"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#django-session"><a href="../assets/Django-Session_1696546798398_0.jpg">django session</a></a></h3>
<h3 id="session_1"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#session_1"><a href="../assets/django_login_auth.png">session</a></a></h3>
<h3 id="default-session-setup"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#default-session-setup">Default session setup</a></h3>
<h4 id="settingpy"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#settingpy">setting.py</a></h4>
<div class="highlight"><pre><span></span><code>    <span class="n">SESSION_ENGINE</span> <span class="o">=</span> <span class="s1">&#39;django.contrib.sessions.backends.db&#39;</span> <span class="c1"># 引擎（默认）</span>
    <span class="c1"># use &#39;django.contrib.sessions.backends.cached_db&#39; for high traffic</span>
    <span class="n">SESSION_COOKIE_NAME</span> <span class="err">＝</span> <span class="s2">&quot;sessionid&quot;</span> <span class="c1"># Session的cookie保存在浏览器上时的key，即：sessionid＝随机字符串（默认）</span>
    <span class="n">SESSION_COOKIE_PATH</span> <span class="err">＝</span> <span class="s2">&quot;/&quot;</span> <span class="c1"># Session的cookie保存的路径（默认）</span>
    <span class="n">SESSION_COOKIE_DOMAIN</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Session的cookie保存的域名（默认）</span>
    <span class="n">SESSION_COOKIE_SECURE</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># 是否Https传输cookie（默认）</span>
    <span class="n">SESSION_COOKIE_HTTPONLY</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># 是否Session的cookie只支持http传输（默认）</span>
    <span class="n">SESSION_COOKIE_AGE</span> <span class="o">=</span> <span class="mi">1209600</span> <span class="c1"># Session的cookie失效日期（2周）（默认）</span>
    <span class="n">SESSION_EXPIRE_AT_BROWSER_CLOSE</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># 是否关闭浏览器使得Session过期（默认）</span>
    <span class="n">SESSION_SAVE_EVERY_REQUEST</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># 是否每次请求都保存Session，默认修改之后才保存（默认）</span>
</code></pre></div>
<h3 id="cookie"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#cookie">Cookie</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">request</span><span class="p">.</span><span class="n">COOKIES</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
<span class="n">request</span><span class="p">.</span><span class="n">COOKIES</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="k">key</span><span class="p">)</span>
<span class="err">#</span><span class="w"> </span><span class="n">普通cookie是明文传输的</span><span class="err">，</span><span class="n">可以直接在客户端直接打开</span><span class="err">，</span><span class="n">所以需要加盐</span><span class="err">，</span><span class="n">解盐之后才能查看</span>
<span class="n">request</span><span class="p">.</span><span class="n">get_signed_cookie</span><span class="p">(</span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="k">default</span><span class="o">=</span><span class="n">RAISE_ERROR</span><span class="p">,</span><span class="w"> </span><span class="n">salt</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">max_age</span><span class="o">=</span><span class="k">None</span><span class="p">)</span>
</code></pre></div>

<h2 id="login-html"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#login-html">Login HTML</a></h2>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="o">%</span> <span class="n">raw</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;account&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="n">用户登录</span><span class="o">&lt;/</span><span class="n">h2</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;panel-body&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">form</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span> <span class="n">novalidate</span><span class="o">&gt;</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">csrf_token</span> <span class="o">%</span><span class="p">}</span>
            <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;form-group&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">label</span><span class="o">&gt;</span><span class="n">用户名</span><span class="o">&lt;/</span><span class="n">label</span><span class="o">&gt;</span>
                <span class="p">{{</span> <span class="n">form</span><span class="o">.</span><span class="n">username</span> <span class="p">}}</span>
                <span class="o">&lt;</span><span class="n">span</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;color: red;&quot;</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">username</span><span class="mf">.0</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;form-group&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">label</span><span class="o">&gt;</span><span class="n">密码</span><span class="o">&lt;/</span><span class="n">label</span><span class="o">&gt;</span>
                <span class="p">{{</span> <span class="n">form</span><span class="o">.</span><span class="n">password</span> <span class="p">}}</span>
                <span class="o">&lt;</span><span class="n">span</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;color: red;&quot;</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">password</span><span class="mf">.0</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>

            <span class="o">&lt;</span><span class="n">button</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;btn btn-primary center-block&quot;</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;width: 80px;&quot;</span><span class="o">&gt;</span><span class="n">登录</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endraw</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div>
<h2 id="login-form"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#login-form">Login Form</a></h2>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">employee_management.utils.modelform</span> <span class="kn">import</span> <span class="n">BootStrapForm</span>
<span class="kn">from</span> <span class="nn">employee_management.utils.encrypt</span> <span class="kn">import</span> <span class="n">md5</span>
<span class="kn">from</span> <span class="nn">employee_management.models</span> <span class="kn">import</span> <span class="n">Admin</span>

<span class="c1"># 使用Form来实现</span>
<span class="k">class</span> <span class="nc">LoginForm</span><span class="p">(</span><span class="n">BootStrapForm</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;用户名&quot;</span><span class="p">,</span>
        <span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">TextInput</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;form-control&quot;</span><span class="p">}),</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;用户名&quot;</span><span class="p">,</span>
        <span class="c1"># render_value=True 表示当提交后,如果密码输入错误,不会自动清空密码输入框的内容</span>
        <span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">PasswordInput</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;form-control&quot;</span><span class="p">},</span> <span class="p">),</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">md5</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;登录&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;login.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="c1"># 验证成功, 获取到的用户名和密码</span>
        <span class="c1"># print(form.cleaned_data)</span>
        <span class="c1"># {&#39;username&#39;: &#39;123&#39;, &#39;password&#39;: &#39;123&#39;}</span>
        <span class="c1"># {&#39;username&#39;: &#39;456&#39;, &#39;password&#39;: &#39;0f54af32f41a5ba8ef3a2d40cd6ccf25&#39;}</span>

        <span class="c1"># 去数据库校验用户名和密码是否正确</span>
        <span class="n">admin_object</span> <span class="o">=</span> <span class="n">Admin</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">admin_object</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;用户名或密码错误&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;login.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>

        <span class="c1"># 如果用户名密码正确</span>
        <span class="c1"># 网站生成随机字符创,写到用户浏览器的cookie中,再写入到服务器的session中</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">admin_object</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">admin_object</span><span class="o">.</span><span class="n">username</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/admin/list/&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;login.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>
</code></pre></div>
<h2 collapsed="true" id="session-storage"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#session-storage">Session storage</a></h2>
<h3 id="the-request-object-has-a-session-attribute-and-when-the-server-executes-the-code-the-session-middleware-and-the-sessions-application-operate-together-seamlessly-when-you-first-store-data-in-a-session-django-saves-the-data-server-side-and-associates-it-with-a-unique-session-id-the-server-side-session-data-object-is-created-when-you-store-any-data-in-the-session-and-is-saved-either-at-the-end-of-the-request-or-when-you-explicitly-call-the-sessionid-cookie-is-created-client-side-when-you-first-store-any-data-in-the-session"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#the-request-object-has-a-session-attribute-and-when-the-server-executes-the-code-the-session-middleware-and-the-sessions-application-operate-together-seamlessly-when-you-first-store-data-in-a-session-django-saves-the-data-server-side-and-associates-it-with-a-unique-session-id-the-server-side-session-data-object-is-created-when-you-store-any-data-in-the-session-and-is-saved-either-at-the-end-of-the-request-or-when-you-explicitly-call-the-sessionid-cookie-is-created-client-side-when-you-first-store-any-data-in-the-session">The request object has a session attribute, and when the server executes the code, the session middleware and the session&rsquo;s application operate together seamlessly. When you first store data in a session, Django saves the data server-side and associates it with a unique session ID. The server-side session data (object) is created when you store any data in the session and is saved either at the end of the request or when you explicitly call. The <code>sessionid</code> cookie is created client-side when you first store any data in the session.</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">django_session</span><span class="p">;</span>
<span class="o">+</span><span class="c1">----------------------------------+-------------------------------------------------------------------------------------------------+----------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">session_key</span><span class="w">                      </span><span class="o">|</span><span class="w"> </span><span class="n">session_data</span><span class="w">                                                                                    </span><span class="o">|</span><span class="w"> </span><span class="n">expire_date</span><span class="w">                </span><span class="o">|</span>
<span class="o">+</span><span class="c1">----------------------------------+-------------------------------------------------------------------------------------------------+----------------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">zkgq26t7hqx3yu6xo04bws856002n5aj</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">eyJpbmZvIjp7ImlkIjoxMiwibmFtZSI6InRva2VyIn19</span><span class="p">:</span><span class="mi">1</span><span class="n">pElim</span><span class="p">:</span><span class="n">Tus2mHaJUTNTfzhppuah8N0FVdLXQxyvRk_4n</span><span class="o">-</span><span class="mi">4</span><span class="n">fP6g</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">23</span><span class="w"> </span><span class="mi">06</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">24</span><span class="p">.</span><span class="mi">373104</span><span class="w"> </span><span class="o">|</span>
<span class="o">+</span><span class="c1">----------------------------------+-------------------------------------------------------------------------------------------------+----------------------------+</span>
<span class="o">```</span><span class="w"> </span><span class="k">sql</span>

<span class="n">mysql</span><span class="err">\</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="err">\</span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">django</span><span class="o">~</span><span class="k">session</span><span class="o">~</span><span class="p">;</span>

<span class="w">  </span><span class="c1">---------------------------------- -------------------------------------------------------------------------------------------------- -----------------</span>
<span class="w">  </span><span class="k">session</span><span class="o">~</span><span class="k">key</span><span class="o">~</span><span class="w">                       </span><span class="k">session</span><span class="o">~</span><span class="k">data</span><span class="o">~</span><span class="w">                                                                                      </span><span class="n">expire</span><span class="o">~</span><span class="nb">date</span><span class="o">~</span>

<span class="w">  </span><span class="n">zkgq26t7hqx3yu6xo04bws856002n5aj</span><span class="w">   </span><span class="n">eyJpbmZvIjp7ImlkIjoxMiwibmFtZSI6InRva2VyIn19</span><span class="p">:</span><span class="mi">1</span><span class="n">pElim</span><span class="p">:</span><span class="n">Tus2mHaJUTNTfzhppuah8N0FVdLXQxyvRk</span><span class="o">~</span><span class="mi">4</span><span class="n">n</span><span class="o">~-</span><span class="mi">4</span><span class="n">fP6g</span><span class="w">   </span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">23</span>
<span class="w">                                                                                                                                        </span><span class="mi">06</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">24</span><span class="p">.</span><span class="mi">373104</span>
<span class="w">  </span><span class="c1">---------------------------------- -------------------------------------------------------------------------------------------------- -----------------</span>
</code></pre></div>
<h2 id="django-middleware"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#django-middleware">Django Middleware</a></h2>
<h3 id="class-with-process_request-input-middleware"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#class-with-process_request-input-middleware">Class with <code>process_request</code> Input middleware</a></h3>
<h4 id="if-processrequest-return-anything-the-request-will-not-forward-to-viewpy-it-will-return-the-result"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#if-processrequest-return-anything-the-request-will-not-forward-to-viewpy-it-will-return-the-result">if process<sub>request</sub> return anything, the request will not forward to view.py, it will return the result</a></h4>
<h4 id="if-nothing-return-continue-with-next-middleware-and-then-go-to-view"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#if-nothing-return-continue-with-next-middleware-and-then-go-to-view">if nothing return, continue with next middleware and then go to view</a></h4>
<h3 id="proccess_responseself-request-response-output-middleware"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#proccess_responseself-request-response-output-middleware"><code>proccess_response(self, request, response)</code> output middleware</a></h3>
<h2 id="auth-middleware"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#auth-middleware">Auth middleware</a></h2>
<h3 id="middlewareauthpy"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#middlewareauthpy">middleware/auth.py</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.utils.deprecation</span> <span class="kn">import</span> <span class="n">MiddlewareMixin</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">redirect</span>


<span class="k">class</span> <span class="nc">AuthMiddleware</span><span class="p">(</span><span class="n">MiddlewareMixin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>

        <span class="c1"># 0.排除不需要的页面 否则容易死循环【【【</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path_info</span> <span class="o">==</span> <span class="s2">&quot;/login/&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># 1.读取当前访问的用户的session信息,如果能读到,说明已登录过,就可以继续向后走</span>
        <span class="n">info_dict</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info_dict</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># 2.如果没有登录信息</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/login/&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="settingpy_1"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#settingpy_1">setting.py</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.middleware.security.SecurityMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;employee_management.middleware.auth.AuthMiddleware&#39;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>
<h3 id="logout"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#logout">logout</a></h3>
<h4 id="clean-session-data"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#clean-session-data">clean session data</a></h4>
<h4 id="viewpy"><a class="toclink" href="../../2023/12/19/session-middleware-of-drf/#viewpy">view.py</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; 注销 &quot;&quot;&quot;</span>
    <span class="c1"># clean session</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/login/&quot;</span><span class="p">)</span>
</code></pre></div>
    <nav class="md-post__action">
      <a href="../../2023/12/19/session-middleware-of-drf/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-12-19 00:00:00">December 19, 2023</time>
          <!-- start customization -->
          
          <!-- end customization --></li>
        
        
          
          <li class="md-meta__item">
            
              13 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="reference"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/">reference</a></h2>
<h3 id="django-rest-api"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#django-rest-api">Django REST API</a></h3>
<h4 id="udemy"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#udemy">| Udemy]]</a></h4>
<h2 id="kickstart"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#kickstart">KickStart</a></h2>
<h3 id="managepy-command-line"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#managepy-command-line">manage.py command line</a></h3>
<h4 id="runserver"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#runserver">runserver</a></h4>
<h4 id="makemigrations"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#makemigrations">makemigrations</a></h4>
<ol>
<li>create a new migration plan</li>
</ol>
<h4 id="migrate"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#migrate">migrate</a></h4>
<h4 id="createsuperuser"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#createsuperuser">createsuperuser</a></h4>
<h4 id="startapp"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#startapp">startapp</a></h4>
<ol>
<li>create a new app/rest API</li>
</ol>
<h4 id="shell"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#shell">shell</a></h4>
<h4 id="help"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#help">help</a></h4>
<h3 id="admin-url-for-admin-user"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#admin-url-for-admin-user">/admin URL for admin user</a></h3>
<h3 id="a-django-app"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#a-django-app">A django APP</a></h3>
<h4 id="an-app-in-a-django-project-is-a-python-package-that-does-a-particular-job-a-django-project-contains-one-or-more-apps-and-each-of-them-handles-a-particular-task-for-example-a-django-blog-website-will-have-a-list-of-posts-user-authentication-user-profiles-etc-the-best-practice-is-to-create-different-apps-for-each-one-of-them"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#an-app-in-a-django-project-is-a-python-package-that-does-a-particular-job-a-django-project-contains-one-or-more-apps-and-each-of-them-handles-a-particular-task-for-example-a-django-blog-website-will-have-a-list-of-posts-user-authentication-user-profiles-etc-the-best-practice-is-to-create-different-apps-for-each-one-of-them">An app in a Django project is a Python package that does a particular job. A Django project contains one or more apps and each of them handles a particular task. For example, a Django blog website will have a list of posts, user authentication, user profiles, etc. The best practice is to create different apps for each one of them.</a></h4>
<h4 id="apps-are-meant-to-be-portable-and-can-be-shared-between-different-projects-for-example-a-django-e-commerce-website-and-a-django-blog-website-both-will-have-user-authentication-you-can-make-a-single-app-for-user-authentication-and-share-it-between-different-django-projects"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#apps-are-meant-to-be-portable-and-can-be-shared-between-different-projects-for-example-a-django-e-commerce-website-and-a-django-blog-website-both-will-have-user-authentication-you-can-make-a-single-app-for-user-authentication-and-share-it-between-different-django-projects">Apps are meant to be portable and can be shared between different projects. For example, a Django e-commerce website and a Django blog website both will have user authentication. You can make a single app for user authentication and share it between different Django projects.</a></h4>
<h4 id="create-a-new-app"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#create-a-new-app">create a new APP</a></h4>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>manage.py<span class="w"> </span>startapp<span class="w"> </span><span class="o">[</span>app<span class="w"> </span>name<span class="o">]</span>
</code></pre></div>
<h3 id="project-structure"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#project-structure">Project structure</a></h3>
<h4 id="project-structure_1"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#project-structure_1"><a href="https://miro.medium.com/max/700/1*aICZBUzrgLgc5GoWuiFHcw.jpeg">project structure</a></a></h4>
<h4 id="managepy-file-provides-a-command-line-utility-for-a-django-project"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#managepy-file-provides-a-command-line-utility-for-a-django-project">`manage.py~ file provides a command-line utility for a Django project.</a></h4>
<p>*** <sub>asgi</sub> stands for <em>Asynchronous Server Gateway Interface</em> and ~wsgi` stands for *Web Server Gateway Interface.*</p>
<ol>
<li>
<p>After your development process is completed, you will move to
    production and hosting. For hosting you will
    use ~asgi~ or ~wsgi~ compatible servers. According to the type
    of server you use, you have to import middleware accordingly.</p>
</li>
<li>
<p>~asgi.py~ enables ASGI compatible servers and ~wsgi.py~ enables
    WSGI compatible servers to serve your Django web app.</p>
</li>
</ol>
<h4 id="settingspy"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#settingspy">settings.py</a></h4>
<ol>
<li>
<p>This is the main configuration file for a Django project. This is
    the main settings file and here you will configure all the apps and
    middleware for your project.</p>
</li>
<li>
<p>This file also handles the database settings. By default Django uses
    sqlite3. But if you use a different database, which you will most
    probably do, you will configure it in ~settings.py~.</p>
</li>
<li>
<p>~settings.py~ also handles templates, static files, and media
    files related settings.</p>
</li>
</ol>
<h4 id="urlspy"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#urlspy">urls.py</a></h4>
<ol>
<li>URLs are different endpoints of your website. ~urls.py~ contains
    the URL configurations for your website. By
    default, ~urls.py~ comes with the URL pattern for the admin panel.
    You will create other endpoints for your web app in this file.</li>
</ol>
<h4 id="inside-your-app"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#inside-your-app">Inside your APP</a></h4>
<ol>
<li>
<p>admin.py</p>
<ol>
<li>
<p>This file is used to register the models in your app in the
    Django administration. You will use this file to display the
    models of your app in the admin panel.</p>
</li>
<li>
<p>e.g. register article</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Article</span>

<span class="c1"># Register article models here.</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Article</span><span class="p">)</span>
</code></pre></div>
</li>
</ol>
</li>
<li>
<p>app.py</p>
<ol>
<li>It is a common configuration file for all Django apps. You can
    configure the attributes for your app using this file. However,
    the default configuration is sufficient for most cases. So,
    adding app configuration is a rare case.</li>
</ol>
</li>
<li>
<p>~migrations~ folder</p>
<ol>
<li>Once you start making changes in your database,
    the ~migrations~ folder will be populated with the records for
    all those migrations.</li>
</ol>
</li>
<li>
<p>models.py</p>
</li>
<li>
<p>You create your models in this
    file. <a href="https://docs.djangoproject.com/en/3.2/topics/db/models/">Models</a> define
    the database structure of your app. In ~models.py~ you basically
    create database tables for your app with proper relationships using
    Python classes.</p>
</li>
<li>
<p>~models.py~ is one of the most important files in your app. Django
    follows the MVT (Model-View-Template) design architecture. The 'M'
    represents models. So, models are one of the basic components of a
    Django app.</p>
</li>
<li>
<p>views.py</p>
<ol>
<li>
<p>is another important
    file. <a href="https://docs.djangoproject.com/en/3.2/topics/http/views/">Views</a> are
    the 'V' of MVT. Views provide an interface through which users
    interact with a Django website. It connects models and templates
    together.</p>
</li>
<li>
<p>In this file, you write the business logic for your app. A view
    can be either function-based or class-based. You decide if you
    want to write your views using functions or classes.</p>
</li>
<li>
<p>You can learn more about the MVT architecture from this article:</p>
</li>
<li>
<p><a href="https://python.plainenglish.io/the-mvt-design-pattern-of-django-8fd47c61f582">The MVT Design Pattern of
    Django</a></p>
</li>
</ol>
</li>
<li>
<p>tests.py</p>
<ol>
<li>is where you write test codes for your app. It is used to test
    the overall working of a Django app.</li>
</ol>
</li>
</ol>
<h4 id="other-folderfiles"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#other-folderfiles">Other folder/files</a></h4>
<ol>
<li>
<p>Templates</p>
<ol>
<li>
<p>django <strong>MVT</strong> *T*emplate</p>
</li>
<li>
<p>each app can have own template and the search sequence is
    defined same as how different app is loaded</p>
</li>
</ol>
</li>
<li>
<p>static</p>
<ol>
<li>
<p>css, js, images, json..</p>
</li>
<li>
<p><code>{% raw %}{% load static %}{% endraw %}</code> to load static files 👍</p>
</li>
<li>
<p><code>{% raw %}{% static  'css/bootstrap.css' %}{% endraw %}</code> to refer to those files</p>
</li>
</ol>
</li>
<li>
<p>urls.py in app</p>
<ol>
<li>if your application is complex, use a dedicatd url.py</li>
</ol>
</li>
<li>
<p>forms.py</p>
<ol>
<li>If your website expects to receive user inputs you need to
    use <a href="https://docs.djangoproject.com/en/3.2/topics/forms/">forms</a>.
    To work with forms in an app you need to create the <code>forms.py</code>
    file in that app. Here you will write the codes to handle forms.</li>
</ol>
</li>
</ol>
<h3 id="request-and-response-request-response-42"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#request-and-response-request-response-42">Request and response <a href="https://docs.djangoproject.com/en/4.2/ref/request-response/">Request &amp; Response 4.2</a></a></h3>
<h4 id="requests"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#requests">Requests</a></h4>
<ol>
<li>
<p>method, GET, POST (used for form submit)， META</p>
</li>
<li>
<p>Query parameters <code>/query/?id=123</code> #card</p>
<ol>
<li>
<p>request.Get.get('id')</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;id&quot;</span> <span class="na">value </span><span class="o">=</span> <span class="s">&quot;{{search_data}}&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="p">&gt;</span>search<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>
</li>
</ol>
</li>
</ol>
<h4 id="reponse"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#reponse">Reponse</a></h4>
<ol>
<li>HttpResponse; render; redirect</li>
</ol>
<h2 id="models"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#models">Models</a></h2>
<h3 id="default-and-autofield"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#default-and-autofield">Default and AutoField</a></h3>
<h4 id="bigautofield64bit-and-autofield"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#bigautofield64bit-and-autofield">BigAutoField(64bit) and AutoField</a></h4>
<h4 id="apppy-set-default-auto-field"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#apppy-set-default-auto-field">app.py set default auto field</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">default_auto_field</span> <span class="o">=</span> <span class="s2">&quot;django.db.models.BigAutoField&quot;</span>
</code></pre></div>
<ol>
<li>if default<sub>autofield</sub> present, each table will have <code>id</code> and you do
    not need to define aut-inc auto field</li>
</ol>
<h3 id="foreignkey-and-auto-join"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#foreignkey-and-auto-join">ForeignKey and auto join</a></h3>
<h4 id="define-a-foreigh-key-relationship-card"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#define-a-foreigh-key-relationship-card">define a foreigh key relationship #card</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">depart</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
  <span class="s2">&quot;Department&quot;</span><span class="p">,</span>
  <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span>
<span class="n">xx</span><span class="p">)</span>
<span class="c1"># table &quot;Department&quot;, to_field=&#39;id&#39;</span>
<span class="c1"># if &#39;id&#39; is default (auto_field) to_field can be ignore</span>
</code></pre></div>
<h2 id="card"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#card">card</a></h2>
<ol>
<li>
<p><code>django</code> will append <code>id</code> and create <code>depart_id</code> automatically from
    <code>depart</code> for foreign key #magic</p>
</li>
<li>
<p><code>on_delete</code> should be specified. Normally <code>CASCADE</code>, can also be
    <code>SET_NULL</code> if it is nullable</p>
</li>
</ol>
<h4 id="autojoin"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#autojoin">AutoJoin</a></h4>
<ol>
<li>
<p>Instead of join two table to get info from 2<sup>nd</sup> table like this</p>
<div class="highlight"><pre><span></span><code><span class="n">user</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">user_depart</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Department</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">depart_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</code></pre></div>
<p>Django know how two table are associated and We can dereference
department info with <code>depart</code> field directly without
<code>filter(id=user.depart_id)</code></p>
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">depart</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">depart</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
</li>
</ol>
<h3 id="enum-with-choices"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#enum-with-choices">enum with <code>choices</code></a></h3>
<h4 id="define-with-field_name_choices"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#define-with-field_name_choices">define with <code>{field_name}_choices</code></a></h4>
<div class="highlight"><pre><span></span><code><span class="n">gender_choices</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;Male&quot;</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Female&quot;</span><span class="p">)</span> <span class="p">)</span>
<span class="n">gender</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SmallIntegerField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">gender_choices</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<h4 id="when-retrieve-gender-value-it-will-be-but-it-can-be-display-nicely-with-magic-method-modelsget_field_name_display-eg-get_gender_display-will-show-malefemale"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#when-retrieve-gender-value-it-will-be-but-it-can-be-display-nicely-with-magic-method-modelsget_field_name_display-eg-get_gender_display-will-show-malefemale">when retrieve gender value, it will be &frac12;. But it can be display nicely with #magic method <code>models.get_{field_name}_display()</code> e.g. <code>get_gender_display()</code> will show <code>Male|Female</code></a></h4>
<h3 id="order_by"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#order_by"><code>order_by()</code></a></h3>
<h4 id="order_byfield_name"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#order_byfield_name"><code>order_by("field_name")</code></a></h4>
<h4 id="reverse-order-with-order_by-field_name"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#reverse-order-with-order_by-field_name">reverse order with <code>order_by("-field_name")</code></a></h4>
<p><strong>*</strong> <strong>*</strong></p>
<h3 id="filter-with-magic-naming"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#filter-with-magic-naming"><code>filter()</code> with magic naming</a></h3>
<h4 id="filter-with-field-and-value-field-name-myid-in-all-examples"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#filter-with-field-and-value-field-name-myid-in-all-examples">filter with field and value (field name : myid in all examples )</a></h4>
<h4 id="number-filter"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#number-filter">Number filter</a></h4>
<ol>
<li><code>filter(myid__gt=12)</code> -&gt; value &gt;12, You can also filter on
    <code>myid__lte</code> <code>myid_lt</code> etc</li>
</ol>
<h4 id="string-filter"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#string-filter">String filter</a></h4>
<ol>
<li><code>mytext__startwith</code>, <code>mytext__endwith</code>, <code>mytext__contains</code></li>
</ol>
<h4 id="multi-field-filter-filtermyid_gte12-mytext_contains123"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#multi-field-filter-filtermyid_gte12-mytext_contains123">Multi field filter : <code>filter(myid_gte=12, mytext_contains="123")</code></a></h4>
<h3 id="pagination"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#pagination">pagination</a></h3>
<p><strong>*</strong></p>
<h2 id="django-template"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#django-template">Django Template</a></h2>
<h3 id="abstract"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#abstract">Abstract</a></h3>
<h4 id="a-template-is-a-text-file-it-can-generate-any-text-based-format-html-xml-csv-etc"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#a-template-is-a-text-file-it-can-generate-any-text-based-format-html-xml-csv-etc">A template is a text file. It can generate any text-based format (HTML, XML, CSV, etc.).</a></h4>
<h4 id="a-template-contains-variables-which-get-replaced-with-values-when-the-template-is-evaluated-and-tags-which-control-the-logic-of-the-template"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#a-template-contains-variables-which-get-replaced-with-values-when-the-template-is-evaluated-and-tags-which-control-the-logic-of-the-template">A template contains *variables*, which get replaced with values when the template is evaluated, and *tags*, which control the logic of the template.</a></h4>
<h3 id="-"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#-">-----</a></h3>
<h4 id="main-idea-checkbox"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#main-idea-checkbox">:main-idea-checkbox:</a></h4>
<ul>
<li>What is this aims?</li>
<li>What is the their research question?</li>
<li>What is the author arguing?</li>
<li>What is their answer to the question?</li>
<li>What points support their argument?</li>
<li>What are their main reasons?</li>
<li>What evidence have they used to support their argument?</li>
<li>What&rsquo;s the significance of these facts?</li>
<li>What principle are they based on?</li>
<li>How can I apply them?  How do they fit in with what I already know?</li>
<li>What&rsquo;s beyond them?</li>
<li>What're supporting details and explanations?</li>
</ul>
<p>::: {.END .drawer}
:::</p>
<h4 id="cheatsheet"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#cheatsheet">Cheatsheet</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;template_file.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;var1&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;var2&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">})</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="cp">{{</span> <span class="nv">var1</span> <span class="cp">}}</span>
<span class="cp">{{</span> <span class="nv">listVar.1</span> <span class="cp">}}</span><span class="x"> &lt;!-- listVar[0] --&gt;</span>
<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% for item in lst %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span><span class="x">  &lt;!-- loop list --&gt;</span>
<span class="x">&lt;span&gt; </span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x"> &lt;/span&gt;</span>
<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% endfor %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>

<span class="x">&lt;span&gt; </span><span class="cp">{{</span> <span class="nv">dict</span> <span class="cp">}}</span><span class="x"> &lt;/span&gt; &lt;!-- object  --&gt;</span>
<span class="x">&lt;span&gt; </span><span class="cp">{{</span> <span class="nv">dict.name</span> <span class="cp">}}</span><span class="x"> &lt;/span&gt; &lt;!-- object attribute --&gt;</span>

<span class="cp">{{</span> <span class="nv">list.1.name</span> <span class="cp">}}</span><span class="x">  &lt;!-- list[1].name</span>
</code></pre></div>
<p>Loop and condition</p>
<div class="highlight"><pre><span></span><code><span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% for item in dict.keys %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span><span class="x">  &lt;!-- loop object  --&gt;</span>
<span class="x">&lt;span&gt; </span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x"> &lt;/span&gt;</span>
<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% endfor %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% for k, v in dict.items %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span><span class="x">  &lt;!-- loop object  --&gt;</span>
<span class="x">&lt;span&gt; </span><span class="cp">{{</span> <span class="nv">k</span> <span class="cp">}}</span><span class="x"> = </span><span class="cp">{{</span> <span class="nv">v</span> <span class="cp">}}</span><span class="x"> &lt;/span&gt;</span>
<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% endfor %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% if n == &#39;xxx&#39; %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
<span class="x">&lt;h1&gt; xxxx &lt;/h1&gt;</span>
<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% elif n == &quot;XXX&quot; %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
<span class="x">&lt;h1&gt; XXX &lt;/h1&gt;</span>
<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% else %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
<span class="x">&lt;h1&gt; ssss &lt;/h1&gt;</span>
<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% endif %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
</code></pre></div>
<h4 id="template-tags-raw-endraw-generally-do-not-require-double-curly-braces-or-quotes-for-variable-names-as-they-inherently-expect-python-like-syntax"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#template-tags-raw-endraw-generally-do-not-require-double-curly-braces-or-quotes-for-variable-names-as-they-inherently-expect-python-like-syntax">Template tags <code>{% raw %}{% ... %}{% endraw %}</code> generally do not require double curly braces or quotes for variable names, as they inherently expect Python-like syntax.</a></h4>
<h4 id="value-titledefaultdepart-name-or-value-titledefaultdepart-name"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#value-titledefaultdepart-name-or-value-titledefaultdepart-name"><code>value="{{ title|default:'depart name' }}"</code> or <code>value={{ title|default:'depart name' }}</code></a></h4>
<ol>
<li>double quotes is strongly recommended</li>
</ol>
<h4 id="call-a-function-inside-or-raw-endraw"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#call-a-function-inside-or-raw-endraw">Call a function inside <code>{{}}</code> or <code>{% raw %}{% %}{% endraw %}</code></a></h4>
<ol>
<li>
<p><code>{{ obj.get_gender_display() }}</code> is invalid. You can not call a
    function with <code>()</code> inside <code>{{}}</code>, use <code>{{ obj.get_gender_display }}</code>
    instead</p>
</li>
<li>
<p>How about arguments? see ((651c1c60-a6bd-47c4-9b9a-889f3d41cf5f))</p>
</li>
</ol>
<h3 id="template-extends"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#template-extends">Template extends</a></h3>
<h4 id="extends-tag-is-used-for-inheritance-of-templates-in-django-one-needs-to-repeat-the-same-code-again-and-again-using-extends-we-can-inherit-templates-as-well-as-variables"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#extends-tag-is-used-for-inheritance-of-templates-in-django-one-needs-to-repeat-the-same-code-again-and-again-using-extends-we-can-inherit-templates-as-well-as-variables"><code>extends</code> tag is used for inheritance of templates in django. One needs to repeat the same code again and again. Using extends we can inherit templates as well as variables.</a></h4>
<h4 id="syntax"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#syntax">syntax</a></h4>
<div class="highlight"><pre><span></span><code>{% raw %}{% extends &#39;template_name.html&#39; %}{% endraw %}

# examples
{% raw %}{% extends &quot;./base2.html&quot; %}{% endraw %}
{% raw %}{% extends &quot;../base1.html&quot; %}{% endraw %}
{% raw %}{% extends &quot;./my/base3.html&quot; %}{% endraw %}
</code></pre></div>
<h4 id="extends-examples"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#extends-examples">extends examples</a></h4>
<ol>
<li>
<p>template.html</p>
<div class="highlight"><pre><span></span><code><span class="x">&lt;h1&gt;Main Template&lt;/h1&gt;</span>
<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% block content %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% endblock %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
</code></pre></div>
</li>
<li>
<p>extends.html overwrite block: content</p>
<div class="highlight"><pre><span></span><code><span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% extends &quot;template.html&quot; %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% block content %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
<span class="x">&lt;h2&gt; GeeksForGeeks is the Best</span>
<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% endblock %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
</code></pre></div>
</li>
<li>
<p>block can extends anything, e.g css reference, js code blocks etc</p>
</li>
</ol>
<h3 id="pipe-operator-and-filter"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#pipe-operator-and-filter">pipe operator <code>|</code> and filter</a></h3>
<h4 id="in-django-template-language-the-pipe-character-is-used-to-apply-filters-to-variables-filters-are-used-to-format-variables-or-perform-some-operation-on-them-before-they-are-rendered-in-the-template"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#in-django-template-language-the-pipe-character-is-used-to-apply-filters-to-variables-filters-are-used-to-format-variables-or-perform-some-operation-on-them-before-they-are-rendered-in-the-template">In Django template language, the pipe character <code>|</code> is used to apply filters to variables. Filters are used to format variables or perform some operation on them before they are rendered in the template.</a></h4>
<h4 id="syntax_1"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#syntax_1">Syntax</a></h4>
<div class="highlight"><pre><span></span><code><span class="cp">{{</span> <span class="nv">variable</span><span class="o">|</span><span class="nf">filter_name</span><span class="s2">:&quot;argument&quot;</span> <span class="cp">}}</span>
<span class="x">Sample:</span>
<span class="cp">{{</span> <span class="nv">my_list</span><span class="o">|</span><span class="nf">join</span><span class="s2">:&quot;, &quot;</span><span class="o">|</span><span class="nf">escape</span> <span class="cp">}}</span>
</code></pre></div>
<ol>
<li><code>|join:", "</code>: The <code>join</code> filter concatenates items in the list into
    a single string, using ~, ~(comma and space) as a separator.</li>
</ol>
<h4 id="as-function-call-with-parameter-is-not-allowed-inside-template-do-this-instead"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#as-function-call-with-parameter-is-not-allowed-inside-template-do-this-instead">As function call with parameter is not allowed inside template, do this instead</a></h4>
<div class="highlight"><pre><span></span><code><span class="x">&lt;td class=&quot;py-2 px-4&quot;&gt;</span><span class="cp">{{</span> <span class="nv">obj.create_time.strftime</span><span class="o">(</span><span class="s1">&#39;%Y-%m-%d&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&lt;/td&gt;</span>
<span class="x">Should be write as</span>
<span class="x">&lt;td class=&quot;py-2 px-4&quot;&gt;</span><span class="cp">{{</span> <span class="nv">obj.create_time</span> <span class="o">|</span> <span class="nf">date</span><span class="s1">:&#39;Y-m-d&#39;</span> <span class="cp">}}</span><span class="x">&lt;/td&gt;</span>
</code></pre></div>
<h3 id="include-another-template-file"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#include-another-template-file">include another template file</a></h3>
<h4 id="tophtml"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#tophtml">top.html</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class </span><span class="o">=</span> <span class="s">&#39;{{ mycss }}&#39;</span><span class="p">&gt;</span> this is header <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>
<h4 id="indexhtml"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#indexhtml">index.html</a></h4>
<div class="highlight"><pre><span></span><code><span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">&lt;html lang=&quot;en&quot;&gt;</span>
<span class="x">&lt;head&gt;</span>
<span class="x">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span>
<span class="x">    &lt;title&gt;Title&lt;/title&gt;</span>
<span class="x">&lt;/head&gt;</span>
<span class="x">&lt;body&gt;</span>

<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% include &#39;top.html&#39; with mycss=&quot;acss&quot; %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>

<span class="x">&lt;h2&gt; 网页body部分 &lt;/h2&gt;</span>

<span class="x">&lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</code></pre></div>
<h4 id="include-passing-multiple-values"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#include-passing-multiple-values">include passing multiple values</a></h4>
<div class="highlight"><pre><span></span><code><span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% include &quot;name_snippet.html&quot; with person=&quot;Jane&quot; greeting=&quot;Hello&quot; %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
</code></pre></div>
<p>And with django variables from python codes</p>
<div class="highlight"><pre><span></span><code><span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% extends &#39;base.html&#39; %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% block panel %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% include &#39;form.html&#39; with title=title id=id %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% endblock %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
</code></pre></div>
<h2 id="form"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#form">Form</a></h2>
<h3 id="djangos-form-functionality-can-simplify-and-automate-vast-portions-of-this-work-and-can-also-do-it-more-securely-than-most-programmers-would-be-able-to-do-in-code-they-wrote-themselves"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#djangos-form-functionality-can-simplify-and-automate-vast-portions-of-this-work-and-can-also-do-it-more-securely-than-most-programmers-would-be-able-to-do-in-code-they-wrote-themselves">Django&rsquo;s form functionality can simplify and automate vast portions of this work, and can also do it more securely than most programmers would be able to do in code they wrote themselves.</a></h3>
<h4 id="django-handles-three-distinct-parts-of-the-work-involved-in-forms"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#django-handles-three-distinct-parts-of-the-work-involved-in-forms">Django handles three distinct parts of the work involved in forms:</a></h4>
<h4 id="preparing-and-restructuring-data-to-make-it-ready-for-rendering"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#preparing-and-restructuring-data-to-make-it-ready-for-rendering">preparing and restructuring data to make it ready for rendering</a></h4>
<h4 id="creating-html-forms-for-the-data"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#creating-html-forms-for-the-data">creating HTML forms for the data</a></h4>
<h4 id="receiving-and-processing-submitted-forms-and-data-from-the-client"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#receiving-and-processing-submitted-forms-and-data-from-the-client">receiving and processing submitted forms and data from the client</a></h4>
<h4 id="flowchart-1"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#flowchart-1"><a href="https://media.geeksforgeeks.org/wp-content/uploads/20200107124202/flowChart-1-1024x682.png">flowChart-1</a></a></h4>
<h3 id="create-a-form"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#create-a-form">Create a form</a></h3>
<h4 id="how-to-create-a-formclass-card"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#how-to-create-a-formclass-card">How to create a FormClass #card</a></h4>
<ol>
<li>
<p>Sample</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>

<span class="k">class</span> <span class="nc">FormName</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
         <span class="c1"># each field would be mapped as an input field in HTML</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
</code></pre></div>
<h2 id="card-card"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#card-card">card #card</a></h2>
</li>
</ol>
<h4 id="form-class-sample"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#form-class-sample">Form class sample</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">roll_number</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span>
                    <span class="n">help_text</span> <span class="o">=</span> <span class="s2">&quot;Enter 6 digit roll number&quot;</span>
                    <span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">widget</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">PasswordInput</span><span class="p">())</span>
</code></pre></div>
<ol>
<li>Note if field defined as <code>auto</code> (<code>auto_now</code>, <code>auto_now_add</code>), it may
    not shown in Form</li>
</ol>
<h4 id="form-viewpy"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#form-viewpy">Form view.py</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">InputForm</span>
<span class="k">def</span> <span class="nf">home_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span><span class="p">{}</span>
    <span class="n">context</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">InputForm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;home.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre></div>
<h4 id="render-in-template"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#render-in-template">Render in template</a></h4>
<ol>
<li>
<p>A form comes with 3 in-built methods that can be used to render
    Django form fields.</p>
</li>
<li>
<p><a href="https://www.geeksforgeeks.org/form-as_table-render-django-forms-as-table/"><code>{{ form.as_table }}</code></a> will
    render them as table cells wrapped in \&lt;tr&gt; tags</p>
</li>
<li>
<p><a href="https://www.geeksforgeeks.org/form-as_p-render-django-forms-as-paragraph/"><code>{{ form.as_p }}</code></a> will
    render them wrapped in \&lt;p&gt; tags</p>
</li>
<li>
<p><a href="https://www.geeksforgeeks.org/form-as_ul-render-django-forms-as-list/"><code>{{ form.as_ul }}</code></a> will
    render them wrapped in \&lt;li&gt; tags</p>
</li>
</ol>
<h4 id="template"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#template">Template:</a></h4>
<p>There are a few ways to present form objects</p>
<ul>
<li>Field by field</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">form</span> <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;post&quot;</span><span class="o">&gt;</span>
    <span class="p">{{</span> <span class="n">form</span><span class="o">.</span><span class="n">first_name</span> <span class="p">}}</span>
    <span class="p">{{</span> <span class="n">form</span><span class="o">.</span><span class="n">last_name</span> <span class="p">}}</span>
    <span class="p">{{</span> <span class="n">form</span><span class="o">.</span><span class="n">phone_number</span> <span class="p">}}</span>
    <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">value</span><span class="o">=</span><span class="n">Submit</span><span class="s2">&quot;&gt;</span>
<span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
</code></pre></div>
<ul>
<li>Loop</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="x">&lt;form action = &quot;&quot; method = &quot;post&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% csrf_token %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% for field in form %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">field</span> <span class="cp">}}</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% endfor %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
<span class="x">    &lt;input type=&quot;submit&quot; value=Submit&quot;&gt;</span>
<span class="x">&lt;/form&gt;</span>
</code></pre></div>
<ul>
<li><code>{{ form }}</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="x">&lt;form action = &quot;&quot; method = &quot;post&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% csrf_token %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">form</span> <span class="cp">}}</span>
<span class="x">    &lt;input type=&quot;submit&quot; value=Submit&quot;&gt;</span>
<span class="x">&lt;/form&gt;</span>
</code></pre></div>
<h3 id="validate-a-form-object"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#validate-a-form-object">Validate a form object</a></h3>
<h4 id="the-easiest-way-to-validate-a-single-field-is-to-override-the-method-clean_fieldname-for-the-field-you-want-to-check-eg-validate-renewal_date-field"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#the-easiest-way-to-validate-a-single-field-is-to-override-the-method-clean_fieldname-for-the-field-you-want-to-check-eg-validate-renewal_date-field">The easiest way to validate a single field is to override the method <code>clean_&lt;fieldname&gt;()</code> for the field you want to check. e.g. Validate <code>renewal_date</code> field</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">gettext_lazy</span> <span class="k">as</span> <span class="n">_</span>
<span class="k">class</span> <span class="nc">RenewBookForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">renewal_date</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Enter a date between now and 4 weeks (default 3).&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean_renewal_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;renewal_date&#39;</span><span class="p">]</span>
        <span class="c1"># Check if a date is not in the past.</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid date - renewal in past&#39;</span><span class="p">))</span>

        <span class="c1"># Check if a date is in the allowed range (+4 weeks from today).</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid date - renewal more than 4 weeks ahead&#39;</span><span class="p">))</span>

        <span class="c1"># Remember to always return the cleaned data.</span>
        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>
<h3 id="django-form-from-models"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#django-form-from-models">Django Form from Models</a></h3>
<h4 id="if-the-form-is-coupled-with-database-table-it-is-easy-to-use-modelform"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#if-the-form-is-coupled-with-database-table-it-is-easy-to-use-modelform">If the form is coupled with database table, it is easy to use ModelForm</a></h4>
<h4 id="models_1"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#models_1">Models</a></h4>
<ol>
<li>
<p>Sample:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">movie_title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">release_year</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">director</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">movie_poster</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s1">&#39;images/&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">movie_plot</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">movie_title</span>  <span class="c1"># when print movie object it shows title. Also useful</span>
        <span class="c1">#when movie object is showed in dropdown etc</span>
</code></pre></div>
</li>
<li>
<p>FieldValidator</p>
<ol>
<li>
<p><code>django.core.validators</code></p>
<div class="highlight"><pre><span></span><code><span class="n">mobile</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;mobile number&quot;</span>
    <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">RegexValidator</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^159[0-9]+$&#39;</span><span class="p">,</span> <span class="s1">&#39;mobile start with 159&#39;</span><span class="p">)</span> <span class="p">],</span>
<span class="p">)</span>
</code></pre></div>
</li>
</ol>
</li>
<li>
<p>A <strong>disabled</strong> field</p>
<ol>
<li>For read only field set <code>disabled=True</code>, e.g.
    <code>mobile = forms.CharField(disabled=True, label='mobile number')</code></li>
</ol>
</li>
</ol>
<h4 id="create-modelform-class"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#create-modelform-class">Create ModelForm class</a></h4>
<ol>
<li>
<p>How to create a ModelForm Class #card</p>
<ol>
<li>
<p>Code</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Movie</span>

<span class="k">class</span> <span class="nc">MovieForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Movie</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;movie_title&#39;</span><span class="p">,</span> <span class="s1">&#39;release_year&#39;</span><span class="p">,</span> <span class="s1">&#39;director&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_poster&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_plot&#39;</span><span class="p">)</span>
</code></pre></div>
</li>
</ol>
</li>
<li>
<p>Sample</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Movie</span>


<span class="c1"># Create your forms here.</span>
<span class="k">class</span> <span class="nc">MovieForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Movie</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;movie_title&#39;</span><span class="p">,</span> <span class="s1">&#39;release_year&#39;</span><span class="p">,</span> <span class="s1">&#39;director&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_poster&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_plot&#39;</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p>The <code>Meta</code> class is used to change the behavior of the <code>ModelForm</code> .
    Within it, specify the model your fields come from and the fields
    you want to use from that model.</p>
</li>
<li>
<p>Key components of <code>Meta</code> class in ModelForm #card</p>
<ol>
<li>
<p>model the data model class</p>
</li>
<li>
<p>fields: the fields will be shown in the form</p>
</li>
<li>
<p>widgets: used to generate HTML code that override default
    behavior. e.g. inputbox with CSS styling</p>
</li>
</ol>
</li>
<li>
<p>Explains of Meta class</p>
<ul>
<li><code>model</code> The Model class</li>
<li><code>fields</code> It is strongly recommended that you explicitly set all
    fields that should be edited in the form using the fields
    attribute. Failure to do so can easily lead to security problems
    when a form unexpectedly allows a user to set certain fields,
    especially when new fields are added to a model. If those are
    not your concerns ~fields = "[[all]{.underline}]{.underline}"
    ~ can easy your job</li>
<li><code>exclude</code> Set the exclude attribute of the ModelForm&rsquo;s inner
    Meta class to a list of fields to be excluded from the form.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PartialAuthorForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Author</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
</code></pre></div>
<ul>
<li><code>field_classes</code> or formfield<sub>callback</sub> can be used to customize
    the type of fields instantiated by the form.</li>
<li><code>widgets</code>: override default <code>forms.TextInput</code>, It is helpful if
    you need setup <code>css</code> e.g.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PartialAuthorForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Author</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
        <span class="n">widgets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">forms</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">TextInput</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;form-control&quot;</span><span class="p">}),</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">forms</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">PasswordInput</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;form-control&quot;</span><span class="p">}),</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">forms</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">NumberInput</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;form-control&quot;</span><span class="p">}),</span>
            <span class="s2">&quot;account&quot;</span><span class="p">:</span> <span class="n">forms</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">NumberInput</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;form-control&quot;</span><span class="p">}),</span>
            <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="n">forms</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">Select</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;form-control&quot;</span><span class="p">}),</span>
        <span class="p">}</span>
</code></pre></div>
<ul>
<li>If you want to apply same attributes for all field, do this
    instead by override <code>__init__</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">UserModelForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">style</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Make the password field optional</span>
                <span class="n">field</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">PasswordInput</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">style</span><span class="p">})</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">UserInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s2">&quot;__all__&quot;</span> <span class="c1"># It can be a list of all fields you want to display</span>
     <span class="c1"># password field can also be setup here</span>
     <span class="c1"># password = forms.CharField(required=False, widget=forms.PasswordInput()) # some field need special attention</span>
     <span class="c1"># can also  be put here</span>
</code></pre></div>
<ul>
<li>Error messages</li>
</ul>
<p>You can reuse the default error messages. In case the message need
to be customered for specific field</p>
<div class="highlight"><pre><span></span><code><span class="n">error_messages</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="s2">&quot;用户名不能为空, 并且不能重复&quot;</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="s2">&quot;年龄不能为空， 并且应该处于0~140&quot;</span><span class="p">,</span>
      <span class="p">},</span>
  <span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>Add New field to ModelForm</p>
<ol>
<li>
<p>e.g. Add password confirm input field</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">UserModelForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
  <span class="n">confirm_password</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;please input password again&quot;</span><span class="p">,</span>
        <span class="n">widget</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">PasswordInput</span><span class="p">(</span><span class="n">render_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">style</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Make the password field optional</span>
                <span class="n">field</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">PasswordInput</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">style</span><span class="p">})</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">UserInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s2">&quot;__all__&quot;</span>
</code></pre></div>
</li>
<li>
<p><code>render_values</code> allow pre-fill values</p>
</li>
</ol>
</li>
</ol>
<h4 id="the-html-template"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#the-html-template">The html template</a></h4>
<div class="highlight"><pre><span></span><code><span class="x">&lt;form method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">raw</span> <span class="cp">%}</span>{% csrf_token %}<span class="cp">{%</span> <span class="k">endraw</span> <span class="cp">%}</span>
<span class="x">      </span><span class="cp">{{</span><span class="nv">movie_form</span><span class="cp">}}</span>
<span class="x">      &lt;button class=&quot;btn btn-primary my-4&quot; type=&quot;submit&quot;&gt;Submit&lt;/button&gt;</span>
<span class="x">&lt;/form&gt;</span>
</code></pre></div>
<h4 id="for-651b71c9-7e23-4638-a89c-240b474388a8-add-__str__"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#for-651b71c9-7e23-4638-a89c-240b474388a8-add-__str__">For ((651b71c9-7e23-4638-a89c-240b474388a8)) Add <code>__str__</code></a></h4>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Department</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Department&quot;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
</code></pre></div>
<p>So that when adding user's department in the dropdown, it will show the
<code>title</code> instead of "Python Object"</p>
<h4 id="create-a-modelform-object-card"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#create-a-modelform-object-card">Create a ModelForm object #card</a></h4>
<ol>
<li>
<p>an empyt object (create a new entry) <code>form = UserModelForm()</code></p>
</li>
<li>
<p>From a POST request (for parse form submit and save data)
    <code>form = userModelForm(request.POST)</code></p>
</li>
<li>
<p>From database instance (foir re-edit data)
    <code>form = UserModelForm(instance=models.User.objects.filter(id=id).first())</code></p>
</li>
<li>
<p>From both POST and database (normally when reedit data when form
    submission failed)
    <code>form = UserModelForm(request.POST, instance=models.User.objects.filter(id=id).first())</code></p>
</li>
</ol>
<h4 id="save-modelform"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#save-modelform">Save ModelForm(),</a></h4>
<ol>
<li>
<p>You can either parse the POST request and get all fields, You can
    Also do:</p>
<div class="highlight"><pre><span></span><code><span class="n">form</span> <span class="o">=</span> <span class="n">UserModelForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>  <span class="c1"># POST to form class</span>
<span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
    <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  <span class="c1"># save to DB</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/user/list/&quot;</span><span class="p">)</span>
<span class="c1"># invalid data auto refill the form and you can re-send again</span>
<span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;user_add.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>
</code></pre></div>
</li>
</ol>
<h4 id="handle-form-errors"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#handle-form-errors">Handle form errors</a></h4>
<p><strong>**</strong></p>
<h2 id="pagination_1"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#pagination_1">Pagination</a></h2>
<h3 id="with-python-slicing-startend"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#with-python-slicing-startend">with python slicing <code>[start:end]</code></a></h3>
<div class="highlight"><pre><span></span><code><span class="n">qs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Users</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="n">qs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Users</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">123</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
<span class="n">qs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Users</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">123</span><span class="p">)[</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span>

<span class="n">qs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Users</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span>
<span class="n">qs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Users</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)[</span><span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">]</span>

<span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">qs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Users</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)[(</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">page_size</span><span class="p">:</span><span class="n">page</span><span class="o">*</span><span class="n">page_size</span><span class="p">]</span>
</code></pre></div>
<h3 id="django-template_1"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#django-template_1">django template</a></h3>
<div class="highlight"><pre><span></span><code><span class="x">&lt;ul class=&#39;pagination&#39;&gt;</span>
<span class="x">  &lt;li&gt;&lt;a href=&quot;?page=1&quot;&gt;1&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">  &lt;li&gt;&lt;a href=&quot;?page=2&quot;&gt;2&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">&lt;/ul&gt;</span>
</code></pre></div>
<h3 id="pagination-generate-by-python"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#pagination-generate-by-python">Pagination generate by python</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>
<span class="o">...</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Users</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">total_pages</span> <span class="o">=</span> <span class="n">totla</span><span class="o">//</span><span class="n">page_size</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">cur_page</span> <span class="o">-</span> <span class="mi">5</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">cur_page</span> <span class="o">+</span> <span class="mi">5</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
  <span class="n">sel</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
  <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">page</span><span class="p">:</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;active&quot;&#39;</span>
  <span class="n">ele</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;li class=</span><span class="si">{</span><span class="n">sel</span><span class="si">}</span><span class="s1"> &gt;&lt;a href=&quot;?page=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot;&gt;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&lt;/a&gt;&lt;/li&gt;&#39;</span>
  <span class="n">page_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ele</span><span class="p">)</span>
<span class="n">page_string</span><span class="o">=</span><span class="n">mark_safe</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">page_list</span><span class="p">))</span>
<span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;list.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;queryset&quot;</span><span class="p">:</span> <span class="n">qs</span><span class="p">,</span> <span class="s2">&quot;page_list&quot;</span><span class="p">:</span> <span class="n">page_string</span><span class="p">})</span>
</code></pre></div>
<h3 id="template_1"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#template_1">Template</a></h3>
<div class="highlight"><pre><span></span><code><span class="x">&lt;ul class=&quot;pagination&quot;&gt;</span>
<span class="x">    &lt;li&gt;&lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">head_page</span> <span class="cp">}}</span><span class="x">&quot; aria-label=&quot;Previous&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;首页&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">page_string</span> <span class="cp">}}</span>
<span class="x">    &lt;li&gt;&lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">end_page</span> <span class="cp">}}</span><span class="x">&quot; aria-label=&quot;Next&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;尾页&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span>

<span class="x">&lt;/ul&gt;</span>
<span class="x">&lt;br&gt;</span>

<span class="x">&lt;form method=&quot;get&quot;&gt;</span>
<span class="x">    &lt;div style=&quot;display:inline-block; width: 150px;&quot;&gt;</span>
<span class="x">        &lt;div class=&quot;input-group&quot;&gt;</span>
<span class="x">            &lt;span&gt; &lt;input type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;请输入页码&quot; name=&quot;page&quot;&gt;&lt;/span&gt;</span>
<span class="x">            &lt;span class=&quot;input-group-btn&quot;&gt;</span>
<span class="x">                &lt;button class=&quot;btn btn-primary&quot; type=&quot;submit&quot;&gt;跳转&lt;/button&gt;</span>
<span class="x">            &lt;/span&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">&lt;/form&gt;</span>
</code></pre></div>
<h2 id="fbv-and-cbv"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#fbv-and-cbv">FBV and CBV</a></h2>
<h3 id="fbv-function-based-view"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#fbv-function-based-view">FBV: Function based View</a></h3>
<h4 id="sample"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#sample">sample</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">my_create_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
  <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;form.html&#39;</span>
  <span class="n">form_class</span> <span class="o">=</span> <span class="n">MyForm</span>

  <span class="n">form</span> <span class="o">=</span> <span class="n">form_class</span>

  <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">form_class</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
      <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;list-view&#39;</span><span class="p">))</span>
  <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
    <span class="k">return</span> <span class="o">...</span>
  <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>
<span class="c1"># url</span>
</code></pre></div>
<h3 id="cbv-class-based-view"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#cbv-class-based-view">CBV: Class based view</a></h3>
<h4 id="use-as_view-and-internally-use-dispatch"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#use-as_view-and-internally-use-dispatch">use <code>as_view()</code> and internally use <code>dispatch()</code></a></h4>
<h4 id="pros"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#pros">Pros</a></h4>
<ol>
<li>
<p>reuseablity by inherited another view</p>
</li>
<li>
<p>DRY</p>
</li>
<li>
<p>extendability</p>
</li>
</ol>
<h4 id="cons"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#cons">Cons</a></h4>
<ol>
<li>
<p>Implicit code flow</p>
</li>
<li>
<p>decorators require extra override</p>
</li>
</ol>
<h4 id="sample_1"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#sample_1">sample</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyCreateView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
  <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;form.html&#39;</span>
  <span class="n">form_class</span> <span class="o">=</span> <span class="n">MyForm</span>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
      <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">HttpResonseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;list-view&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>
<span class="c1"># URL</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^new/$&#39;</span><span class="p">,</span> <span class="n">MyCreateView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;original-create-view&#39;</span><span class="p">)</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^new_two/$&#39;</span><span class="p">,</span> <span class="n">MyCreateView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="n">template_name</span><span class="o">=</span><span class="s1">&#39;other_form.html&#39;</span><span class="p">,</span> <span class="n">form_class</span><span class="o">=</span><span class="s1">&#39;MyOtherForm&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;modified-create-view&#39;</span><span class="p">)</span>
  <span class="p">]</span>
</code></pre></div>
<h3 id="djangos-views-requirements"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#djangos-views-requirements">Django&rsquo;s views requirements:</a></h3>
<h4 id="callable-cbv-has-as_view"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#callable-cbv-has-as_view">callable. CBV has <code>as_view()</code></a></h4>
<h4 id="accept-httprequest-as-first-positional-argument"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#accept-httprequest-as-first-positional-argument">accept <code>HttpRequest</code> as first positional argument</a></h4>
<h4 id="return-httpresponse-or-raise-exception"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#return-httpresponse-or-raise-exception">return <code>HttpResponse</code> or raise exception</a></h4>
<h3 id="reference-django-class-based-views-vs-function-based-views-by-sarthak-kumar-medium"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#reference-django-class-based-views-vs-function-based-views-by-sarthak-kumar-medium">reference: <a href="https://medium.com/@ksarthak4ever/django-class-based-views-vs-function-based-view-e74b47b2e41b">Django : Class Based Views vs Function Based Views | by Sarthak Kumar | Medium</a></a></h3>
<h3 id="which-should-you-use"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#which-should-you-use">which should you use</a></h3>
<p><a href="https://miro.medium.com/v2/resize:fit:1400/1*1NgVsYmmLCiwXUy-uE0VLA.jpeg">what type of view should
use</a></p>
<h4 id="if-it-is-single-method-eg-get-only-use-fbv-otherwise-cbv"><a class="toclink" href="../../2023/12/19/template-and-form-of-drf/#if-it-is-single-method-eg-get-only-use-fbv-otherwise-cbv">If it is single method (e.g. Get only) use FBV otherwise CBV</a></h4>
    <nav class="md-post__action">
      <a href="../../2023/12/19/template-and-form-of-drf/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-12-19 00:00:00">December 19, 2023</time>
          <!-- start customization -->
          
          <!-- end customization --></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="open-source-projects"><a class="toclink" href="../../2023/12/19/django/">Open source projects</a></h2>
<h3 id="django-idcops-idcops-django"><a class="toclink" href="../../2023/12/19/django/#django-idcops-idcops-django"><a href="https://gitee.com/wenvki/django-idcops?_from=gitee_search#https://gitee.com/link?target=https%3A%2F%2Fgithub.com%2FWenvki%2Fdjango-idcops">django-idcops: idcops 是一个基于Django倾向于数据中心运营商而开发的，拥有数据中心、客户、机柜、设备、跳线、物品、测试、文档等一序列模块的资源管理平台。</a></a></h3>
<h3 id="bugadmin-django-bug"><a class="toclink" href="../../2023/12/19/django/#bugadmin-django-bug"><a href="https://gitee.com/plasticine9750/bug_admin?_from=gitee_search">bug<sub>admin</sub>: 老男孩django项目实战 &ndash; 轻量级bug管理平台</a></a></h3>
<h3 heading="2" id="django-2教程"><a class="toclink" href="../../2023/12/19/django/#django-2教程"><a href="https://space.bilibili.com/252028233/channel/seriesdetail?sid=1632774">Django 2教程 </a></a></h3>
<h3 id="pythonwebdjangobilibili"><a class="toclink" href="../../2023/12/19/django/#pythonwebdjangobilibili"><a href="https://www.bilibili.com/video/BV1rT4y1v7uQ">最新Python的web开发全家桶（django+前端+数据库）<sub>哔哩哔哩bilibili</sub></a></a></h3>
<h3 id="2022-python-20pythondjangovuebilibili"><a class="toclink" href="../../2023/12/19/django/#2022-python-20pythondjangovuebilibili"><a href="https://www.bilibili.com/video/BV14o4y1r7j1">2022 python 全新教程 20天【武沛齐最新录制】全栈开发(python基础+面向对象+django+vue）<sub>哔哩哔哩bilibili</sub></a></a></h3>
<h3 id="django-tutorial-blog"><a class="toclink" href="../../2023/12/19/django/#django-tutorial-blog">上述视频配套文档 <a href="https://poker.blog.csdn.net/?type=blog">Django tutorial blog</a></a></h3>
<h3 id="2023-python-bilibili"><a class="toclink" href="../../2023/12/19/django/#2023-python-bilibili"><a href="https://www.bilibili.com/video/BV1b94y1p7EM">【推荐】武沛齐老师2023年最新录制最新版 Python全栈开发教程 全套（下集）<sub>哔哩哔哩bilibili</sub></a></a></h3>
<h3 id="651762db-174b-4e1f-a603-893e71db2c312022-pythonweb-bilibili"><a class="toclink" href="../../2023/12/19/django/#651762db-174b-4e1f-a603-893e71db2c312022-pythonweb-bilibili"><a href="https://www.bilibili.com/video/BV1324y1f7iJ">((651762db-174b-4e1f-a603-893e71db2c31))2022 Python的web开发（完整版） 入门全套教程，零基础入门到项目实战<sub>哔哩哔哩bilibili</sub></a></a></h3>
<h2 id="doc-and-tutorial"><a class="toclink" href="../../2023/12/19/django/#doc-and-tutorial">Doc and tutorial</a></h2>
<h3 id="django-web-django"><a class="toclink" href="../../2023/12/19/django/#django-web-django"><a href="https://poker.blog.csdn.net/article/details/128716177?ydreferer=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzMTM5MTQ1L2NhdGVnb3J5XzEyMTI1NzEyLmh0bWw%3D?ydreferer=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzMTM5MTQ1L2NhdGVnb3J5XzEyMTI1NzEyLmh0bWw%3D">* Django web 开发(四) - Django项目实践</a></a></h3>
<h3 id="django-tutorial-blog_1"><a class="toclink" href="../../2023/12/19/django/#django-tutorial-blog_1"><a href="https://poker.blog.csdn.net/?type=blog">Django tutorial blog</a></a></h3>
<p>*</p>
    <nav class="md-post__action">
      <a href="../../2023/12/19/django/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-12-19 00:00:00">December 19, 2023</time>
          <!-- start customization -->
          
          <!-- end customization --></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="install"><a class="toclink" href="../../2023/12/19/fast-api/">install</a></h2>
<h3 id="github-setup-it-depends-rust-and-might-need-this"><a class="toclink" href="../../2023/12/19/fast-api/#github-setup-it-depends-rust-and-might-need-this">github setup, it depends rust and might need this:</a></h3>
<h4 id="64c9b153-f65d-4260-abe8-0b04a23afdb3"><a class="toclink" href="../../2023/12/19/fast-api/#64c9b153-f65d-4260-abe8-0b04a23afdb3">((64c9b153-f65d-4260-abe8-0b04a23afdb3))</a></h4>
<h4 id="cargo-install-locked-maturin-well-seems-this-need-to-install-separately-for-windows"><a class="toclink" href="../../2023/12/19/fast-api/#cargo-install-locked-maturin-well-seems-this-need-to-install-separately-for-windows"><code>cargo install --locked maturin</code> well seems this need to install separately for windows</a></h4>
<h4 id="beginsrc-shell"><a class="toclink" href="../../2023/12/19/fast-api/#beginsrc-shell">#+BEGIN<sub>SRC</sub> shell</a></h4>
<p>pacman -S mingw-w64-clang-x86<sub>64</sub>-python-installer
mingw-w64-clang-x86<sub>64</sub>-python-wheel \
mingw-w64-clang-x86<sub>64</sub>-python-setuptools-rust
mingw-w64-clang-x86<sub>64</sub>-python-build</p>
<p>python -m venv &ndash;system-site-packages venv3</p>
<div class="highlight"><pre><span></span><code>#+END_SRC
</code></pre></div>
<h4 id="pip-install-fastapiall"><a class="toclink" href="../../2023/12/19/fast-api/#pip-install-fastapiall"><code>pip install "fastapi[all]"</code></a></h4>
<p>* *</p>
    <nav class="md-post__action">
      <a href="../../2023/12/19/fast-api/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-12-19 00:00:00">December 19, 2023</time>
          <!-- start customization -->
          
          <!-- end customization --></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="python-fundamental"><a class="toclink" href="../../2023/12/19/python-fundamental/">Python Fundamental</a></h2>
<ul>
<li>Fundamental of Python, a Jump start</li>
<li><a href="https://leetcode.com/discuss/study-guide/2122306/Python-Cheat-Sheet-for-Leetcode">Python Cheat Sheet for Leetcode - LeetCode Discuss</a></li>
<li>Create a list with size:<ul>
<li>python
  <div class="highlight"><pre><span></span><code><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
<span class="p">[]</span> <span class="o">*</span> <span class="mi">10</span> <span class="c1">#THIS WONT WORK</span>
<span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  <span class="c1"># [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="p">[{}]</span> <span class="o">*</span> <span class="mi">3</span>
<span class="p">[[]]</span> <span class="o">*</span> <span class="mi">3</span>
</code></pre></div></li>
</ul>
</li>
<li>Sort/Heap  <a href="https://docs.python.org/3/howto/sorting.html">Sorting HOW TO</a><ul>
<li>Note: sorted() will return a sorted list, it not change the original one
  while list.sort() will change the original list</li>
</ul>
</li>
<li>Key Func:<ul>
<li>a func to be called on each list elem, e.g. key=str.lower</li>
<li>it can be a lambda, e.g. key = lambda student: student.first_ name</li>
<li>The Key Functions are used in {{embed(((64a3827c-147d-443e-bb06-6b0e9f3ef2e0)))}}</li>
</ul>
</li>
<li>operator  <code>**from** **operator** **import** itemgetter, attrgetter</code><ul>
<li>2<sup>nd</sup> and then 3<sup>rd</sup> element in tuple/list:   <code>sorted(student_{ tuples,} key=itemgetter(2, 3))</code></li>
<li>sort based on class attribute:  <code>sorted(student_{ objects,} key=attrgetter('grade', 'age'))</code></li>
<li>Note: itemgetter for list/tuple and  attrgetter is for class</li>
</ul>
</li>
<li>Comparison Functions  <a href="https://www.geeksforgeeks.org/how-does-the-functools-cmp_to_key-function-works-in-python/">How does the functools cmp_ to_ key function works in Python? - GeeksforGeeks</a></li>
<li>functools.cmp_ to_ key(callable)<ul>
<li>A comparison/callable function is any callable that accepts two arguments, compares them, and returns a negative number for less-than, zero for equality,</li>
<li>example:</li>
<li>python
  <div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">functools</span>
<span class="k">def</span> <span class="nf">mycmp</span><span class="p">(</span><span class="n">student1</span><span class="p">,</span> <span class="n">student2</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;comparing &quot;</span><span class="p">,</span> <span class="n">student1</span><span class="p">,</span> <span class="s2">&quot; and &quot;</span><span class="p">,</span> <span class="n">student2</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">student1</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="n">student2</span><span class="o">.</span><span class="n">age</span><span class="p">:</span>
      <span class="k">return</span> <span class="mi">1</span>
  <span class="k">elif</span> <span class="n">student1</span><span class="o">.</span><span class="n">name</span> <span class="o">&lt;</span> <span class="n">student2</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">student</span><span class="p">(</span><span class="s2">&quot;James&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">student</span><span class="p">(</span><span class="s2">&quot;Mike&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">)],</span> <span class="n">key</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">cmp_to_key</span><span class="p">(</span><span class="n">mycmp</span><span class="p">)))</span>
</code></pre></div></li>
</ul>
</li>
<li>Iterator
  term:: An iterator is a Python object that implements a specific interface. <sub>iter___</sub> return instance of iterator and <strong>next()</strong> method steps the iterator on cycle and return a value to next object
  id:: 65137d16-a06a-40e4-b28e-5fa4474017d5</li>
<li><strong>functools: cache</strong><ul>
<li>@functools.<strong>cache</strong>(<em>user_ function</em>)</li>
<li>python
  <div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">functools</span>
<span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
<span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">1</span>
<span class="n">factorial</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>      <span class="c1"># no previously cached result, makes 11 recursive calls</span>
</code></pre></div></li>
</ul>
</li>
<li><strong>list comprehension</strong><ul>
<li><a href="https://realpython.com/list-comprehension-python/">When to Use a List Comprehension in Python – Real Python</a></li>
<li>baisic<ul>
<li>python
  <div class="highlight"><pre><span></span><code><span class="n">List</span> <span class="o">=</span> <span class="p">[</span><span class="n">character</span> <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">List</span><span class="p">)</span> <span class="c1">#[1, 2, 3]</span>
<span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="c1">#[0, 2, 4, 6, 8, 10]</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="p">[[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="c1"># 3x3 matrix</span>

<span class="n">lis</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">num</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">num</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># [0, 40, 80]</span>

<span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;Geeks4Geeks&#39;</span>
<span class="c1"># Toggle case of each character</span>
<span class="n">List</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="mi">32</span><span class="p">),</span> <span class="n">string</span><span class="p">))</span>
<span class="c1"># [&#39;g&#39;, &#39;E&#39;, &#39;E&#39;, &#39;K&#39;, &#39;S&#39;, &#39;\x14&#39;, &#39;g&#39;, &#39;E&#39;, &#39;E&#39;, &#39;K&#39;, &#39;S&#39;]</span>

<span class="c1"># Reverse each string in tuple</span>
<span class="n">List</span> <span class="o">=</span> <span class="p">[</span><span class="n">string</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Geeks&#39;</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="s1">&#39;Geeks&#39;</span><span class="p">)]</span>
<span class="c1"># [&#39;skeeG&#39;, &#39;rof&#39;, &#39;skeeG&#39;]</span>

<span class="c1"># Remove Multiple Values</span>
<span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;One&#39;</span><span class="p">,</span> <span class="s1">&#39;Two&#39;</span><span class="p">,</span> <span class="s1">&#39;Three&#39;</span><span class="p">,</span> <span class="s1">&#39;Three&#39;</span><span class="p">]</span>
<span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Three&#39;</span><span class="p">,</span> <span class="s1">&#39;Four&#39;</span><span class="p">]</span>
<span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">]</span>
<span class="c1">#Tree BFS</span>
<span class="p">[</span><span class="n">child</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">right</span><span class="p">)</span> <span class="k">if</span> <span class="n">child</span><span class="p">]</span>
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
<li>Map, Filter, Reduce and Zip
  id:: 6506c411-3211-4b0c-9647-637d211344b3<ul>
<li><a href="https://www.learnpython.org/en/Map%2C_Filter%2C_Reduce">Map, Filter, Reduce - Learn Python - Free Interactive Python Tutorial</a><ul>
<li>Map and Filter return iterator (not list)
  <a id="map">Map</a></li>
<li><strong>Map(func, *iterables)</strong><ul>
<li>Samples
  <div class="highlight"><pre><span></span><code><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span>  <span class="p">[</span><span class="s1">&#39;alfred&#39;</span><span class="p">,</span> <span class="s1">&#39;tabitha&#39;</span><span class="p">,</span> <span class="s1">&#39;william&#39;</span><span class="p">,</span> <span class="s1">&#39;arla&#39;</span><span class="p">]))</span>
<span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">round</span><span class="p">,</span>  <span class="p">[</span><span class="mf">3.56773</span><span class="p">,</span> <span class="mf">5.57668</span><span class="p">,</span> <span class="mf">4.00914</span><span class="p">,</span> <span class="mf">56.24241</span><span class="p">,</span> <span class="mf">9.01344</span><span class="p">,</span> <span class="mf">32.00013</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)))</span>
<span class="c1"># 3rd parameter is parameter to round</span>
<span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]))</span>
<span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]))</span>
<span class="c1">#[11, 44, 99, 176, 275]</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p><strong>Filter(func, iterable)</strong></p>
<ul>
<li>list(filter(lambda v: v &gt; 75,  [66, 90, 68, 59, 76, 60, 88, 74, 81, 65]))</li>
<li>filter and list comprehension</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="p">[</span><span class="o">&lt;</span><span class="n">exp1</span><span class="o">&gt;</span> <span class="k">for</span> <span class="o">&lt;</span><span class="n">var</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">iterable</span><span class="o">&gt;</span> <span class="k">if</span> <span class="o">&lt;</span><span class="n">logic</span> <span class="n">expression</span><span class="o">&gt;</span><span class="p">]</span>
<span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">if</span> <span class="n">x</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div>
        - <strong>reduce(func, iterable[, initial])</strong>
- python
  <div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">custom_sum</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">first</span> <span class="o">+</span> <span class="n">second</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">custom_sum</span><span class="p">,</span> <span class="n">numbers</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
- Another using reduce to implement #Trie [[DSA/Trie]]
    - python
      <div class="highlight"><pre><span></span><code><span class="n">Trie</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Trie</span><span class="p">)</span> <span class="c1">#constructor return default dict</span>
<span class="n">trie</span> <span class="o">=</span> <span class="n">Trie</span><span class="p">()</span> <span class="c1"># dict to lambda</span>
<span class="n">END</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Insert words into the trie</span>
<span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="s2">&quot;banana&quot;</span><span class="p">,</span> <span class="s2">&quot;apricot&quot;</span><span class="p">,</span> <span class="s2">&quot;bear&quot;</span><span class="p">,</span> <span class="s2">&quot;beach&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
    <span class="n">reduce</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">trie</span><span class="p">)[</span><span class="n">END</span><span class="p">]</span> <span class="o">=</span> <span class="n">word</span>
</code></pre></div>
    - e.g. word  &lsquo;apple&rsquo;. then trie[&lsquo;a&rsquo;]  dict{&lsquo;p&rsquo;: dict{&lsquo;p&rsquo;: dict{&lsquo;l&rsquo;: dict{&lsquo;e&rsquo;: dict{True:&rsquo;apple&rsquo;}}}}}
        - Zip
- creates an iterator that will aggregate elements from <strong>zero to more</strong> iterables.
    - zip([1, 2]); zip([1, 2], [&lsquo;a&rsquo;, &lsquo;b&rsquo;])
    - zip most useful to create &lt;<dict>&gt;
    - List comprehensions
      id:: 650c181a-1ea2-475c-a09b-35a4aa6ecd39
      <code>[x * y for x, y in zip([1, 2, 3], [3, 4, 5])]</code>
-
- Heap #heapq
    - Operations:
        - peek: there are <strong>no peek</strong>, use heap[0] instead
        - heappush
        - heappop
- python
  <div class="highlight"><pre><span></span><code><span class="n">h</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
    <span class="n">heappush</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="k">return</span> <span class="p">[</span><span class="n">heappop</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">))]</span>
</code></pre></div>
        - heappushpop(heap, item) push item and pop and return top element
        - heapify(x) : transform list x to heap, inplace O(n)
        - heapreplace(heap, item) pop smallest item and push new item, raise error if empty.  It is efficient for fixed size heap. It works like poppush
        - merge: merge multiple sorted input into a single sorted. It return a iterable(not al ist)
        - <strong>nlargest</strong> &amp; <strong>nsmallest</strong>:  return list of n largest/smallest elements, Equivalent to: <code>sorted(iterable, key=key, reverse=True/False)[:n]</code>
- Counter
    - <a href="https://realpython.com/python-counter/">Python&rsquo;s Counter: The Pythonic Way to Count Objects – Real Python</a>
    - counter.update(): the implementation provided by <strong>Counter</strong> adds existing counts together. It also creates new key-count pairs when necessary.
        - python
          <div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">letters</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">({</span><span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">letters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;missouri&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">letters</span>
<span class="n">Counter</span><span class="p">({</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sales</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">apple</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">orange</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">banana</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1"># Use a counter</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">monday_sales</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">apple</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">orange</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">banana</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sales</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">monday_sales</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sales</span>
<span class="n">Counter</span><span class="p">({</span><span class="s1">&#39;apple&#39;</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span> <span class="s1">&#39;banana&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
</code></pre></div>
        - keys(): list of all keys
        - values(): list of all values
- python
  <div class="highlight"><pre><span></span><code><span class="n">cnt</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="s2">&quot;AABC&quot;</span><span class="p">)</span>
<span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cnt</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>   <span class="c1"># 4</span>
</code></pre></div>
        - most_ common()  This method returns a list of (object, count) sorted by the objects’ current count
        -
- Enum
    - python
      <div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="c1"># class syntax</span>
<span class="k">class</span> <span class="nc">Color</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">BLUE</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># functional syntax  👍</span>
<span class="n">Color</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s1">&#39;Color&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;RED&#39;</span><span class="p">,</span> <span class="s1">&#39;GREEN&#39;</span><span class="p">,</span> <span class="s1">&#39;BLUE&#39;</span><span class="p">])</span>
<span class="n">my_color</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="n">RED</span>
</code></pre></div>
- Const/Final
    - python
      <div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Final</span>

<span class="n">PI</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span>  <span class="mf">3.14</span>
</code></pre></div>
- [[Comments]]
    - [[Sep 21<sup>st</sup>, 2023]]
        - ((650c181a-1ea2-475c-a09b-35a4aa6ecd39))
-</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/12/19/python-fundamental/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-12-19 00:00:00">December 19, 2023</time>
          <!-- start customization -->
          
          <!-- end customization --></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="python-oop-and-metaprogramming"><a class="toclink" href="../../2023/12/19/python-oop-and-metaprogramming/">Python OOP and MetaProgramming</a></h2>
<ul>
<li><a href="../assets/Python+Deep+Dive+4_1696669164886_0.pdf">Python+Deep+Dive+4.pdf</a></li>
<li>Properties<ul>
<li>In many languages direct access to attributes is highly discouraged Instead the convention is to make the attribute private, and create public getter and setter methods</li>
<li>Python property<ul>
<li>((65211fdc-5010-4ade-975c-c0cf9b480269))</li>
<li>((65212021-413d-4bcd-a1c1-81a964e79a45))</li>
</ul>
</li>
<li>property decorator <code>@property</code><ul>
<li>((652120be-a7ed-40a4-9429-a7b7c1d4eb95))</li>
</ul>
</li>
<li>ReadOnly Properties<ul>
<li>((6521213b-5183-4825-bca2-9dec4e4565c2))</li>
</ul>
</li>
</ul>
</li>
<li>Class Scope<ul>
<li>((652121ac-37ec-428c-90ba-8a4dd4b79ac0))</li>
<li>
<h3 id="652121e6-0bca-48f3-9aae-de800eed9d41"><a class="toclink" href="../../2023/12/19/python-oop-and-metaprogramming/#652121e6-0bca-48f3-9aae-de800eed9d41">((652121e6-0bca-48f3-9aae-de800eed9d41))</a></h3>
</li>
</ul>
</li>
<li>
<p>Enumerators And Alias</p>
<ul>
<li>Enum class</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Color</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
  <span class="n">red</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">crimson</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">carmine</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">blue</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="n">black</span> <span class="o">=</span> <span class="mi">3</span>
</code></pre></div>
- auto values
    - <code>enum.auto()</code> generate a auto values for enum
- MetaProgramming
- <code>type</code>
    - <code>type</code> is a <strong>class</strong></p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  class type:</span>
<span class="n n-Quoted">    def __init__(self):</span>
<span class="n n-Quoted">        在空值初识话数据</span>

<span class="n n-Quoted">    def __new__(self):</span>
<span class="n n-Quoted">          # __new__ from object</span>
<span class="n n-Quoted">        创建-&gt;创建类</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n n-Quoted">`type`</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`type(class_name, class_base, class_dict)`</span>
<span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`type`</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="n">programmly</span>
</code></pre></div>

<ul>
<li>
<p>Metaclass</p>
<ul>
<li>The class used to create a class, is called <strong>metaclass</strong> of that class, e.g. <code>MyType</code> is metaclass of <code>Person</code></li>
<li>By dflt, <code>type</code> is used to create a new class, but now if <code>metaclass</code> specified, it will be replace <code>type</code></li>
<li>Create a new class from MyType
  MyType</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xx</span>
</code></pre></div>
    * method 1 use MyType()</p>
<p><div class="highlight"><pre><span></span><code><span class="n">Foo</span> <span class="o">=</span> <span class="n">MyType</span><span class="p">(</span><span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="p">{</span><span class="s2">&quot;v1&quot;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span> <span class="s2">&quot;func&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="mi">999</span><span class="p">})</span>
</code></pre></div>
    * method 2 use metaclass</p>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">MyType</span><span class="p">):</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="mi">123</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">999</span>
</code></pre></div>
- If Base class created with metaclass, all child/grandchild class of Base will be create with same metaclass
- ((652124f8-b924-4054-8d9b-e56256794d28))
-</p>
</li>
</ul>
</li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/12/19/python-oop-and-metaprogramming/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <span class="md-pagination__current">1</span> <a class="md-pagination__link" href="page/2/">2</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2019 - 2024 RayX
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/ray-x" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/x_II_x" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9L389.2 48zm-24.8 373.8h39.1L151.1 88h-42l255.3 333.8z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in/ray-x" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "tags": {"CSS": "css", "HTML": "html", "JavaScript": "js"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8d2eff1.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>