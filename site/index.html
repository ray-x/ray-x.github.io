
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="This is a blog about my thoughts and experiences in the world of software development.
">
      
      
        <meta name="author" content="Ray-X">
      
      
        <link rel="canonical" href="https://rayx.me/">
      
      
      
        <link rel="next" href="blog/">
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.13">
    
    
      
        <title>Ray's Blog - Ray-X</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.7e359304.min.css">
      
      


  
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
  
  <style>.md-tag.md-tag--css{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M1.5 0h21l-1.91 21.563L11.977 24l-8.565-2.438L1.5 0zm17.09 4.413L5.41 4.41l.213 2.622 10.125.002-.255 2.716h-6.64l.24 2.573h6.182l-.366 3.523-2.91.804-2.956-.81-.188-2.11h-2.61l.29 3.855L12 19.288l5.373-1.53L18.59 4.414z"/></svg>');}.md-tag.md-tag--html{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M1.5 0h21l-1.91 21.563L11.977 24l-8.564-2.438L1.5 0zm7.031 9.75-.232-2.718 10.059.003.23-2.622L5.412 4.41l.698 8.01h9.126l-.326 3.426-2.91.804-2.955-.81-.188-2.11H6.248l.33 4.171L12 19.351l5.379-1.443.744-8.157H8.531z"/></svg>');}.md-tag.md-tag--js{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0zm22.034 18.276c-.175-1.095-.888-2.015-3.003-2.873-.736-.345-1.554-.585-1.797-1.14-.091-.33-.105-.51-.046-.705.15-.646.915-.84 1.515-.66.39.12.75.42.976.9 1.034-.676 1.034-.676 1.755-1.125-.27-.42-.404-.601-.586-.78-.63-.705-1.469-1.065-2.834-1.034l-.705.089c-.676.165-1.32.525-1.71 1.005-1.14 1.291-.811 3.541.569 4.471 1.365 1.02 3.361 1.244 3.616 2.205.24 1.17-.87 1.545-1.966 1.41-.811-.18-1.26-.586-1.755-1.336l-1.83 1.051c.21.48.45.689.81 1.109 1.74 1.756 6.09 1.666 6.871-1.004.029-.09.24-.705.074-1.65l.046.067zm-8.983-7.245h-2.248c0 1.938-.009 3.864-.009 5.805 0 1.232.063 2.363-.138 2.711-.33.689-1.18.601-1.566.48-.396-.196-.597-.466-.83-.855-.063-.105-.11-.196-.127-.196l-1.825 1.125c.305.63.75 1.172 1.324 1.517.855.51 2.004.675 3.207.405.783-.226 1.458-.691 1.811-1.411.51-.93.402-2.07.397-3.346.012-2.054 0-4.109 0-6.179l.004-.056z"/></svg>');}.md-tag.md-tag--python{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.25.18.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"/></svg>');}</style>

    
    
      
    
    
      
    
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#geek-rayweb-mobile-loversoftware-engineer-ray" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Ray-X" class="md-header__button md-logo" aria-label="Ray-X" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ray-X
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Ray's Blog
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ray-x" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ray-x
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Ray-X" class="md-nav__button md-logo" aria-label="Ray-X" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5Z"/></svg>

    </a>
    Ray-X
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ray-x" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ray-x
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Home
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#latest-posts" class="md-nav__link">
    <span class="md-ellipsis">
      Latest Posts
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="blog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Whats new
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    latest
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            latest
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="blog/2023/12/20/asyncio-python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    asyncio python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="blog/2023/12/19/python-django-restful-framework/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python Django Restful Framework
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="blog/archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="blog/archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="blog/archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="blog/archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#latest-posts" class="md-nav__link">
    <span class="md-ellipsis">
      Latest Posts
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  <h1 id="geek-rayweb-mobile-loversoftware-engineer-ray">关于软件、Geek | Ray，Web &amp; Mobile Lover，Software Engineer | 这里是 @Ray睿 类喵星人的个人博客。专注求索，创新<a class="headerlink" href="#geek-rayweb-mobile-loversoftware-engineer-ray" title="Permanent link">&para;</a></h1>
<h2 id="latest-posts"><ins>Latest Posts</ins><a class="headerlink" href="#latest-posts" title="Permanent link">&para;</a></h2>
  
  
    
      
    
  
    
      <!-- or "" suppresses "None" output-->
      
    
  
    
      <!-- or "" suppresses "None" output-->
      
    
  
    
      <!-- or "" suppresses "None" output-->
      
    
  
    
      blog/archive/2024/
    
  
    
      blog/archive/2023/
    
  
    
      blog/archive/2022/
    
  
    
      blog/archive/2020/
    
  

  
      <h2><a href="blog/2023/12/20/asyncio-python/">asyncio python</a></h2>
      <p>
        <b></b>
      </p>
      <aside class="mdx-author">
  
  <p>
    <span>
      
        <strong>ray-x</strong>
         ·
      
      
    
    
      
      
        
        
      
      
      <a href="https://github.com/ray-x" target="_blank" rel="noopener" title="github.com" class="twemoji">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
      
    
      
      
        
        
      
      
         · 
      
      <a href="https://twitter.com/x_II_x" target="_blank" rel="noopener" title="twitter.com" class="twemoji">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9L389.2 48zm-24.8 373.8h39.1L151.1 88h-42l255.3 333.8z"/></svg>
      </a>
      
    
      
      
        
        
      
      
         · 
      
      <a href="https://linkedin.com/in/ray-x" target="_blank" rel="noopener" title="linkedin.com" class="twemoji">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
      </a>
      
    

    </span>
    <span>
      <span class="twemoji">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0ZM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25Zm-17.75-5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25Z"/></svg>
      </span>
      December 20, 2023 ·
      <span class="twemoji">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25Z"/><path d="M12 1c6.075 0 11 4.925 11 11s-4.925 11-11 11S1 18.075 1 12 5.925 1 12 1ZM2.5 12a9.5 9.5 0 0 0 9.5 9.5 9.5 9.5 0 0 0 9.5-9.5A9.5 9.5 0 0 0 12 2.5 9.5 9.5 0 0 0 2.5 12Z"/></svg>
      </span>
      <!--Min reading time is 1 minute-->
      
      
      22 min read
    </span>
  </p>
</aside>
      <hr>
      <!-- Use a hidden p tag to provide a preview -->
      
        <ul>
<li>History</li>
<li>greenlet</li>
<li>yield</li>
<li>python3.4 asyncio<ul>
<li><code>yield from asyncio.sleep(1)</code> <code>yield</code> allow switch to other coroutines if blocked on IO</li>
</ul>
</li>
<li>
<p>python3.5 (async, await), 3.7(run)</p>
<ul>
<li>await, async</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello ...&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... World!&#39;</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
  - python 3.7 Task
  - python 3.11 TaskGroup
- Asynchronous Programming
  - event loop</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">([</span><span class="n">task1</span><span class="p">,</span> <span class="n">task2</span><span class="p">])</span>
</code></pre></div>
  - Basic of coroutines
  - <img alt="A diagram showing the difference between subroutine and coroutine calling" src="https://bbc.github.io/cloudfit-public-docs/images/asyncio/SubVsCoRoutines.png" />{:height
181, :width 346}
  - async
- coroutine function and coroutine object</p>
<p><div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">cotask</span><span class="p">():</span>  <span class="c1"># a coroutine task</span>
  <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">cotask</span><span class="p">()</span>      <span class="c1"># a coroutine object</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">cotask</span><span class="p">())</span>  <span class="c1"># run the task</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cotask</span><span class="p">())</span>  <span class="c1"># python 3.7</span>
</code></pre></div>
  - await
- If Python encounters an <code>await f()</code> expression in the scope of <code>g()</code>, <code>await</code> tells the event loop, “Suspend
  execution of <code>g()</code> until whatever I’m waiting on —the result of <code>f()</code> —is returned. In the meantime, go let
  something else run.&rdquo;
- Waitable objects can be:
  - coroutine object
  - ((6512ae22-02c0-42c1-bb30-97094aae783d))
  - Task object
- Two coroutines depends on each other</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">others</span><span class="p">()</span>
  <span class="k">await</span> <span class="k">async</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">others1</span><span class="p">()</span>
  <span class="k">await</span> <span class="k">async</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">dep_others</span><span class="p">():</span>
  <span class="k">await</span> <span class="n">others</span><span class="p">()</span>
  <span class="k">await</span> <span class="n">other1</span><span class="p">()</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dep_others</span><span class="p">())</span>
</code></pre></div>
  - Future
- Future is an <a href="https://docs.python.org/3/glossary.html#term-awaitable">awaitable</a> object. Coroutines can await on
  Future objects until they either have a result or an exception set, or until they are cancelled. A Future can be
  awaited multiple times and the result is same.
- Typically Futures are used to enable low-level callback-based code (e.g. in protocols implemented using
  asyncio <a href="https://docs.python.org/3/library/asyncio-protocol.html#asyncio-transports-protocols">transports</a>) to
  interoperate with high-level async/await code.
- example</p>
<p><div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span> <span class="c1"># current evloop</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>  <span class="c1"># an empty future object/task</span>
    <span class="k">await</span> <span class="n">future</span> <span class="c1"># wait until future object/task finished in this case it will wait for ever</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
- Set a future</p>
<p><div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">set_future</span><span class="p">(</span><span class="n">future</span><span class="p">):</span>
  <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="s2">&quot;666&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span> <span class="c1"># current evloop</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>  <span class="c1"># an empty future object/task</span>
    <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">set_future</span><span class="p">(</span><span class="n">future</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span> <span class="c1"># wait until future object/task finished in this case it will wait for ever</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># 666</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
- concurrent.futures
  - The <code>concurrent.futures</code> module is part of the Python standard library starting from Python 3.2. It provides a
    high-level interface for asynchronously executing callable objects using threads or processes. It builds upon
    the concepts of threading and multiprocessing but offers a simpler, more abstracted interface.
    ThreadPoolExecutor example</p>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">python</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>

<span class="c1"># Define a simple function to be executed</span>
<span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">**</span> <span class="mi">2</span>

<span class="c1"># Create a ThreadPoolExecutor with maximum 2 worker threads</span>
<span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="c1"># Submit tasks to the executor</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

    <span class="c1"># Retrieve results as they become available</span>
    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="c1"># Create a ProcessPoolExecutor with maximum 2 worker processes</span>
<span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="c1"># Submit tasks to the executor</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

    <span class="c1"># Retrieve results as they become available</span>
    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="err">```</span>
</code></pre></div>

<ul>
<li>
<p>asyncio object are not thread safe and it should not use together with multithread object. Here is a hack to
    convert a concurrent future to a asyncio feature</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>  <span class="c1"># doesnt support asyncio feature</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">feautre</span><span class="o">=</span><span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">rul_list</span><span class="p">]</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
</code></pre></div>
reference:
<a href="https://docs.python.org/3/library/asyncio-eventloop.html#id14">Executing code in thread or process pools</a>
      - <code>run_in_executor</code>
- if a io request does not support asyncio API. It can be wrapped with <code>run_in_executor</code>
- Above create a task The <em>executor</em> argument should be
  an <a href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">concurrent.futures.Executor</a> instance.
  The default executor is used if <em>executor</em> is None.
      -
  - Tasks
    - Syntax</p>
</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>
- Tasks are used to run/schedule coroutines in event loops. If a coroutine awaits on a
  ((6512ae22-02c0-42c1-bb30-97094aae783d)) , the Task suspends the execution of the coroutine and waits for the
  completion of the Future. When the Future is /done/, the execution of the wrapped coroutine resumes.
- If a coroutine awaits on a Future, the Task suspends the execution of the coroutine and waits for the completion
  of the Future. When the Future is <em>done</em>, the execution of the wrapped coroutine resumes.
- Event loops use cooperative scheduling: an event loop runs one Task at a time. While a Task awaits for the
  completion of a Future, the event loop runs other Tasks, callbacks, or performs IO operations.
- Use the high-level [[<a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.create_task">https://docs.python.org/3/library/asyncio-task.html#asyncio.create_task</a>][]] function to
  create Tasks, or the
  low-level [[<a href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.create_task">https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.create_task</a>][]] or [[<a href="https://docs.python.org/3/library/asyncio-future.html#asyncio.ensure_future">https://docs.python.org/3/library/asyncio-future.html#asyncio.ensure_future</a>][]] functions.
  Manual instantiation of Tasks is discouraged. <code>create_task</code> is equal to create+scheduleToRun. You do not need to
  kickoff the task
- The method <code>create_task</code> takes a coroutine object as a parameter and returns a <code>Task</code> object, which inherits from
  <code>asyncio.Future</code>. The call creates the task inside the event loop for the current thread, and starts the task
  executing at the beginning of the coroutine’s code-block. The returned future will be marked as <code>done()</code> only when
  the task has finished execution. As you might expect the return value of the coroutine’s code block is the
  <code>result()</code> which will be stored in the future object when it is finished (and if it raises then the exception will
  be caught and stored in the future).
- Example:</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">counter</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">i</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">counter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)))</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">done</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">await</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#another way to wait</span>
    <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1"># and you can also try this</span>
  <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">([</span><span class="n">counter</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="n">counter</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)]))</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
- Video resource
  {{video(<a href="https://www.bilibili.com/video/BV1NA411g7yf?p=7&amp;vd_source=3beef1bd86c86cf14f277319e599dab9">https://www.bilibili.com/video/BV1NA411g7yf?p=7&amp;vd_source=3beef1bd86c86cf14f277319e599dab9</a>)}}
  - Async Queue
  - Asynchronous Iterators
- ((65137d16-a06a-40e4-b28e-5fa4474017d5))
- Sample</p>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Ticker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yield numbers from 0 to `to` every `delay` seconds.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">to</span>

    <span class="k">def</span> <span class="fm">__aiter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__anext__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopAsyncIteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">ticker</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yield numbers from 0 to `to` every `delay` seconds.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">to</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">i</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
</code></pre></div>
  - Asynchronous contex manager
- async ctx mgr provide a context manager that can be suspended when entering and exiting. This is achieved by using
  <code>async with</code>. It is same way as <code>with</code> been used in other python expressions (e.g. file open)
- How to use</p>
<p><div class="highlight"><pre><span></span><code><span class="c1"># create and use an asynchronous context manager</span>
<span class="k">async</span> <span class="k">with</span> <span class="n">AsyncContextManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span>
    <span class="o">...</span>
<span class="c1"># Same as:</span>
<span class="c1"># create or enter the async context manager</span>
<span class="n">manager</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AsyncContextManager</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
  <span class="c1"># ...</span>
<span class="k">finally</span><span class="p">:</span>
  <span class="c1"># close or exit the context manager</span>
  <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
- It must be used inside a coroutine <code>async def</code>
  - uvloop
- uvloop <a href="https://github.com/magicstack/uvloop">GitHub - MagicStack/uvloop: Ultra fast asyncio event loop.</a> is 2~3
  times faster than asyncio
- Using uvloop</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">uvloop</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Main entry-point.</span>
    <span class="o">...</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Runner</span><span class="p">(</span><span class="n">loop_factory</span><span class="o">=</span><span class="n">uvloop</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">)</span> <span class="k">as</span> <span class="n">runner</span><span class="p">:</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">uvloop</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
- It used by asgi uvicorn
  - Practical examples
- redis</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">redis.asyncio</span> <span class="k">as</span> <span class="nn">redis</span>

<span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="s2">&quot;redis://localhost&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">with</span> <span class="n">r</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">pipe</span><span class="p">:</span>
    <span class="n">ok1</span><span class="p">,</span> <span class="n">ok2</span> <span class="o">=</span> <span class="k">await</span> <span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;key1&quot;</span><span class="p">,</span> <span class="s2">&quot;value1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;key2&quot;</span><span class="p">,</span> <span class="s2">&quot;value2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>
<span class="k">assert</span> <span class="n">ok1</span>
<span class="k">assert</span> <span class="n">ok2</span>

<span class="c1"># pubsub</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">redis.asyncio</span> <span class="k">as</span> <span class="nn">redis</span>
<span class="n">STOPWORD</span> <span class="o">=</span> <span class="s2">&quot;STOP&quot;</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="n">channel</span><span class="p">:</span> <span class="n">redis</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">PubSub</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_message</span><span class="p">(</span><span class="n">ignore_subscribe_messages</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(Reader) Message Received: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">==</span> <span class="n">STOPWORD</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(Reader) STOP&quot;</span><span class="p">)</span>
                <span class="k">break</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="s2">&quot;redis://localhost&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">with</span> <span class="n">r</span><span class="o">.</span><span class="n">pubsub</span><span class="p">()</span> <span class="k">as</span> <span class="n">pubsub</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">pubsub</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&quot;channel:1&quot;</span><span class="p">,</span> <span class="s2">&quot;channel:2&quot;</span><span class="p">)</span>

    <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">reader</span><span class="p">(</span><span class="n">pubsub</span><span class="p">))</span>

    <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;channel:1&quot;</span><span class="p">,</span> <span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;channel:2&quot;</span><span class="p">,</span> <span class="s2">&quot;World&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;channel:1&quot;</span><span class="p">,</span> <span class="n">STOPWORD</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">future</span>

<span class="kn">import</span> <span class="nn">asyncio_redis</span>
<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="c1"># Create Redis connection</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">asyncio_redis</span><span class="o">.</span><span class="n">Connection</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>
    <span class="c1"># Set a key</span>
    <span class="k">yield from</span> <span class="n">connection</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;my_key&#39;</span><span class="p">,</span> <span class="s1">&#39;my_value&#39;</span><span class="p">)</span>
    <span class="c1"># When finished, close the connection.</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">example</span><span class="p">())</span>
</code></pre></div>
- Mysql with aiomysql</p>
<h2 id="import-asyncio-import-sqlalchemy-as-sa-from-aiomysqlsa-import-create_engine-metadata-sametadata-tbl-satabletbl-metadata-sacolumnid-sainteger-primary_keytrue-sacolumnval-sastring255-async-def-goloop-engine-await-create_engineuserroot-dbtest_pymysql-host127001-password-looploop-async-with-engineacquire-as-conn-await-connexecutetblinsertvaluesvalabc-await-connexecutetblinsertvaluesvalxyz-async-for-row-in-connexecutetblselect-printrowid-rowval-engineclose-await-enginewait_closed-loop-asyncioget_event_loop-looprun_until_completegoloop"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">aiomysql.sa</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
<span class="n">tbl</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;tbl&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
               <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
               <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">go</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s1">&#39;test_pymysql&#39;</span><span class="p">,</span>
                                 <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39;abc&#39;</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39;xyz&#39;</span><span class="p">))</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">select</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>

    <span class="n">engine</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">engine</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">go</span><span class="p">(</span><span class="n">loop</span><span class="p">))</span>
</code></pre></div><a class="headerlink" href="#import-asyncio-import-sqlalchemy-as-sa-from-aiomysqlsa-import-create_engine-metadata-sametadata-tbl-satabletbl-metadata-sacolumnid-sainteger-primary_keytrue-sacolumnval-sastring255-async-def-goloop-engine-await-create_engineuserroot-dbtest_pymysql-host127001-password-looploop-async-with-engineacquire-as-conn-await-connexecutetblinsertvaluesvalabc-await-connexecutetblinsertvaluesvalxyz-async-for-row-in-connexecutetblselect-printrowid-rowval-engineclose-await-enginewait_closed-loop-asyncioget_event_loop-looprun_until_completegoloop" title="Permanent link">&para;</a></h2>
<h2 id="-">-<a class="headerlink" href="#-" title="Permanent link">&para;</a></h2>
<h2 id="-_1">-<a class="headerlink" href="#-_1" title="Permanent link">&para;</a></h2>
<p>-
- References
  - <a href="https://www.bilibili.com/video/BV11T4y117Jo">协程到底是咋回事？asyncio大佬给你彻底讲明白。</a>
  - <a href="https://bbc.github.io/cloudfit-public-docs/asyncio/asyncio-part-2.html">Python Asyncio Part 2 – Awaitables, Tasks, and Futures | cloudfit-public-docs</a>
  - <a href="https://bbc.github.io/cloudfit-public-docs/asyncio/asyncio-part-3">Python Asyncio Part 3 – Asynchronous Context Managers and Asynchronous Iterators | cloudfit-public-docs</a>
  - <a href="https://realpython.com/async-io-python/">Async IO in Python: A Complete Walkthrough – Real Python</a>
-
-</p>
</li>
</ul>
        <a href="blog/2023/12/20/asyncio-python/#more">
          <span class="twemoji">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13.22 19.03a.75.75 0 0 1 0-1.06L18.19 13H3.75a.75.75 0 0 1 0-1.5h14.44l-4.97-4.97a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/></svg>
          </span>
          Continue reading
          <hr>
        </a>
      
  
      <h2><a href="blog/2023/12/19/python-django-restful-framework/">Python Django Restful Framework</a></h2>
      <p>
        <b></b>
      </p>
      <aside class="mdx-author">
  
  <p>
    <span>
      
        <strong>ray-x</strong>
         ·
      
      
    
    
      
      
        
        
      
      
      <a href="https://github.com/ray-x" target="_blank" rel="noopener" title="github.com" class="twemoji">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
      
    
      
      
        
        
      
      
         · 
      
      <a href="https://twitter.com/x_II_x" target="_blank" rel="noopener" title="twitter.com" class="twemoji">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9L389.2 48zm-24.8 373.8h39.1L151.1 88h-42l255.3 333.8z"/></svg>
      </a>
      
    
      
      
        
        
      
      
         · 
      
      <a href="https://linkedin.com/in/ray-x" target="_blank" rel="noopener" title="linkedin.com" class="twemoji">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
      </a>
      
    

    </span>
    <span>
      <span class="twemoji">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0ZM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25Zm-17.75-5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25Z"/></svg>
      </span>
      December 19, 2023 ·
      <span class="twemoji">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25Z"/><path d="M12 1c6.075 0 11 4.925 11 11s-4.925 11-11 11S1 18.075 1 12 5.925 1 12 1ZM2.5 12a9.5 9.5 0 0 0 9.5 9.5 9.5 9.5 0 0 0 9.5-9.5A9.5 9.5 0 0 0 12 2.5 9.5 9.5 0 0 0 2.5 12Z"/></svg>
      </span>
      <!--Min reading time is 1 minute-->
      
      
      44 min read
    </span>
  </p>
</aside>
      <hr>
      <!-- Use a hidden p tag to provide a preview -->
      
        <ul>
<li>Django Restful Framework Videos
  url:: <a href="https://www.bilibili.com/video/BV1xj411C7ws">drf实战和源码剖析</a>
  channel:: <a href="https://space.bilibili.com/336469068">https://space.bilibili.com/336469068</a>
  tags:: rest, DRF, python, django, web, API
  date:: [[Sep 25<sup>th</sup>, 2023]]
  tutor:: 武沛齐</li>
<li>Resources
  heading:: 2<ul>
<li><a href="https://www.bilibili.com/video/BV1Sc41157hr">银角大王-武沛齐Django-Drf框架与django3项目搭建案例全套教学 完整版</a></li>
<li><a href="https://www.bilibili.com/video/BV1pA41117U4">银角大王-武沛齐Django-Drf框架与vue项目搭建案例全套教学  完整版</a></li>
<li><a href="https://www.bilibili.com/video/BV1XR4y157rk">全站最牛逼的DRF（Django-restframework），没有之一！</a></li>
<li><a href="https://www.bilibili.com/video/BV1Cv4y1R77V">【独家专授】我要安利给所有人DRF（Django-rest-framework）与源码解析自学教程全程无广安心食用！！！</a></li>
<li><a href="https://www.bilibili.com/video/BV1Sz4y1o7E8">黑马 Django REST Framework框架经典教程</a></li>
</ul>
</li>
<li>
<p>Jump start
  heading:: 2</p>
<ul>
<li>install
  heading:: 3<ul>
<li><a href="https://www.django-rest-framework.org/#installation">Home - Django REST framework  install</a></li>
</ul>
</li>
<li>
<p>usage
  heading:: 3</p>
<ul>
<li><a href="https://www.django-rest-framework.org/tutorial/quickstart">Quickstart - Django REST framework</a></li>
<li>settings:</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">...</span>
    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>
- response</p>
<p><div class="highlight"><pre><span></span><code><span class="c1"># views.py</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">api_view</span>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">reqeust</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;sucessfull&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">})</span>

<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;sucessfull&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">})</span>
<span class="c1"># urls.py</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">LoginView</span><span class="o">.</span><span class="n">as_view</span><span class="p">())</span>
  <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login2/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">login</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div>
    - minium django setup
      heading:: 3</p>
</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="s1">&#39;api.apps.ApiConfig&#39;</span><span class="p">,</span> <span class="c1"># this include app : api</span>
    <span class="s1">&#39;rest_framework&#39;</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.middleware.security.SecurityMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s1">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;APP_DIRS&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;context_processors&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;django.template.context_processors.debug&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.template.context_processors.request&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;UNAUTHENTICATED_USER&quot;</span><span class="p">:</span> <span class="kc">None</span>   <span class="c1"># disable user-content reference</span>
<span class="p">}</span>
</code></pre></div>
- ((651210f8-a2fe-4194-9216-f1eefdded8a6))
  heading:: 2
- APIView
  heading:: 2
  desc:: REST framework provides an <sub>APIView</sub> class, which subclasses Django&rsquo;s <sub>View</sub> class.
- APIView &lt;- django.views.View and it implemented <code>as_view()</code>
    - APIView has <code>csrf_exempt</code>. It implemented <code>as_view</code> and <code>dispatch</code>
    - Requests passed to the handler methods will be REST framework&rsquo;s <code>Request</code> instances, not Django&rsquo;s <code>HttpRequest</code> instances.
    - Handler methods may return REST framework&rsquo;s <code>Response</code>, instead of Django&rsquo;s <code>HttpResponse</code>  The view will manage content negotiation and setting the correct renderer on the response.
    - Any <code>APIException</code> exceptions will be caught and mediated into appropriate responses.
    - Incoming requests will be authenticated and appropriate permission and/or throttle checks will be run before dispatching the request to the handler method.
    -
- Requests
  heading:: 2
  desc:: REST framework&rsquo;s <sub>Request</sub> class extends the standard <sub>HttpRequest</sub>,  adding support for REST framework&rsquo;s flexible request parsing and request authentication.
- <a href="https://www.django-rest-framework.org/api-guide/requests/">Requests - Django REST framework</a>
  heading:: 3
- DRF extend django HttpRequests by adding
  heading:: 3
    - <code>data</code>: use <code>request.data.get('fieldname')</code> to get data from a POST request
    - <code>query_params</code>  handle URL like <code>/users/?id=12</code>
    - Authentication
    - Browser enhancement
    - extends HttpRequest
        - META
        - session
        - version
            - request.version
            - request.versioning_{ schema}
        - parser
        - negotiator
    -
- Authentication
  heading:: 2
  desc:: Auhentication is the mechanism of associating an incoming request with a set of identifying credentials, such as the user the request came from, or the token that it was signed with. The <a href="https://www.django-rest-framework.org/api-guide/permissions/">permission</a> and <a href="https://www.django-rest-framework.org/api-guide/throttling/">throttling</a> policies can then use those credentials to determine if the request should be permitted.
  id:: 65136fb1-b3fd-40b2-b22b-d8ea5e0908b9
- Create a new Authentiation class
  heading:: 3
- SimpleAuth
  heading:: 3
  <div class="highlight"><pre><span></span><code><span class="c1"># auth.py</span>
<span class="k">class</span> <span class="nc">SimpleAuth</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
      <span class="k">return</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="n">token</span> <span class="c1">#return user and token</span>
      <span class="k">raise</span> <span class="n">AuthenticationFailed</span><span class="p">(</span><span class="s1">&#39;token missing&#39;</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;xxx app&quot;</span> <span class="c1"># return when you need something put in header when failed</span>
<span class="c1"># view.py</span>
<span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
  <span class="n">authentication_class</span> <span class="o">=</span> <span class="p">[</span><span class="n">SimpleAuth</span><span class="p">]</span>  <span class="c1"># Auth is required</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span> <span class="c1"># prints &#39;admin&#39;,  token</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({})</span>
</code></pre></div>
- Apply Authentication Globally
  heading:: 3
    - in Settings.py</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  REST_FRAMEWORK= {</span>
<span class="n n-Quoted">  &quot;DEFAULT_AUTHENTICATION_CLASS&quot;: [&quot;api.view.SimpleAuth&quot;,] # use string to avoid imporiting packages</span>
<span class="n n-Quoted">  }</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="n">Override</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="k">First</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">Auth</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">set</span><span class="n">ting</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="n n-Quoted">`authentication_class`</span><span class="p">.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">2nd</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="k">set</span><span class="n">ting</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n n-Quoted">`None`</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="mi">2</span><span class="o">^</span><span class="err">{</span><span class="w"> </span><span class="n">nd</span><span class="err">}</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n n-Quoted">`[]`</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">disable</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="k">set</span><span class="n">ting</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">disable</span><span class="w"> </span><span class="n">Auth</span>
</code></pre></div>

<ul>
<li>
<p>Multi Authenticators
  heading:: 4</p>
<ul>
<li>If <code>authenticate()</code> returns <code>None</code> when failed, DRF will go to next Authenticator until the return value is not None.</li>
<li>If all returns None. then <code>self.auth == None</code></li>
<li>If you want to prevent <code>None</code> go through, put an authenticator that will raise fail at end of list</li>
<li>Verify token in Authentication middleware</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">QueryTokenAuth</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>   <span class="c1"># api:  GET order/?orderid=12&amp;token=3322-333-111-111-3233</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span>
      <span class="k">return</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span>   <span class="c1"># request.user = user, request.token=token</span>
    <span class="k">raise</span> <span class="n">AuthenticationFailed</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">401</span><span class="p">})</span>
  <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;query failure&quot;</span>

<span class="k">class</span> <span class="nc">HeaderTokenAuth</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HTTP_AUTHORIZATION&quot;</span><span class="p">)</span>   <span class="c1"># api:  GET order/?orderid=12&amp;token=3322-333-111-111-3233</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span>
      <span class="k">return</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span>   <span class="c1"># request.user = user, request.token=token</span>
    <span class="k">raise</span> <span class="n">AuthenticationFailed</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">401</span><span class="p">})</span>
  <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;nead failure&quot;</span>
</code></pre></div>
- Auth success when <code>any()</code> of authenticator return <code>user, auth</code>
    - Login, Register and token issuing
      heading:: 3
- <a href="https://medium.com/django-rest/django-rest-framework-login-and-register-user-fd91cf6029d5">Login and Register User — Django Rest Framework | by Emre Cevik | Python | Django &amp; Rest | Medium</a>
- Login url</p>
<p><div class="highlight"><pre><span></span><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login/&#39;</span><span class="p">,</span> <span class="n">MyObtainTokenPairView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;token_obtain_pair&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login/refresh/&#39;</span><span class="p">,</span> <span class="n">TokenRefreshView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;token_refresh&#39;</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>
- Simple login with user/password</p>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
  <span class="n">authentication_classes</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
      <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
      <span class="n">pwd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
      <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">pwd</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">1002</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s2">&quot;user/pass failed&quot;</span><span class="p">})</span>
      <span class="n">token</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
      <span class="n">user</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
      <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="o">=</span> <span class="n">token</span><span class="p">})</span>
</code></pre></div>
- Permission
  heading:: 2
  desc:: Together with <a href="https://www.django-rest-framework.org/api-guide/authentication/">authentication</a> and <a href="https://www.django-rest-framework.org/api-guide/throttling/">throttling</a>, permissions determine whether a request should be granted or denied access.
  url:: <a href="https://www.django-rest-framework.org/api-guide/permissions/">DRF: Permission</a>
    - Permissions are used to grant or deny access for different classes of users to different parts of the API.
    - The simplest style of permission would be to allow access to any authenticated user, and deny access to any unauthenticated user. This corresponds to the <code>IsAuthenticated</code> class in REST framework.
    - Sample permission class</p>
</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span>
<span class="k">class</span> <span class="nc">IsOwnerOrReadOnly</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom permission to only allow owners of an object to edit it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># message is used to create a response body when per check failed</span>
    <span class="n">code</span> <span class="o">=</span> <span class="mi">401</span> <span class="c1"># used to set http code</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span><span class="s2">&quot;False&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;permission error for user&quot;</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;IsOwnerCheck&quot;</span><span class="p">}</span>
    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="c1"># Read permissions are allowed to any request,</span>
        <span class="c1"># so we&#39;ll always allow GET, HEAD or OPTIONS requests.</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># Write permissions are only allowed to the owner of the snippet.</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># Read permissions are allowed to any request,</span>
        <span class="c1"># so we&#39;ll always allow GET, HEAD or OPTIONS requests.</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># Write permissions are only allowed to the owner of the snippet.</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</code></pre></div>
- Per-View permission check with</p>
<p><div class="highlight"><pre><span></span><code><span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">,</span>
                      <span class="n">IsOwnerOrReadOnly</span><span class="p">]</span>
</code></pre></div>
- <code>permission_classes</code> is <code>all()</code>, it is not same as <code>authentication_classes</code>
- Global setting with
  <div class="highlight"><pre><span></span><code><span class="c1"># settings.py</span>
<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
<span class="s2">&quot;DEFAULT_PERMISSION_CLASS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ext.per.IsOwnerOrReadOnly&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
- One difference between ((65136fb1-b3fd-40b2-b22b-d8ea5e0908b9)) is if a list of Per-Class is add. <strong>ALL</strong> Permission check need success/True. It is <strong>AND</strong> operation
- Add permission check in view</p>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">OrderView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
  <span class="n">permission_classes</span><span class="o">=</span><span class="p">[</span><span class="n">PermUser</span><span class="p">,</span> <span class="n">PermAPI</span><span class="p">]</span>
</code></pre></div>
- Check permissions override
    - if you need to override default permission check mechanism, override <code>check_permissions()</code> function in view class 💀
- Throttling
  heading:: 2
  desc:: Throttling is similar to <a href="https://www.django-rest-framework.org/api-guide/permissions/">permissions</a>, in that it determines if a request should be authorized. Throttles indicate a temporary state, and are used to control the rate of requests that clients can make to an API.
- As with permissions, multiple throttles may be used. Your API might have a restrictive throttle for unauthenticated requests, and a less restrictive throttle for authenticated requests.
- Another scenario where you might want to use multiple throttles would be if you need to impose different constraints on different parts of the API, due to some services being particularly resource-intensive.
- Settings</p>
<p><div class="highlight"><pre><span></span><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_THROTTLE_CLASSES&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;rest_framework.throttling.AnonRateThrottle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rest_framework.throttling.UserRateThrottle&#39;</span>
    <span class="p">],</span>
    <span class="s1">&#39;DEFAULT_THROTTLE_RATES&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;anon&#39;</span><span class="p">:</span> <span class="s1">&#39;100/day&#39;</span><span class="p">,</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;1000/day&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
  And in View</p>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ExampleView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">throttle_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">UserRateThrottle</span><span class="p">]</span>
</code></pre></div>
  FBV</p>
<p><div class="highlight"><pre><span></span><code>@api_view([&#39;GET&#39;])
@throttle_classes([UserRateThrottle])
def example_view(request, format=None):
    content = {
        &#39;status&#39;: &#39;request was permitted&#39;
    }
    return Response(content)
</code></pre></div>
- Define a throttle Class
    - In most case throttle class in django is good enough for 99% of the user cases. But in case you need to define a throttle of your own, here is two examples:
      <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RandomRateThrottle</span><span class="p">(</span><span class="n">throttling</span><span class="o">.</span><span class="n">BaseThrottle</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">allow_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>

<span class="k">class</span> <span class="nc">RandomRateThrottle2</span><span class="p">(</span><span class="n">throttling</span><span class="o">.</span><span class="n">SimpleRateThrottle</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">allow_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
      <span class="k">if</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">allow_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>

<span class="k">class</span> <span class="nc">MyRateThrottle</span><span class="p">(</span><span class="n">SimpleRateThrottle</span><span class="p">):</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">default_cache</span>  <span class="c1"># 访问记录存放在django的缓存中（需设置缓存）</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>  <span class="c1"># 构造缓存中的key different API can have different scope</span>
    <span class="n">cache_format</span> <span class="o">=</span> <span class="s1">&#39;throttle_</span><span class="si">%(scope)s</span><span class="s1">_</span><span class="si">%(ident)s</span><span class="s1">&#39;</span>

    <span class="c1"># 设置访问频率，例如：1分钟允许访问10次</span>
    <span class="c1"># 其他：&#39;s&#39;, &#39;sec&#39;, &#39;m&#39;, &#39;min&#39;, &#39;h&#39;, &#39;hour&#39;, &#39;d&#39;, &#39;day&#39;</span>
    <span class="n">THROTTLE_RATES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;10/m&quot;</span><span class="p">}</span>  <span class="c1">#scope : rate</span>

    <span class="k">def</span> <span class="nf">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span>  <span class="c1"># 用户ID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>  <span class="c1"># 获取请求用户IP（去request中找请求头）</span>

        <span class="c1"># throttle_u # throttle_user_11.11.11.11ser_2</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_format</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="s1">&#39;ident&#39;</span><span class="p">:</span> <span class="n">ident</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">throttle_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">detail</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">1005</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;访问频率限制&quot;</span><span class="p">,</span>
            <span class="s1">&#39;detail&#39;</span><span class="p">:</span> <span class="s2">&quot;需等待</span><span class="si">{}</span><span class="s2">s才能访问&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">wait</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="k">raise</span> <span class="n">ThrottledException</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
</code></pre></div>
- Versioning
  heading:: 2
  desc:: Versioning allows you to alter behavior between different clients. DRF provides for a number of different versioning schemes.
- Config API version
  heading:: 3
    - [[../assets/image-20210819154455680_1696666609261_0.png]]
    - settings.py</p>
<div class="codehilite"><pre><span></span><code>  ``` python
  REST_FRAMEWORK = {
      &#39;DEFAULT_VERSIONING_CLASS&#39;: &#39;rest_framework.versioning.NamespaceVersioning&#39;
  }
  ```
<span class="k">-</span> View.py

  ``` python
  class ProfileList(APIView):
      versioning_class = versioning.QueryParameterVersioning
  ```
-
</code></pre></div>

<ul>
<li>
<p>Version schema
  heading:: 3</p>
<ul>
<li><a href="https://www.django-rest-framework.org/api-guide/versioning/#acceptheaderversioning">AcceptHeaderVersioning</a>
  heading:: 3</li>
</ul>
<blockquote>
<p>GET <em>bookings</em> HTTP/1.1
  Host: example.com
  Accept: application/json; version=1.0
- <a href="https://www.django-rest-framework.org/api-guide/versioning/#urlpathversioning">URLPathVersioning</a>
  heading:: 3</p>
<p>GET /v1/bookings/ HTTP/1.1
  Host: example.com
  Accept: application/json</p>
</blockquote>
<p><div class="highlight"><pre><span></span><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">re_path</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;^(?P&lt;version&gt;(v1|v2))/bookings/$&#39;</span><span class="p">,</span>
        <span class="n">bookings_list</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bookings-list&#39;</span>
    <span class="p">),</span>
    <span class="n">re_path</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;^(?P&lt;version&gt;(v1|v2))/bookings/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span>
        <span class="n">bookings_detail</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bookings-detail&#39;</span>
    <span class="p">)</span>
<span class="p">]</span>
</code></pre></div>
- <a href="https://www.django-rest-framework.org/api-guide/versioning/#namespaceversioning">NamespaceVersioning</a>
  heading:: 3</p>
<blockquote>
<p>GET <em>bookings</em> HTTP/1.1
  Host: v1.example.com
  Accept: application/json</p>
</blockquote>
<p><div class="highlight"><pre><span></span><code><span class="c1"># bookings/urls.py</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">re_path</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">bookings_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bookings-list&#39;</span><span class="p">),</span>
    <span class="n">re_path</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">bookings_detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bookings-detail&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># urls.py</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">re_path</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^v1/bookings/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;bookings.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;v1&#39;</span><span class="p">)),</span>
    <span class="n">re_path</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^v2/bookings/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;bookings.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;v2&#39;</span><span class="p">))</span>
<span class="p">]</span>
</code></pre></div>
- <a href="https://www.django-rest-framework.org/api-guide/versioning/#queryparameterversioning">QueryParameterVersioning</a>
  heading:: 3</p>
<blockquote>
<p>GET <em>something</em>?version=0.1 HTTP/1.1
  Host: example.com
  Accept: application/json
    - Reverse URL
      heading:: 3
- [[../assets/image-20210820105543193-3386187_1696666581416_0.png]]
- [[../assets/image-20210820112152615_1696666677979_0.png]]
- Request parsing
  heading:: 2
  desc:: REST framework includes a number of built in Parser classes, that allow you to accept requests with various media types. There is also support for defining your own custom parsers
    - Jsonparser
      [[../assets/image-20210827081058194_1696668405368_0.jpg]]
    - File parser (MultiPartParser)
- [[../assets/image-20210827083047327_1696668472683_0.jpg]]
    - File uploader
- [[../assets/image-20210827084403453_1696668497009_0.jpg]]
-
    -
- Content negotiation
  heading:: 2
  desc:: Content negotiation is the process of selecting one of multiple possible representations to return to a client, based on client or server preferences.
  url:: <a href="https://www.django-rest-framework.org/api-guide/content-negotiation/">Content negotiation - Django REST framework</a>
    - The client need specify <code>content-type</code>and the value should be valid http <code>media type</code>
    - the config is through <code>parser_classes</code> and <code>content_negotiation_class</code>
      Global setting</p>
</blockquote>
</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_CONTENT_NEGOTIATION_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;myapp.negotiation.IgnoreClientContentNegotiation&#39;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
- When the code refer to request.data it will trigger the parser
- Most used <code>JSONParser</code> and <code>FormParserxx</code>, to upload file <code>FileUploaderParser</code>, Large file <code>MultiPartParser</code>
- If not specifed or content does not match parser, a exception will be throw
-
-
- Serializers
  heading:: 2
  desc:: Serializers allow complex data such as querysets and model instances to be converted to native Python datatypes that can then be easily rendered into <sub>JSON</sub>, <sub>XML</sub> or other content types. Serializers also provide deserialization, allowing parsed data to be converted back into complex types, after first validating the incoming data.
- Declaring Serializers
  heading:: 3
    - In a sense, Serializers is similar to ((651cfa1b-ce5c-486b-8f45-5f3cee8f113e))
    - Create a serializer for <code>Comment</code></p>
<div class="codehilite"><pre><span></span><code>  <span class="err">```</span> <span class="n">python</span>
  <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

  <span class="k">class</span> <span class="nc">Comment</span><span class="p">:</span>
      <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">created</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

  <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">&#39;leila@example.com&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s1">&#39;foo bar&#39;</span><span class="p">)</span>

  <span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>
  <span class="k">class</span> <span class="nc">CommentSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
      <span class="n">email</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">EmailField</span><span class="p">()</span>
      <span class="n">content</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
      <span class="n">created</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
  <span class="err">```</span>
</code></pre></div>

<ul>
<li>Serializing object
  heading:: 3<ul>
<li>use <sub>CommentSerializer</sub> to serialize a comment, or list of comments
  <code>python
  serializer = CommentSerializer(comment)
  serializer.data
  # {'email': 'leila@example.com', 'content': 'foo bar', 'created': '2016-01-27T15:17:10.375877'}
  comments = [comment, comment] # array of objects
  serializer = CommentSerializer(comments, many=True)
  serializer.data # a list of objects
  from rest_framework.renderers import JSONRenderer

  json = JSONRenderer().render(serializer.data)</code></li>
</ul>
</li>
<li>Deserializing
  heading:: 3</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">rest_framework.parsers</span> <span class="kn">import</span> <span class="n">JSONParser</span>

<span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">JSONParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">CommentSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
<span class="c1"># True</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span>
<span class="c1"># {&#39;content&#39;: &#39;foo bar&#39;, &#39;email&#39;: &#39;leila@example.com&#39;, &#39;created&#39;: datetime.datetime(2012, 08, 22, 16, 20, 09, 822243)}</span>
</code></pre></div>
- ModelSerializer
  heading:: 3
  desc:: serializer classes that map closely to Django model definitions.
    - The <code>ModelSerializer</code> class provides a shortcut that lets you automatically create a <sub>Serializer</sub> class with fields that correspond to the Model fields. It based on <code>Serializer</code> class and
      * It will automatically generate a set of fields for you, based on the model.
      * It will automatically generate validators for the serializer, such as unique_{ together} validators.
      * It includes simple default implementations of <code>.create()</code> and <code>.update()</code>.
    - Declaring
      heading:: 4</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  class AccountSerializer(serializers.ModelSerializer):</span>
<span class="n n-Quoted">      class Meta:</span>
<span class="n n-Quoted">          model = Account</span>
<span class="n n-Quoted">          fields = [&#39;id&#39;, &#39;account_name&#39;, &#39;users&#39;, &#39;created&#39;]  # similar to ModelForm, you can use fields = &#39;__all__&#39;</span>
<span class="n n-Quoted">          read_only_fields = [&#39;account_name&#39;]</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`read_only`</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n n-Quoted">`write_only`</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`read_only`</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="n">serializer</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">shown</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">response</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`write_only`</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="n">serializer</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="w"> </span><span class="k">password</span><span class="o">/</span><span class="n">token</span><span class="w"> </span><span class="n">field</span>
<span class="o">-</span><span class="w"> </span><span class="n">choice</span><span class="w"> </span><span class="k">fields</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="w"> </span><span class="n">gender</span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="mi">1</span><span class="o">:</span><span class="s1">&#39;male&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;female&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="n">depart</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">name</span><span class="p">)</span>

<span class="w">      </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">      # model gender: ((1:&#39;male&#39;), (2, &#39;female&#39;))</span>
<span class="n n-Quoted">      class AccountSerializer(serializers.ModelSerializer):</span>
<span class="n n-Quoted">          gender_info = serializers.CharField(source=&#39;get_gender_display&#39;, read_only=True)</span>
<span class="n n-Quoted">          depart = serializers.CharField(source=&#39;depart.title&#39;) #show department title</span>
<span class="n n-Quoted">          class Meta:</span>
<span class="n n-Quoted">              model = Account</span>
<span class="n n-Quoted">              fields = [&#39;id&#39;, &#39;account_name&#39;, &#39;users&#39;, &#39;created&#39;, &#39;gender_info&#39;, &#39;depart&#39;]</span>
<span class="n n-Quoted">            extra_kwargs = {&#39;gender&#39;: {&#39;write_only&#39;: True}}</span>
<span class="n n-Quoted">      </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">follow</span><span class="w"> </span><span class="n">conventions</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">Django</span><span class="w"> </span><span class="n">ModelForm</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">name</span><span class="w"> </span><span class="n n-Quoted">`gender_info`</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="k">write</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">number</span><span class="w"> </span><span class="mi">1</span><span class="o">|</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="k">string</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">male</span><span class="o">|</span><span class="n">female</span>
<span class="o">-</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="n">own</span><span class="w"> </span><span class="n">field</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  class AccountSerializer(serializers.ModelSerializer):</span>
<span class="n n-Quoted">      class Meta:</span>
<span class="n n-Quoted">          model = Account</span>
<span class="n n-Quoted">          fields = [&#39;xxx&#39;]</span>
<span class="n n-Quoted">      def get_xxx(self, obj):</span>
<span class="n n-Quoted">          return obj.first_name + obj.last_name</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="k">nested</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">embed</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">Suppose</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="k">tables</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">m</span><span class="o">:</span><span class="n">n</span><span class="w"> </span><span class="n">relations</span>

<span class="w">      </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">      from django.db import models</span>
<span class="n n-Quoted">      class Role(models.Model):</span>
<span class="n n-Quoted">          title = models.CharField(verbose_name=&quot;标题&quot;, max_length=32)</span>
<span class="n n-Quoted">          order = models.IntegerField(verbose_name=&quot;顺序&quot;)</span>
<span class="n n-Quoted">      class Tag(models.Model):</span>
<span class="n n-Quoted">          caption = models.CharField(verbose_name=&quot;名称&quot;, max_length=32)</span>
<span class="n n-Quoted">      class UserInfo(models.Model):</span>
<span class="n n-Quoted">          name = models.CharField(verbose_name=&quot;姓名&quot;, max_length=32)</span>
<span class="n n-Quoted">          gender = models.SmallIntegerField(verbose_name=&quot;性别&quot;, choices=((1, &quot;男&quot;), (2, &quot;女&quot;)))</span>
<span class="n n-Quoted">          role = models.ForeignKey(verbose_name=&quot;角色&quot;, to=&quot;Role&quot;, on_delete=models.CASCADE)</span>
<span class="n n-Quoted">          ctime = models.DateTimeField(verbose_name=&quot;创建时间&quot;, auto_now_add=True)</span>

<span class="n n-Quoted">          tags = models.ManyToManyField(verbose_name=&quot;标签&quot;, to=&quot;Tag&quot;)</span>
<span class="n n-Quoted">      </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ModelSerializer</span>

<span class="w">      </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">      from rest_framework.views import APIView</span>
<span class="n n-Quoted">      from rest_framework.response import Response</span>
<span class="n n-Quoted">      from rest_framework import serializers</span>
<span class="n n-Quoted">      from api import models</span>

<span class="n n-Quoted">      class RoleSerializer(serializers.ModelSerializer):</span>
<span class="n n-Quoted">          class Meta:</span>
<span class="n n-Quoted">              model = models.Role</span>
<span class="n n-Quoted">              # fields = &quot;__all__&quot;</span>
<span class="n n-Quoted">              fields = [&quot;id&quot;, &#39;title&#39;]</span>

<span class="n n-Quoted">      class TagSerializer(serializers.ModelSerializer):</span>
<span class="n n-Quoted">          class Meta:</span>
<span class="n n-Quoted">              model = models.Tag</span>
<span class="n n-Quoted">              fields = &quot;__all__&quot;</span>

<span class="n n-Quoted">      class InfoSerializer(serializers.ModelSerializer):</span>
<span class="n n-Quoted">          role = RoleSerializer()</span>
<span class="n n-Quoted">          tags = TagSerializer(many=True)</span>

<span class="n n-Quoted">          class Meta:</span>
<span class="n n-Quoted">              model = models.UserInfo</span>
<span class="n n-Quoted">              fields = [&#39;id&#39;, &#39;name&#39;, &quot;role&quot;, &quot;tags&quot;]</span>

<span class="n n-Quoted">      class InfoView(APIView):</span>
<span class="n n-Quoted">          def get(self, request):</span>
<span class="n n-Quoted">              queryset = models.UserInfo.objects.all()</span>
<span class="n n-Quoted">              ser = InfoSerializer(instance=queryset, many=True)</span>
<span class="n n-Quoted">              print(type(ser.data), ser.data)</span>
<span class="n n-Quoted">              return Response(ser.data)</span>
<span class="n n-Quoted">      </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="n">Inheritances</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  from rest_framework.views import APIView</span>
<span class="n n-Quoted">  from rest_framework.response import Response</span>
<span class="n n-Quoted">  from rest_framework import serializers</span>
<span class="n n-Quoted">  from api import models</span>


<span class="n n-Quoted">  class MySerializer(serializers.Serializer):</span>
<span class="n n-Quoted">      more = serializers.SerializerMethodField()</span>

<span class="n n-Quoted">      def get_more(self, obj):</span>
<span class="n n-Quoted">          return &quot;123&quot;</span>

<span class="n n-Quoted">  # inherit MySerializer</span>
<span class="n n-Quoted">  class InfoSerializer(serializers.ModelSerializer, MySerializer):</span>
<span class="n n-Quoted">      class Meta:</span>
<span class="n n-Quoted">          model = models.UserInfo</span>
<span class="n n-Quoted">          fields = [&quot;id&quot;, &quot;name&quot;, &#39;more&#39;]</span>


<span class="n n-Quoted">  class InfoView(APIView):</span>
<span class="n n-Quoted">      def get(self, request):</span>
<span class="n n-Quoted">          instance = models.UserInfo.objects.all().first()</span>
<span class="n n-Quoted">          ser = InfoSerializer(instance=instance, many=False)</span>

<span class="n n-Quoted">          print(type(ser.data), ser.data)</span>
<span class="n n-Quoted">          return Response(ser.data)</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="n">Save</span><span class="o">/</span><span class="k">Update</span><span class="w"> </span><span class="k">data</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="o">-</span><span class="w"> </span><span class="n">save</span><span class="p">()</span><span class="o">/</span><span class="w"> </span><span class="k">update</span><span class="p">()</span><span class="w"> </span><span class="n">method</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  serializer = CommentModelSerializer(data=data)</span>
<span class="n n-Quoted">  serializer.save()</span>
<span class="n n-Quoted">  # for non model serializer</span>
<span class="n n-Quoted">  serializer = CommentNonModelSerializer(data=data)</span>
<span class="n n-Quoted">  serializer.validated_data.pop(&#39;confirm_password&#39;) # there are filed should not save into database</span>
<span class="n n-Quoted">  models.Comment.objects.create(**serializer .validate_data)</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="k">In</span><span class="w"> </span><span class="n">save</span><span class="p">(),</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="n">additional</span><span class="w"> </span><span class="k">fields</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">  serializer.save(updated = datetime.now(), updated_by = request.user )</span>
<span class="n n-Quoted">  </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
<span class="o">-</span><span class="w"> </span><span class="k">Foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">many</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">many</span>
<span class="w">  </span><span class="n">heading</span><span class="o">::</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="k">When</span><span class="w"> </span><span class="n">validate</span><span class="o">/</span><span class="n">save</span><span class="w"> </span><span class="n">foriegn</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="n">DRF</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">not</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">apply</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">M2N</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;tags&#39;</span><span class="o">:</span><span class="w"> </span><span class="err">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1111</span><span class="err">]}</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n n-Quoted">`1111`</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">existed</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">M2N</span><span class="w"> </span><span class="k">table</span><span class="p">,</span><span class="w"> </span><span class="k">validation</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">fail</span>
<span class="o">-</span><span class="w"> </span><span class="n">Override</span><span class="w"> </span><span class="n n-Quoted">`to_presentation`</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">friendly</span><span class="w"> </span><span class="n">way</span><span class="w"> </span><span class="p">(</span><span class="n">beyond</span><span class="w"> </span><span class="n n-Quoted">`display_xxx`</span><span class="p">)</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">override</span><span class="w">  </span><span class="n n-Quoted">`to_presentation`</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="err">[[</span><span class="p">..</span><span class="o">/</span><span class="n">assets</span><span class="o">/</span><span class="n">image_1696746627345_0</span><span class="p">.</span><span class="n">png</span><span class="err">]]</span>

<span class="w">      </span><span class="n n-Quoted">`</span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted"> python</span>
<span class="n n-Quoted">      class SbModelSerializer(NbHookSerializer, serializers.ModelSerializer):</span>
<span class="n n-Quoted">          class Meta:</span>
<span class="n n-Quoted">              model = models.NbUserInfo</span>
<span class="n n-Quoted">              fields = [&quot;id&quot;, &quot;name&quot;, &quot;age&quot;, &quot;gender&quot;]</span>
<span class="n n-Quoted">              extra_kwargs = {</span>
<span class="n n-Quoted">                  &quot;id&quot;: {&quot;read_only&quot;: True}</span>
<span class="n n-Quoted">              }</span>

<span class="n n-Quoted">          def nb_gender(self, obj): # YOu can define your own getter here</span>
<span class="n n-Quoted">              return obj.get_gender_display()</span>

<span class="n n-Quoted">          def nb_name(self, obj):</span>
<span class="n n-Quoted">              return obj.get_gender_display()</span>
<span class="n n-Quoted">      class SbView(APIView):</span>
<span class="n n-Quoted">          def post(self, request, *args, **kwargs):</span>
<span class="n n-Quoted">              ser = SbModelSerializer(data=request.data)  # the to_presentation was overrided</span>
<span class="n n-Quoted">              if ser.is_valid():</span>
<span class="n n-Quoted">                  ser.save()</span>
<span class="n n-Quoted">                  return Response(ser.data)</span>
<span class="n n-Quoted">              else:</span>
<span class="n n-Quoted">                  return Response(ser.errors)</span>
<span class="n n-Quoted">      </span><span class="n n-Quoted n-Quoted-Escape">``</span><span class="n n-Quoted">`</span>
</code></pre></div>

<ul>
<li>Under the hood<ul>
<li>[[../assets/image-20210823235752483_1696691331872_0.jpg]]</li>
<li>[[../assets/image-20210824001814091_1696723163568_0.jpg]]</li>
<li>[[../assets/image-20210824001844381_1696723308136_0.jpg]]</li>
</ul>
</li>
<li>Validator
  heading:: 2
  desc:: validation logic into reusable component, DRF validation is performed entirely on the serializer class.</li>
<li>Samples</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CustomerReportRecord</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">time_raised</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
<span class="c1"># if meta set to CustomerReportRecord, reference max_len will be 20</span>
<span class="k">class</span> <span class="nc">CustomerReportModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CustomerReportRecord</span>

<span class="c1">#This works as well</span>
<span class="k">class</span> <span class="nc">CustomerReportSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="c1"># email = serializers.EmailField() # implemented email validation</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">EmailValidator</span><span class="p">(</span><span class="s2">&quot;email format invalid&quot;</span><span class="p">)])</span>
    <span class="n">mobile</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">RegexValidator</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;number only&quot;</span><span class="p">)])</span>
</code></pre></div>
- Model serializer validations
    - You can set it up for more complicated validations schemas</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="err">```</span><span class="w"> </span><span class="n">python</span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="n">BillingRecordSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
<span class="w">      </span><span class="n">def</span><span class="w"> </span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p">):</span>
<span class="w">          </span><span class="c1"># Apply custom validation either here, or in the view.</span>

<span class="w">      </span><span class="k">class</span><span class="w"> </span><span class="n">Meta</span><span class="p">:</span>
<span class="w">          </span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;client&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
<span class="w">          </span><span class="n">validators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="n">UniqueForYearValidator</span><span class="p">(</span>
<span class="w">                  </span><span class="n">queryset</span><span class="o">=</span><span class="n">BlogPostItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
<span class="w">                  </span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;slug&#39;</span><span class="p">,</span>
<span class="w">                  </span><span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;published&#39;</span>
<span class="w">              </span><span class="p">)</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">          </span><span class="n">extra_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s1">&#39;client&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;required&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">},</span>
<span class="w">            </span><span class="s1">&#39;title&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;max_length&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">},</span>
<span class="w">            </span><span class="s1">&#39;phone&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;validators&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">RegexValidator</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;phone number&#39;</span><span class="p">)]},</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">          </span><span class="c1"># validators = []  # Remove a default &quot;unique together&quot; constraint.</span>
<span class="w">  </span><span class="err">```</span>
</code></pre></div>

<ul>
<li>
<p>Validator hook</p>
<ul>
<li>Put inside CustomerReportSerializer</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CustomerReportSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">validate_phone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="c1"># validate {&#39;phone&#39;: &#39;02233221123&#39;, ...}</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;incorrect phone number length&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span> <span class="c1"># this validate all fields</span>
      <span class="c1"># api_settings.NON_FIELD_ERRORS_KEY</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mobile&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;incorrect mobile for AU&#39;</span><span class="p">)</span>
</code></pre></div>
    - Validation error exception will be captured in DRF and convert to error response
    - Validate a request</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CustomerView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="n">ser</span> <span class="o">=</span> <span class="n">CustomerReportSerializer</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
      <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

      <span class="n">modelser</span> <span class="o">=</span> <span class="n">CustomerReportModelSerializer</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
      <span class="n">modelser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</li>
</ul>
        <a href="blog/2023/12/19/python-django-restful-framework/#more">
          <span class="twemoji">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13.22 19.03a.75.75 0 0 1 0-1.06L18.19 13H3.75a.75.75 0 0 1 0-1.5h14.44l-4.97-4.97a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/></svg>
          </span>
          Continue reading
          <hr>
        </a>
      
  
      <h2><a href="blog/">Whats new</a></h2>
      <p>
        <b>This is a blog about my thoughts and experiences in the world of software development.
</b>
      </p>
      <aside class="mdx-author">
  
  <p>
    <span>
      
        <strong>ray-x</strong>
         ·
      
      
    
    
      
      
        
        
      
      
      <a href="https://github.com/ray-x" target="_blank" rel="noopener" title="github.com" class="twemoji">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
      
    
      
      
        
        
      
      
         · 
      
      <a href="https://twitter.com/x_II_x" target="_blank" rel="noopener" title="twitter.com" class="twemoji">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9L389.2 48zm-24.8 373.8h39.1L151.1 88h-42l255.3 333.8z"/></svg>
      </a>
      
    
      
      
        
        
      
      
         · 
      
      <a href="https://linkedin.com/in/ray-x" target="_blank" rel="noopener" title="linkedin.com" class="twemoji">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
      </a>
      
    

    </span>
    <span>
      <span class="twemoji">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0ZM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25Zm-17.75-5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25Z"/></svg>
      </span>
      August 01, 2021 ·
      <span class="twemoji">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25Z"/><path d="M12 1c6.075 0 11 4.925 11 11s-4.925 11-11 11S1 18.075 1 12 5.925 1 12 1ZM2.5 12a9.5 9.5 0 0 0 9.5 9.5 9.5 9.5 0 0 0 9.5-9.5A9.5 9.5 0 0 0 12 2.5 9.5 9.5 0 0 0 2.5 12Z"/></svg>
      </span>
      <!--Min reading time is 1 minute-->
      
      
        
      
      1 min read
    </span>
  </p>
</aside>
      <hr>
      <!-- Use a hidden p tag to provide a preview -->
      
        <h2 id="main-page">Main page<a class="headerlink" href="#main-page" title="Permanent link">&para;</a></h2>
<p>Meet Ray and his dearest friends. They are all software engineers and love to share their thoughts and experiences in the world of software development.</p>
        <a href="blog/#more">
          <span class="twemoji">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13.22 19.03a.75.75 0 0 1 0-1.06L18.19 13H3.75a.75.75 0 0 1 0-1.5h14.44l-4.97-4.97a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/></svg>
          </span>
          Continue reading
          <hr>
        </a>
      
  

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2019 - 2024 RayX
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/ray-x" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/x_II_x" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9L389.2 48zm-24.8 373.8h39.1L151.1 88h-42l255.3 333.8z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in/ray-x" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": [], "search": "assets/javascripts/workers/search.b8dbb3d2.min.js", "tags": {"CSS": "css", "HTML": "html", "JavaScript": "js"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.c8d2eff1.min.js"></script>
      
        <script src="javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>